<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kairos - A Journey Within</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap');
        
        /* Organic Tones Base Palette */
        :root {
            /* Base Organic Tones */
            --warm-off-white: #FAF9F6;
            --soft-charcoal: #3A3A3A;
            --muted-stone-gray: #8B8680;
            --gentle-cream: #F7F5F2;
            --warm-ivory: #FDF8F0;
            
            /* Living Accents */
            --deep-indigo: #483D8B;
            --shimmering-gold: #D4AF37;
            --soft-rose-quartz: #B695C0;
            --ethereal-lavender: #C8B2DB;
            --sage-mist: #A8B5A0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--warm-off-white);
            color: var(--soft-charcoal);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Enhanced organic texture overlay */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            background-image: 
                radial-gradient(circle at 1px 1px, rgba(138, 134, 128, 0.03) 1px, transparent 0),
                radial-gradient(circle at 20px 20px, rgba(72, 61, 139, 0.01) 1px, transparent 0);
            background-size: 25px 25px, 40px 40px;
            opacity: 0.4;
        }

        /* Living background with organic tones */
        .cosmic-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: 
                radial-gradient(circle at 20% 30%, var(--deep-indigo)08 0%, transparent 60%),
                radial-gradient(circle at 80% 20%, var(--shimmering-gold)05 0%, transparent 70%),
                radial-gradient(circle at 40% 70%, var(--soft-rose-quartz)03 0%, transparent 80%),
                radial-gradient(circle at 90% 80%, var(--ethereal-lavender)04 0%, transparent 65%),
                linear-gradient(135deg, var(--gentle-cream) 0%, var(--warm-ivory) 50%, var(--gentle-cream) 100%);
            animation: breathingBackground 30s ease-in-out infinite;
        }

        @keyframes breathingBackground {
            0%, 100% { 
                transform: scale(1) rotate(0deg);
                opacity: 0.8;
            }
            33% { 
                transform: scale(1.01) rotate(0.3deg);
                opacity: 0.9;
            }
            66% { 
                transform: scale(0.99) rotate(-0.2deg);
                opacity: 0.85;
            }
        }

        /* Shimmering particles */
        .particles {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            background: radial-gradient(circle, rgba(212, 175, 55, 0.3) 0%, rgba(182, 149, 192, 0.1) 40%, transparent 70%);
            border-radius: 50%;
            animation: float 20s infinite linear;
        }

        @keyframes float {
            0% { transform: translateY(100vh) translateX(0px) scale(0); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100px) translateX(100px) scale(1); opacity: 0; }
        }

        /* Luminous glow effects */
        .luminous-glow {
            box-shadow: 
                0 0 20px rgba(72, 61, 139, 0.15),
                0 0 40px rgba(212, 175, 55, 0.1),
                0 0 60px rgba(182, 149, 192, 0.08);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(72, 61, 139, 0.1);
        }

        /* The Descent - Login transition effect */
        .descent-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, 
                rgba(245, 245, 243, 0.9) 0%, 
                rgba(72, 61, 139, 0.15) 30%,
                rgba(72, 61, 139, 0.25) 50%, 
                rgba(72, 61, 139, 0.15) 70%,
                rgba(245, 245, 243, 0.9) 100%);
            z-index: 1000;
            animation: descent 3.5s ease-in-out forwards;
            pointer-events: none;
            backdrop-filter: blur(20px);
        }

        @keyframes descent {
            0% { 
                opacity: 0; 
                transform: translateY(-100%); 
            }
            25% { 
                opacity: 1; 
                transform: translateY(0); 
            }
            75% { 
                opacity: 1; 
                transform: translateY(0); 
            }
            100% { 
                opacity: 0; 
                transform: translateY(100%); 
            }
        }

        /* App container smooth transitions */
        #app {
            transition: opacity 0.5s ease-in-out;
        }

        /* Hide content during transition */
        .transitioning {
            opacity: 0;
            pointer-events: none;
        }

        /* Mobile responsiveness improvements */
        @media (max-width: 768px) {
            /* Improve padding on mobile */
            .threshold-container {
                padding: 1rem !important;
            }
            
            .kairos-card {
                padding: 1.5rem !important;
                margin: 1rem !important;
            }
            
            /* Gateway choice icons */
            .gateway-option {
                margin: 0 1rem !important;
            }
            
            .gateway-icon {
                width: 100px !important;
                height: 100px !important;
            }
            
            /* Text journaling form */
            #text-journal-form input,
            #text-journal-form textarea {
                font-size: 16px !important; /* Prevents zoom on iOS */
            }
            
            /* Body map sizing */
            .body-map svg {
                max-width: 150px !important;
            }
            
            /* Button improvements */
            button {
                min-height: 44px; /* Touch target size */
                font-size: 16px !important; /* Prevents zoom on iOS */
            }
            
            /* Improve spacing for mobile header */
            .mobile-header {
                padding: 0.5rem 1rem !important;
            }
            
            .mobile-header h1 {
                font-size: 1.5rem !important;
                line-height: 1.3 !important;
                margin-bottom: 0.5rem !important;
            }
            
            .mobile-header p {
                font-size: 0.9rem !important;
            }
        }

        @media (max-width: 480px) {
            /* Extra small mobile adjustments */
            .gateway-choice-container {
                flex-direction: column !important;
                gap: 2rem !important;
            }
            
            .kairos-card {
                padding: 1rem !important;
            }
            
            /* Ensure buttons don't overlap */
            .floating-logout {
                padding: 0.5rem 0.75rem !important;
                min-width: 70px !important;
            }
        }

        /* Typography hierarchy */
        .heading-serif {
            font-family: 'Playfair Display', serif;
            font-weight: 600;
        }

        .body-sans {
            font-family: 'Inter', sans-serif;
        }

        /* The Weaver special styling */
        .weaver-voice {
            font-family: 'Crimson Text', serif;
            font-style: italic;
            font-weight: 600;
            font-size: 1.25em;
            letter-spacing: 0.5px;
            background: linear-gradient(135deg, var(--shimmering-gold) 0%, #DAA520 50%, #B8860B 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 12px rgba(212, 175, 55, 0.4);
            filter: drop-shadow(0 2px 6px rgba(212, 175, 55, 0.3));
        }

        /* Weaver text animation - smoother with gentle entrance */
        .weaver-text {
            opacity: 0;
            transform: translateY(20px);
            animation: weaverReveal 2s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        
        /* Staggered heading animations */
        .heading-entrance {
            opacity: 0;
            transform: translateY(30px) scale(0.98);
            animation: headingEntrance 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        
        @keyframes headingEntrance {
            0% { 
                opacity: 0; 
                transform: translateY(30px) scale(0.98);
                filter: blur(3px);
            }
            60% {
                opacity: 0.8;
                transform: translateY(10px) scale(0.99);
                filter: blur(1px);
            }
            100% { 
                opacity: 1; 
                transform: translateY(0) scale(1);
                filter: blur(0px);
            }
        }

        @keyframes weaverReveal {
            0% { 
                opacity: 0; 
                transform: translateY(20px) scale(0.98); 
                filter: blur(3px);
            }
            60% {
                opacity: 0.8;
                transform: translateY(8px) scale(0.99);
                filter: blur(1px);
            }
            100% { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
                filter: blur(0px);
            }
        }

        /* Typing effect for AI text - smooth animation */
        .typing-text {
            overflow: hidden;
            border-right: 2px solid rgba(72, 61, 139, 0.7);
            animation: typing 3s ease-out, blink-caret 0.75s step-end infinite 3s, hide-caret 0.1s ease-out 5s forwards;
            white-space: normal;
            word-wrap: break-word;
            max-width: 100%;
            display: block;
            line-height: 1.6;
        }

        @keyframes typing {
            from { 
                width: 0; 
                opacity: 0.8;
            }
            to { 
                width: 100%; 
                opacity: 1;
            }
        }

        @keyframes blink-caret {
            from, to { border-color: transparent; }
            50% { border-color: rgba(72, 61, 139, 0.7); }
        }

        @keyframes hide-caret {
            from { border-color: rgba(72, 61, 139, 0.7); }
            to { border-color: transparent; }
        }

        /* Onboarding steps container - Generous breathing space */
        .onboarding-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4rem 2rem;
        }
        
        /* Enhanced spacing for questionnaire sections */
        .archetype-discovery-section {
            padding: 6rem 2rem;
        }
        
        .archetype-discovery-section .kairos-card {
            padding: 4rem 3rem;
            max-width: 5xl;
        }
        
        /* Generous spacing between elements */
        .space-y-generous > * + * {
            margin-top: 3rem;
        }
        
        .space-y-xl > * + * {
            margin-top: 2rem;
        }

        /* Sacred Energy Bubbles */
        .energy-bubble {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(72, 61, 139, 0.2);
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 8px 25px rgba(72, 61, 139, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        .energy-bubble::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 30% 30%, 
                rgba(212, 175, 55, 0.1) 0%, 
                transparent 60%);
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .energy-bubble i {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
            filter: drop-shadow(0 2px 6px rgba(0, 0, 0, 0.2));
            transition: all 0.4s ease;
        }

        .energy-bubble p {
            color: rgba(255, 255, 255, 0.9) !important;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 0.9rem;
            text-shadow: 0 1px 3px rgba(72, 61, 139, 0.3);
            margin: 0;
            transition: all 0.4s ease;
        }

        .energy-bubble:hover {
            transform: scale(1.08) translateY(-5px);
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(72, 61, 139, 0.4);
            box-shadow: 
                0 15px 35px rgba(72, 61, 139, 0.2),
                0 0 30px rgba(212, 175, 55, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        .energy-bubble:hover::before {
            opacity: 1;
        }

        .energy-bubble:hover i {
            transform: scale(1.1);
            filter: drop-shadow(0 3px 8px rgba(0, 0, 0, 0.3));
        }

        .energy-bubble:hover p {
            color: rgba(255, 255, 255, 1) !important;
            text-shadow: 0 2px 6px rgba(72, 61, 139, 0.4);
        }

        .energy-bubble.selected {
            background: linear-gradient(135deg, 
                rgba(212, 175, 55, 0.2) 0%, 
                rgba(182, 149, 192, 0.15) 100%);
            border-color: var(--shimmering-gold);
            transform: scale(1.1) translateY(-8px);
            box-shadow: 
                0 20px 40px rgba(212, 175, 55, 0.3),
                0 0 40px rgba(212, 175, 55, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }
        
        .energy-bubble.selected::before {
            opacity: 1;
            background: radial-gradient(circle at 30% 30%, 
                rgba(212, 175, 55, 0.3) 0%, 
                rgba(182, 149, 192, 0.1) 60%,
                transparent 80%);
        }

        .energy-bubble.selected i {
            transform: scale(1.15);
            filter: drop-shadow(0 4px 12px rgba(212, 175, 55, 0.4));
        }

        .energy-bubble.selected p {
            color: var(--warm-off-white) !important;
            font-weight: 700;
            text-shadow: 0 2px 8px rgba(212, 175, 55, 0.5);
        }
        
        /* Sacred Continue Button States */
        #continue-energy:not([disabled]) {
            opacity: 1 !important;
            pointer-events: auto !important;
            box-shadow: 
                0 12px 30px rgba(72, 61, 139, 0.3),
                0 0 25px rgba(212, 175, 55, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2) !important;
        }
        
        #continue-energy:not([disabled]):hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 
                0 18px 40px rgba(72, 61, 139, 0.4),
                0 0 35px rgba(212, 175, 55, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        /* Archetype selection styles - Floating panels with glassmorphism */
        .archetype-option {
            border: 2px solid rgba(72, 61, 139, 0.15);
            position: relative;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(20px);
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            cursor: pointer;
            padding: 1.5rem;
            margin: 0.5rem;
            box-shadow: 
                0 8px 32px rgba(72, 61, 139, 0.08),
                0 0 20px rgba(212, 175, 55, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
        }

        .archetype-option:hover {
            transform: translateY(-8px) scale(1.03);
            border-color: rgba(72, 61, 139, 0.3);
            background: rgba(255, 255, 255, 0.8);
            box-shadow: 
                0 16px 40px rgba(72, 61, 139, 0.12),
                0 0 30px rgba(212, 175, 55, 0.1),
                0 0 50px rgba(182, 149, 192, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
        }

        .archetype-option.selected {
            border-color: rgba(212, 175, 55, 0.6);
            background: rgba(212, 175, 55, 0.1);
            transform: translateY(-10px) scale(1.05);
            box-shadow: 
                0 20px 50px rgba(212, 175, 55, 0.2),
                0 0 40px rgba(212, 175, 55, 0.3),
                0 0 60px rgba(182, 149, 192, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.7);
        }

        .archetype-option i {
            text-shadow: 0 2px 8px rgba(72, 61, 139, 0.15);
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
            color: #483D8B;
        }

        .archetype-option p {
            margin: 0;
            line-height: 1.5;
            font-weight: 600;
            color: #333333;
            font-size: 1rem;
            letter-spacing: 0.3px;
        }

        /* Enneagram Card Experience Styles */
        .enneagram-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.12),
                0 0 40px rgba(72, 61, 139, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            position: relative;
            overflow: hidden;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Base resonance art for all choices with organic tones */
        .resonance-art {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 50% 50%, 
                rgba(72, 61, 139, 0.06) 0%, 
                rgba(212, 175, 55, 0.03) 40%, 
                rgba(182, 149, 192, 0.02) 70%, 
                transparent 100%);
            transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 1;
            pointer-events: none;
            border-radius: 20px;
            opacity: 0.7;
        }

        /* Type 1 - The Perfectionist: Structured diamond with sage tones */
        .resonance-art.type-1 {
            background: radial-gradient(circle at 50% 50%, 
                rgba(168, 181, 160, 0.15) 0%, 
                rgba(138, 150, 128, 0.08) 40%, 
                rgba(72, 61, 139, 0.03) 80%, 
                transparent 100%);
            clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
            animation: structuredPulse 4s ease-in-out infinite;
        }
        
        @keyframes structuredPulse {
            0%, 100% { transform: scale(1) rotate(0deg); opacity: 0.7; }
            50% { transform: scale(1.05) rotate(2deg); opacity: 0.9; }
        }

        /* Type 4 - The Individualist: Organic flowing with rose quartz tones */
        .resonance-art.type-4 {
            background: radial-gradient(ellipse at 30% 70%, 
                rgba(182, 149, 192, 0.2) 0%, 
                rgba(200, 178, 219, 0.12) 40%, 
                rgba(72, 61, 139, 0.06) 70%, 
                transparent 100%);
            border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
            animation: flowingMood 6s ease-in-out infinite;
        }
        
        @keyframes flowingMood {
            0%, 100% { border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%; opacity: 0.6; }
            33% { border-radius: 70% 30% 30% 70% / 70% 70% 30% 30%; opacity: 0.8; }
            66% { border-radius: 50% 50% 80% 20% / 60% 40% 60% 40%; opacity: 0.7; }
        }

        /* Type 7 - The Enthusiast: Sparkling burst with golden tones */
        .resonance-art.type-7 {
            background: radial-gradient(circle at 50% 50%, 
                rgba(212, 175, 55, 0.18) 0%, 
                rgba(218, 165, 32, 0.12) 30%, 
                rgba(184, 134, 11, 0.06) 60%, 
                transparent 100%);
            animation: sparklingBurst 3.5s ease-in-out infinite;
        }
        
        @keyframes sparklingBurst {
            0%, 100% { transform: scale(1); opacity: 0.7; }
            25% { transform: scale(1.1); opacity: 0.9; }
            50% { transform: scale(0.95); opacity: 0.8; }
            75% { transform: scale(1.05); opacity: 0.85; }
        }
        
        /* Type 2 - The Helper: Warm embrace with rose quartz */
        .resonance-art.type-2 {
            background: radial-gradient(ellipse at 40% 40%, 
                rgba(182, 149, 192, 0.16) 0%, 
                rgba(212, 175, 55, 0.08) 35%, 
                rgba(72, 61, 139, 0.04) 70%, 
                transparent 100%);
            border-radius: 50%;
            animation: warmEmbrace 5s ease-in-out infinite;
        }
        
        @keyframes warmEmbrace {
            0%, 100% { transform: scale(1); opacity: 0.7; border-radius: 50%; }
            50% { transform: scale(1.08); opacity: 0.9; border-radius: 60% 40% 50% 50%; }
        }
        
        /* Type 3 - The Achiever: Dynamic arrow with golden accents */
        .resonance-art.type-3 {
            background: linear-gradient(45deg, 
                rgba(212, 175, 55, 0.14) 0%, 
                rgba(72, 61, 139, 0.08) 50%, 
                rgba(182, 149, 192, 0.04) 100%);
            clip-path: polygon(0% 50%, 25% 0%, 100% 50%, 25% 100%);
            animation: dynamicForward 3s ease-in-out infinite;
        }
        
        @keyframes dynamicForward {
            0%, 100% { transform: translateX(0) scale(1); opacity: 0.7; }
            50% { transform: translateX(5px) scale(1.05); opacity: 0.9; }
        }
        
        /* Type 5 - The Investigator: Contemplative lens with deep indigo */
        .resonance-art.type-5 {
            background: radial-gradient(circle at 60% 40%, 
                rgba(72, 61, 139, 0.12) 0%, 
                rgba(138, 134, 128, 0.06) 40%, 
                rgba(182, 149, 192, 0.03) 80%, 
                transparent 100%);
            border-radius: 50%;
            animation: contemplativeLens 7s ease-in-out infinite;
        }
        
        @keyframes contemplativeLens {
            0%, 100% { transform: scale(1) rotate(0deg); opacity: 0.6; }
            25% { transform: scale(0.95) rotate(5deg); opacity: 0.8; }
            50% { transform: scale(1.02) rotate(0deg); opacity: 0.9; }
            75% { transform: scale(0.98) rotate(-3deg); opacity: 0.7; }
        }
        
        /* Type 6 - The Loyalist: Protective hexagon with sage and indigo */
        .resonance-art.type-6 {
            background: linear-gradient(120deg, 
                rgba(168, 181, 160, 0.12) 0%, 
                rgba(72, 61, 139, 0.08) 50%, 
                rgba(138, 134, 128, 0.04) 100%);
            clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);
            animation: protectiveShield 4.5s ease-in-out infinite;
        }
        
        @keyframes protectiveShield {
            0%, 100% { transform: scale(1) rotate(0deg); opacity: 0.7; }
            33% { transform: scale(1.03) rotate(2deg); opacity: 0.8; }
            66% { transform: scale(0.98) rotate(-1deg); opacity: 0.9; }
        }
        
        /* Type 8 - The Challenger: Bold octagon with powerful indigo */
        .resonance-art.type-8 {
            background: radial-gradient(circle at 50% 50%, 
                rgba(72, 61, 139, 0.18) 0%, 
                rgba(138, 134, 128, 0.10) 40%, 
                rgba(212, 175, 55, 0.04) 80%, 
                transparent 100%);
            clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%);
            animation: powerfulPresence 3.8s ease-in-out infinite;
        }
        
        @keyframes powerfulPresence {
            0%, 100% { transform: scale(1) rotate(0deg); opacity: 0.8; }
            50% { transform: scale(1.06) rotate(1deg); opacity: 1; }
        }
        
        /* Type 9 - The Peacemaker: Gentle wave with all living accents */
        .resonance-art.type-9 {
            background: radial-gradient(ellipse at 50% 70%, 
                rgba(182, 149, 192, 0.10) 0%, 
                rgba(168, 181, 160, 0.08) 30%, 
                rgba(212, 175, 55, 0.04) 60%, 
                rgba(72, 61, 139, 0.02) 90%, 
                transparent 100%);
            border-radius: 20% 80% 60% 40% / 70% 50% 50% 30%;
            animation: gentleWave 8s ease-in-out infinite;
        }
        
        @keyframes gentleWave {
            0%, 100% { 
                border-radius: 20% 80% 60% 40% / 70% 50% 50% 30%; 
                opacity: 0.6; 
                transform: scale(1);
            }
            25% { 
                border-radius: 60% 40% 80% 20% / 50% 70% 30% 50%; 
                opacity: 0.8; 
                transform: scale(1.02);
            }
            50% { 
                border-radius: 80% 20% 40% 60% / 30% 50% 70% 50%; 
                opacity: 0.9; 
                transform: scale(0.98);
            }
            75% { 
                border-radius: 40% 60% 20% 80% / 50% 30% 50% 70%; 
                opacity: 0.7; 
                transform: scale(1.01);
            }
        }
        
        /* Enhanced Question Styling with Living Accents */
        .question-container {
            position: relative;
            margin: 3rem 0;
        }
        
        .question-backdrop {
            position: absolute;
            top: -1rem;
            left: -2rem;
            right: -2rem;
            bottom: -1rem;
            background: linear-gradient(135deg, 
                rgba(72, 61, 139, 0.04) 0%, 
                rgba(212, 175, 55, 0.02) 30%,
                rgba(182, 149, 192, 0.03) 60%,
                rgba(168, 181, 160, 0.02) 100%);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(72, 61, 139, 0.08);
            animation: questionGlow 8s ease-in-out infinite;
            z-index: 1;
        }
        
        @keyframes questionGlow {
            0%, 100% { 
                box-shadow: 
                    0 0 20px rgba(72, 61, 139, 0.1),
                    0 0 40px rgba(212, 175, 55, 0.05);
                opacity: 0.8;
            }
            50% { 
                box-shadow: 
                    0 0 30px rgba(72, 61, 139, 0.15),
                    0 0 50px rgba(212, 175, 55, 0.08),
                    0 0 70px rgba(182, 149, 192, 0.05);
                opacity: 1;
            }
        }
        
        /* Living Sanctuary Animations */
        @keyframes presenceBreathing {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 
                    0 0 30px rgba(72, 61, 139, 0.4),
                    0 0 60px rgba(72, 61, 139, 0.2),
                    inset 0 0 20px rgba(255, 255, 255, 0.1);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 
                    0 0 40px rgba(72, 61, 139, 0.6),
                    0 0 80px rgba(72, 61, 139, 0.3),
                    inset 0 0 25px rgba(255, 255, 255, 0.15);
            }
        }
        
        @keyframes innerPulse {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }
        
        @keyframes gentlePulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }
        
        @keyframes gardenGrow {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.05) rotate(2deg); }
            50% { transform: scale(1.1) rotate(0deg); }
            75% { transform: scale(1.05) rotate(-2deg); }
        }
        
        @keyframes somaticPulse {
            0%, 100% { 
                transform: scale(1);
                filter: brightness(1);
            }
            50% { 
                transform: scale(1.1);
                filter: brightness(1.2);
            }
        }
        
        /* Presence orb interaction states */
        .presence-summary.show {
            opacity: 1 !important;
            transform: translateY(0) !important;
        }
        
        .gem-shimmer {
            animation: gemShimmer 2s ease-out;
        }
        
        @keyframes gemShimmer {
            0% { filter: brightness(1); }
            50% { 
                filter: brightness(1.3) drop-shadow(0 0 20px var(--shimmering-gold));
                transform: scale(1.1);
            }
            100% { filter: brightness(1); }
        }
        
        /* The Descent - Sacred Threshold Background */
        .descent-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            background: 
                radial-gradient(circle at 20% 30%, rgba(72, 61, 139, 0.4) 0%, transparent 60%),
                radial-gradient(circle at 80% 20%, rgba(212, 175, 55, 0.2) 0%, transparent 70%),
                radial-gradient(circle at 40% 70%, rgba(182, 149, 192, 0.3) 0%, transparent 80%),
                radial-gradient(circle at 90% 80%, rgba(72, 61, 139, 0.5) 0%, transparent 65%),
                linear-gradient(135deg, 
                    rgba(10, 11, 30, 0.95) 0%, 
                    rgba(26, 27, 58, 0.98) 30%,
                    rgba(45, 27, 105, 1) 50%, 
                    rgba(26, 27, 58, 0.98) 70%,
                    rgba(10, 11, 30, 0.95) 100%);
            animation: descentFlow 30s ease-in-out infinite;
        }
        
        @keyframes descentFlow {
            0%, 100% { 
                transform: scale(1) rotate(0deg);
                filter: brightness(0.9);
            }
            33% { 
                transform: scale(1.02) rotate(0.5deg);
                filter: brightness(1.1);
            }
            66% { 
                transform: scale(0.98) rotate(-0.5deg);
                filter: brightness(0.95);
            }
        }
        
        /* Enhanced descent particles */
        .descent-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            pointer-events: none;
        }
        
        .descent-particle {
            position: absolute;
            border-radius: 50%;
            animation: descentFall 20s infinite linear;
            opacity: 0.6;
        }
        
        @keyframes descentFall {
            0% { 
                transform: translateY(-100px) translateX(0px) scale(0.3);
                opacity: 0;
            }
            10% { opacity: 0.8; }
            90% { opacity: 0.4; }
            100% { 
                transform: translateY(calc(100vh + 100px)) translateX(50px) scale(1);
                opacity: 0;
            }
        }
        
        /* Sacred Login Animations */
        @keyframes logoBreathing {
            0%, 100% { 
                text-shadow: 0 0 40px rgba(72, 61, 139, 0.6);
                filter: drop-shadow(0 2px 8px rgba(212, 175, 55, 0.3));
            }
            50% { 
                text-shadow: 0 0 60px rgba(72, 61, 139, 0.8);
                filter: drop-shadow(0 3px 12px rgba(212, 175, 55, 0.5));
            }
        }
        
        @keyframes logoEntrance {
            0% { 
                opacity: 0;
                transform: translateY(30px) scale(0.9);
                filter: blur(5px);
            }
            100% { 
                opacity: 1;
                transform: translateY(0) scale(1);
                filter: blur(0px);
            }
        }
        
        @keyframes formEntrance {
            0% { 
                opacity: 0;
                transform: translateY(40px) scale(0.95);
                filter: blur(3px);
            }
            100% { 
                opacity: 1;
                transform: translateY(0) scale(1);
                filter: blur(0px);
            }
        }
        
        @keyframes linkEntrance {
            0% { 
                opacity: 0;
                transform: translateY(20px);
            }
            100% { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Sacred Loading Animation - Enhanced Purple Theme */
        .sacred-loader {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(72, 61, 139, 0.2);
            border-top: 2px solid var(--shimmering-gold);
            border-right: 2px solid var(--soft-rose-quartz);
            border-radius: 50%;
            animation: sacredSpin 1.5s ease-in-out infinite;
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
        }

        /* Full Screen Loading Overlay */
        .kairos-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, 
                var(--deep-indigo) 0%, 
                var(--ethereal-lavender) 50%, 
                var(--soft-rose-quartz) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            animation: fadeIn 0.5s ease-out forwards;
        }

        .kairos-loading-content {
            text-align: center;
            max-width: 400px;
            padding: 2rem;
        }

        .kairos-loading-spinner {
            width: 80px;
            height: 80px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid var(--shimmering-gold);
            border-right: 4px solid var(--soft-rose-quartz);
            border-radius: 50%;
            animation: sacredSpin 2s ease-in-out infinite;
            margin: 0 auto 2rem;
            box-shadow: 
                0 0 30px rgba(212, 175, 55, 0.3),
                0 0 60px rgba(182, 149, 192, 0.2);
        }

        .kairos-loading-text {
            font-family: 'Playfair Display', serif;
            color: var(--warm-off-white);
            font-size: 1.5rem;
            font-weight: 400;
            letter-spacing: 1px;
            text-shadow: 0 2px 8px rgba(72, 61, 139, 0.3);
            animation: breathingText 3s ease-in-out infinite;
        }

        @keyframes breathingText {
            0%, 100% { 
                opacity: 0.8; 
                transform: scale(1);
            }
            50% { 
                opacity: 1; 
                transform: scale(1.02);
            }
        }
        
        @keyframes sacredSpin {
            0% { 
                transform: rotate(0deg) scale(1);
                border-top-color: var(--shimmering-gold);
                border-right-color: var(--soft-rose-quartz);
                box-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
            }
            33% { 
                transform: rotate(120deg) scale(1.1);
                border-top-color: var(--soft-rose-quartz);
                border-right-color: var(--deep-indigo);
                box-shadow: 0 0 15px rgba(182, 149, 192, 0.4);
            }
            66% { 
                transform: rotate(240deg) scale(1.05);
                border-top-color: var(--deep-indigo);
                border-right-color: var(--shimmering-gold);
                box-shadow: 0 0 12px rgba(72, 61, 139, 0.4);
            }
            100% { 
                transform: rotate(360deg) scale(1);
                border-top-color: var(--shimmering-gold);
                border-right-color: var(--soft-rose-quartz);
                box-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
            }
        }
        
        /* Input placeholder styling for the threshold */
        .threshold-form input::placeholder {
            color: rgba(255, 255, 255, 0.6);
            font-style: italic;
        }

        @keyframes gentle-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes crystalline-form {
            0% { clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%); }
            100% { clip-path: polygon(30% 0%, 100% 30%, 70% 100%, 0% 70%); }
        }

        @keyframes fluid-morph {
            0% { border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%; }
            50% { border-radius: 70% 30% 30% 70% / 70% 70% 30% 30%; }
            100% { border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%; }
        }

        @keyframes particle-burst {
            0% { 
                transform: scale(1); 
                opacity: 0.3; 
            }
            50% { 
                transform: scale(1.2); 
                opacity: 0.6; 
            }
            100% { 
                transform: scale(1); 
                opacity: 0.3; 
            }
        }

        .resonance-option {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.9) 0%, 
                rgba(248, 250, 252, 0.8) 100%);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(72, 61, 139, 0.2);
            border-radius: 20px;
            padding: 2rem;
            margin: 0.5rem;
            cursor: pointer;
            transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            z-index: 10;
            min-height: 120px;
            display: flex;
            align-items: center;
            text-align: center;
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.08),
                0 0 20px rgba(72, 61, 139, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
            overflow: hidden;
        }

        .resonance-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(72, 61, 139, 0.1), 
                transparent);
            transition: left 0.5s ease;
        }

        .resonance-option:hover::before {
            left: 100%;
        }

        .resonance-option:hover {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.95) 0%, 
                rgba(251, 250, 255, 0.9) 100%);
            border-color: rgba(72, 61, 139, 0.6);
            transform: translateY(-5px) scale(1.02);
            box-shadow: 
                0 12px 35px rgba(72, 61, 139, 0.15),
                0 0 25px rgba(212, 175, 55, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
        }

        .resonance-option.selected {
            background: linear-gradient(135deg, 
                rgba(255, 215, 0, 0.2) 0%, 
                rgba(255, 185, 15, 0.15) 50%,
                rgba(218, 165, 32, 0.1) 100%);
            border: 2px solid rgba(218, 165, 32, 0.8);
            transform: translateY(-8px) scale(1.05);
            box-shadow: 
                0 20px 50px rgba(218, 165, 32, 0.25),
                0 0 40px rgba(255, 215, 0, 0.3),
                inset 0 2px 0 rgba(255, 255, 255, 0.8),
                0 0 60px rgba(255, 215, 0, 0.15);
            animation: golden-pulse 2s ease-in-out infinite;
        }

        @keyframes golden-pulse {
            0%, 100% { 
                box-shadow: 
                    0 20px 50px rgba(218, 165, 32, 0.25),
                    0 0 40px rgba(255, 215, 0, 0.3),
                    inset 0 2px 0 rgba(255, 255, 255, 0.8),
                    0 0 60px rgba(255, 215, 0, 0.15); 
            }
            50% { 
                box-shadow: 
                    0 20px 50px rgba(218, 165, 32, 0.35),
                    0 0 50px rgba(255, 215, 0, 0.4),
                    inset 0 2px 0 rgba(255, 255, 255, 0.9),
                    0 0 80px rgba(255, 215, 0, 0.25); 
            }
        }

        .resonance-option.selected p {
            color: #8B4513 !important;
            font-weight: 700;
            text-shadow: 
                0 1px 2px rgba(255, 215, 0, 0.3),
                0 0 6px rgba(218, 165, 32, 0.2);
        }

        /* Living Mirror Presence Orb */
        .presence-orb {
            width: 280px;
            height: 280px;
            border-radius: 50%;
            position: relative;
            margin: 0 auto;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            animation: nervousSystemBreathing 10s ease-in-out infinite;
        }

        .presence-orb-core {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            background: 
                radial-gradient(circle at 30% 20%, rgba(72, 61, 139, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 70% 80%, rgba(72, 61, 139, 0.4) 0%, transparent 60%),
                radial-gradient(circle at 50% 50%, rgba(45, 27, 105, 0.8) 0%, rgba(26, 27, 58, 1) 100%);
            box-shadow: 
                0 0 80px rgba(72, 61, 139, 0.4),
                0 0 140px rgba(72, 61, 139, 0.2),
                inset 0 0 60px rgba(72, 61, 139, 0.3);
        }

        .orb-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            pointer-events: none;
        }

        .orb-swirl-layer {
            background: conic-gradient(from 0deg, 
                transparent 0deg, 
                rgba(72, 61, 139, 0.2) 90deg, 
                transparent 180deg, 
                rgba(72, 61, 139, 0.15) 270deg, 
                transparent 360deg);
            animation: orbSwirl 20s linear infinite;
        }

        .orb-depth-layer {
            background: radial-gradient(circle at 40% 40%, 
                rgba(255, 255, 255, 0.1) 0%, 
                rgba(72, 61, 139, 0.1) 30%, 
                transparent 70%);
            animation: orbDepthPulse 8s ease-in-out infinite;
        }

        .presence-orb-particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            overflow: hidden;
            pointer-events: none;
        }

        .presence-orb:hover .presence-orb-core {
            box-shadow: 
                0 0 80px rgba(72, 61, 139, 0.7),
                0 0 150px rgba(72, 61, 139, 0.3),
                inset 0 0 50px rgba(182, 149, 192, 0.2),
                inset 0 0 100px rgba(212, 175, 55, 0.08);
        }

        .presence-orb-particle {
            position: absolute;
            border-radius: 50%;
            background: var(--shimmering-gold);
            opacity: 0.4;
            animation: orbParticleFloat 12s linear infinite;
            filter: blur(0.5px);
        }

        .presence-orb-particle.rose {
            background: var(--soft-rose-quartz);
            animation-duration: 15s;
        }

        /* Emotional Thread Weaving System */
        .emotional-thread {
            position: absolute;
            width: 2px;
            height: 60px;
            border-radius: 1px;
            opacity: 0;
            pointer-events: none;
            background: linear-gradient(to bottom, transparent, var(--shimmering-gold), transparent);
            animation: threadWeave 8s ease-out forwards;
        }

        .emotional-thread.gold {
            background: linear-gradient(to bottom, transparent, var(--shimmering-gold), transparent);
            box-shadow: 0 0 6px var(--shimmering-gold);
        }

        .emotional-thread.rose {
            background: linear-gradient(to bottom, transparent, var(--soft-rose-quartz), transparent);
            box-shadow: 0 0 6px var(--soft-rose-quartz);
        }

        .emotional-thread.silver {
            background: linear-gradient(to bottom, transparent, rgba(200, 200, 220, 0.8), transparent);
            box-shadow: 0 0 6px rgba(200, 200, 220, 0.4);
        }

        .emotional-thread.indigo {
            background: linear-gradient(to bottom, transparent, var(--deep-indigo), transparent);
            box-shadow: 0 0 8px var(--deep-indigo);
            animation-duration: 6s;
        }

        @keyframes threadWeave {
            0% {
                left: -100px;
                opacity: 0;
                transform: rotate(-10deg);
            }
            15% {
                opacity: 1;
            }
            50% {
                left: 50%;
                transform: translateX(-50%) rotate(5deg);
                opacity: 0.8;
            }
            80% {
                left: 50%;
                transform: translateX(-50%) rotate(0deg) scale(0.3);
                opacity: 0.6;
            }
            100% {
                left: 50%;
                transform: translateX(-50%) rotate(0deg) scale(0.1);
                opacity: 0;
            }
        }

        .presence-orb.gem-shimmer {
            animation: presence-breathe 4s ease-in-out infinite, gem-shimmer 2s ease-in-out;
        }

        /* Nervous System Regulation Breathing: 4s inhale, 6s exhale */
        @keyframes nervousSystemBreathing {
            0% { 
                transform: scale(1);
                filter: brightness(1);
            }
            40% { /* 4 seconds inhale */
                transform: scale(1.08);
                filter: brightness(1.1);
            }
            100% { /* 6 seconds exhale */
                transform: scale(1);
                filter: brightness(1);
            }
        }

        @keyframes orbSwirl {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes orbDepthPulse {
            0%, 100% { 
                opacity: 0.6;
                transform: scale(1);
            }
            50% { 
                opacity: 0.9;
                transform: scale(1.05);
            }
        }

        @keyframes orbParticleFloat {
            0% { 
                transform: translateY(100%) rotate(0deg);
                opacity: 0;
            }
            10% { 
                opacity: 0.6;
            }
            90% { 
                opacity: 0.6;
            }
            100% { 
                transform: translateY(-100%) rotate(360deg);
                opacity: 0;
            }
        }

        @keyframes gem-shimmer {
            0% { filter: brightness(1); }
            30% { filter: brightness(1.4) hue-rotate(30deg); }
            60% { filter: brightness(1.6) hue-rotate(45deg); }
            100% { filter: brightness(1); }
        }

        .presence-orb-inner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 80%;
            border-radius: 50%;
            background: radial-gradient(circle, 
                rgba(255, 255, 255, 0.1) 0%, 
                transparent 70%);
            animation: inner-pulse 6s ease-in-out infinite;
        }

        @keyframes inner-pulse {
            0%, 100% { opacity: 0.3; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 0.7; transform: translate(-50%, -50%) scale(1.1); }
        }

        .presence-summary {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.9) 0%, 
                rgba(248, 250, 252, 0.8) 100%);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(72, 61, 139, 0.2);
            border-radius: 20px;
            padding: 1.5rem;
            margin-top: 2rem;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease;
        }

        .presence-summary.show {
            opacity: 1;
            transform: translateY(0);
        }

        .journaling-prompt-card {
            background: linear-gradient(135deg, 
                rgba(72, 61, 139, 0.15) 0%, 
                rgba(182, 149, 192, 0.1) 50%,
                rgba(212, 175, 55, 0.08) 100%);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 20px;
            padding: 2rem;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 
                0 8px 32px rgba(72, 61, 139, 0.12),
                0 0 40px rgba(212, 175, 55, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .journaling-prompt-card:hover {
            transform: translateY(-8px) scale(1.02);
            border-color: rgba(212, 175, 55, 0.6);
            box-shadow: 
                0 20px 60px rgba(72, 61, 139, 0.2),
                0 0 60px rgba(212, 175, 55, 0.15),
                0 0 80px rgba(182, 149, 192, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .journaling-prompt-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(212, 175, 55, 0.2), 
                rgba(182, 149, 192, 0.1),
                transparent);
            transition: left 0.6s ease;
        }

        .journaling-prompt-card:hover::before {
            left: 100%;
        }

        .scenario-question {
            position: relative;
            z-index: 10;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(72, 61, 139, 0.3);
        }

        .core-light-avatar {
            width: 200px;
            height: 200px;
            margin: 0 auto 2rem;
            border-radius: 50%;
            background: linear-gradient(135deg, #483D8B 0%, #5D4E9A 50%, #6A5ACD 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 
                0 0 50px rgba(72, 61, 139, 0.4),
                0 0 100px rgba(212, 175, 55, 0.2);
            animation: avatar-glow 3s ease-in-out infinite;
        }

        @keyframes avatar-glow {
            0%, 100% { 
                box-shadow: 
                    0 0 50px rgba(72, 61, 139, 0.4),
                    0 0 100px rgba(212, 175, 55, 0.2);
            }
            50% { 
                box-shadow: 
                    0 0 70px rgba(72, 61, 139, 0.6),
                    0 0 140px rgba(212, 175, 55, 0.3);
            }
        }

        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(8px) scale(0.99); 
                filter: blur(1px);
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
                filter: blur(0px);
            }
        }
        .fade-in { 
            animation: fadeIn 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; 
            opacity: 0; /* Start hidden */
        }
        
        /* Floating Panel Cards with Enhanced Glassmorphism */
        .kairos-card {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.15) 0%, 
                rgba(72, 61, 139, 0.08) 50%,
                rgba(182, 149, 192, 0.06) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 16px;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            animation: cardFloat 6s ease-in-out infinite;
            box-shadow: 
                0 12px 40px rgba(72, 61, 139, 0.12),
                0 4px 20px rgba(212, 175, 55, 0.08),
                0 0 30px rgba(182, 149, 192, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }
        
        .kairos-card:hover {
            transform: translateY(-8px) scale(1.02);
            border-color: rgba(212, 175, 55, 0.4);
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.2) 0%, 
                rgba(72, 61, 139, 0.12) 50%,
                rgba(182, 149, 192, 0.1) 100%);
            box-shadow: 
                0 20px 60px rgba(72, 61, 139, 0.15),
                0 8px 30px rgba(212, 175, 55, 0.12),
                0 0 50px rgba(182, 149, 192, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
        }

        @keyframes cardFloat {
            0%, 100% { 
                transform: translateY(0px) rotate(0deg);
            }
            33% { 
                transform: translateY(-3px) rotate(0.5deg);
            }
            66% { 
                transform: translateY(2px) rotate(-0.3deg);
            }
        }

        @keyframes progressPulse {
            0%, 100% { 
                r: 3px;
                filter: drop-shadow(0 0 3px var(--shimmering-gold));
            }
            50% { 
                r: 5px;
                filter: drop-shadow(0 0 8px var(--shimmering-gold));
            }
        }

        .sanctuary-container {
            min-height: 100vh;
            padding: 0;
            position: relative;
            max-width: 1200px;
            margin: 0 auto;
        }

        @keyframes containerBreathe {
            0%, 100% { 
                transform: scale(1);
                opacity: 1;
            }
            50% { 
                transform: scale(1.005);
                opacity: 0.98;
            }
        }

        /* Elegant Invitation Buttons */
        .kairos-btn { 
            font-family: 'Playfair Display', serif;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
            border: none;
            font-weight: 600;
            letter-spacing: 0.5px;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }
        
        .kairos-btn-primary { 
            background: linear-gradient(135deg, #483D8B 0%, #5D4E9A 50%, #6A5ACD 100%);
            color: white;
            padding: 1rem 2.5rem;
            font-size: 1.1rem;
            box-shadow: 
                0 8px 25px rgba(72, 61, 139, 0.25),
                0 4px 15px rgba(212, 175, 55, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        .kairos-btn-primary:hover { 
            background: linear-gradient(135deg, #3A3374 0%, #4A3F7D 50%, #5A4FCF 100%);
            transform: translateY(-4px) scale(1.02); 
            box-shadow: 
                0 15px 35px rgba(72, 61, 139, 0.3),
                0 8px 20px rgba(212, 175, 55, 0.15),
                0 0 30px rgba(182, 149, 192, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }
        
        /* Shimmer effect for buttons */
        .kairos-btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(212, 175, 55, 0.2), transparent);
            transition: left 0.6s ease;
        }
        
        .kairos-btn-primary:hover::before {
            left: 100%;
        }
        
        .action-btn:hover {
             transform: translateY(-3px) scale(1.02);
             box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .somatic-option, .thematic-option { transition: all 0.3s ease; cursor: pointer; }
        .somatic-option:hover, .thematic-option:hover { transform: scale(1.03); box-shadow: 0 10px 20px rgba(0,0,0,0.08); }
        .thematic-option.selected {
            transform: scale(1.03);
            box-shadow: 0 10px 20px rgba(72, 61, 139, 0.2);
            border-color: #483D8B;
            background-color: #eef2ff;
        }

        .emotion-chip.selected, .sensation-chip.selected { background-color: #483D8B; color: white; transform: scale(1.05); }

        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex; align-items: center; justify-content: center; z-index: 50;
        }
        
        #body-map-svg path { fill: #d1d5db; stroke: #6b7280; stroke-width: 1.5; transition: fill 0.3s ease; cursor: pointer; }
        #body-map-svg path:hover { fill: #93c5fd; }
        .sensation-dot { position: absolute; border-radius: 50%; transform: translate(-50%, -50%); border: 1px solid rgba(255,255,255,0.5); pointer-events: none; }
        
        #equanimity-pool { transition: all 1s ease-in-out; }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #483D8B;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased">

    <div id="app" class="min-h-screen"></div>
    <div id="modal-container"></div>

    <!-- Main Application Script -->
    <script type="module">
        // Import organized services (only auth needed - db operations via backend)
        import { auth, analytics, db } from './js/firebase-config.js';
        
        // Import Firebase Database functions for user-specific data
        import { 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged 
        } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

        // Import Firebase Firestore functions
        import { 
            collection, 
            doc, 
            setDoc, 
            getDoc, 
            getDocs, 
            addDoc,
            deleteDoc,
            query,
            where,
            orderBy,
            limit
        } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

        // --- USER DATA MANAGEMENT ---
        let entries = [];

        // Function to write user profile data to Firestore
        async function writeUserData(userId, name, email, imageUrl) {
            const userRef = doc(db, 'users', userId);
            
            try {
                await setDoc(userRef, {
                    username: name,
                    email: email,
                    profile_picture: imageUrl,
                    created_at: new Date().toISOString(),
                    last_login: new Date().toISOString()
                });
                console.log("User data saved successfully!");
            } catch (error) {
                console.error("Error writing user data: ", error);
            }
        }

        // Function to save a journal entry for the current user
        async function saveJournalEntry(userId, entryData) {
            return await callFirebaseBackend('createEntry', entryData);
        }

        // Function to load all journal entries for the current user
        async function loadUserJournalEntries(userId) {
            return await callFirebaseBackend('getUserEntries', { limit: 50 });
        }

        // Function to delete a journal entry
        async function deleteJournalEntry(userId, entryId) {
            return await callFirebaseBackend('deleteEntry', { entryId });
        }

        // Mock data for initial development (will be replaced by real user data)
        let mockEntries = [
            { id: 1, title: "Team Meeting", date: "2025-07-22T14:30:00.000Z", situation: { description: "My project was criticized and I felt defensive." }, inquiry: { story: "They are trying to undermine me.", emotion: "Anger and Fear", belief: "I'm not good enough." }, emotional: { emotions: [{name: 'Angry', intensity: 8}, {name: 'Fearful', intensity: 7}]}, physical: { sensations: [{part: "Chest", quality: "Tightness", intensity: 8, x: 50, y: 45, view: 'front'}, {part: "Stomach/Gut", quality: "Ache", intensity: 6, x: 50, y: 55, view: 'front'}]} },
            { id: 2, title: "Morning Walk", date: "2025-07-21T08:00:00.000Z", situation: { description: "A peaceful walk in the park." }, emotional: { emotions: [{name: 'Calm', intensity: 2}, {name: 'Happy', intensity: 3}]} },
            { id: 3, title: "Unexpected Bill", date: "2025-07-20T18:00:00.000Z", situation: { description: "Received a large, unexpected bill in the mail." }, emotional: { emotions: [{name: 'Fearful', intensity: 9}]}, physical: { sensations: [{part: "Stomach/Gut", quality: "Tightness", intensity: 9, x: 50, y: 55, view: 'front'}]} }
        ];
        const quotes = ["The journey of a thousand miles begins with a single step.", "The only way out is through.", "What you resist, persists."];
        const entrySections = {
            dream: { title: "Dream & Synchronicity", icon: "fa-moon" },
            inquiry: { title: "Internal Narrative", icon: "fa-layer-group" },
            cognitive: { title: "My Thoughts & Beliefs", icon: "fa-brain" },
            emotional: { title: "My Emotions", icon: "fa-heart" },
            physical: { title: "My Body's Sensations", icon: "fa-person-running" },
            behavioral: { title: "My Actions & Urges", icon: "fa-hand-fist" },
            reflection: { title: "Patterns & Connections", icon: "fa-infinity" },
            integration: { title: "Insights & Intentions", icon: "fa-seedling" },
            perspective: { title: "Perspective Lenses", icon: "fa-glasses" }
        };

        // --- DEBUG FUNCTIONS ---
        // Helper function to determine if user should see onboarding
        function shouldShowOnboarding(user) {
            // Check if user has completed onboarding
            const userOnboardingKey = `hasCompletedOnboarding_${user.uid}`;
            const hasCompletedOnboarding = localStorage.getItem(userOnboardingKey) === 'true';
            
            // If they've completed onboarding, don't show it
            if (hasCompletedOnboarding) {
                return false;
            }
            
            // For new users or users with no entries, show onboarding
            return entries.length === 0;
        }

        // --- STATE MANAGEMENT ---
        let state = {
            currentPage: 'login',
            currentUser: null,
            isLoading: false,
            authError: null,
            isFirstVisit: true, // Will be determined per-user
            onboardingStep: 0,
            onboardingData: {},
            enneagramStep: 0,
            enneagramAnswers: [],
            discoveredArchetype: null,
            eventListenersAdded: false,
            currentEntry: null,
            somaticState: null,
            sessionCapacity: null,
            bodyMapView: 'front',
            entryBuilder: {},
            advisor: { isLoading: true, content: null, error: null },
            synthesis: { isLoading: true, content: null, error: null },
            toast: { visible: false },
            modal: { visible: false }
        };

        // Create "The Descent" transition effect
        function createDescentTransition() {
            // Hide current content immediately
            const appContainer = document.getElementById('app');
            if (appContainer) {
                appContainer.classList.add('transitioning');
            }
            
            const overlay = document.createElement('div');
            overlay.className = 'descent-overlay';
            document.body.appendChild(overlay);
            
            // Remove overlay and show new content after animation
            setTimeout(() => {
                if (overlay.parentNode) {
                    overlay.parentNode.removeChild(overlay);
                }
                // Restore content visibility
                if (appContainer) {
                    appContainer.classList.remove('transitioning');
                }
            }, 3500);
        }

        // Firebase Authentication State Listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Store the actual Firebase user object to access getIdToken()
                state.currentUser = user;
                
                if (state.currentPage === 'login' || state.currentPage === 'register') {
                    // Create descent transition
                    createDescentTransition();
                    
                    // Wait a moment for the user token to be ready, then setup user data
                    setTimeout(async () => {
                        try {
                            // Write/update user profile data in Realtime Database
                            await writeUserData(
                                user.uid,
                                user.displayName || 'Anonymous User',
                                user.email,
                                user.photoURL || ''
                            );
                            
                            // Load user's journal entries from Realtime Database
                            entries = await loadUserJournalEntries(user.uid);
                        } catch (error) {
                            console.warn('Authentication issue during initial load:', error);
                            
                            // If there's an auth error, redirect back to login
                            if (error.message.includes('token') || error.message.includes('auth')) {
                                console.warn('Invalid authentication, redirecting to login');
                                state.currentUser = null;
                                state.currentPage = 'login';
                                render();
                                return;
                            }
                            
                            // Initialize with empty entries array for other errors
                            entries = [];
                        }

                        // Check if user should see onboarding
                        if (shouldShowOnboarding(user)) {
                            state.currentPage = 'onboarding';
                            state.onboardingStep = 0;
                            state.isFirstVisit = true;
                        } else {
                            state.currentPage = 'dashboard';
                            state.isFirstVisit = false;
                        }
                        render();
                    }, 1500); // Delay to let descent animation play
                } else if (state.currentPage === 'onboarding' && state.onboardingStep >= 4) {
                    state.currentPage = 'dashboard';
                    try {
                        // Load user's journal entries from Realtime Database
                        entries = await loadUserJournalEntries(user.uid);
                    } catch (error) {
                        console.warn('Could not load entries after onboarding:', error);
                        entries = [];
                    }
                    render();
                }
            } else {
                state.currentUser = null;
                if (state.currentPage !== 'login' && state.currentPage !== 'register') {
                    state.currentPage = 'login';
                }
                entries = []; // Clear entries when logged out
                render();
            }
        });

        // Secure API call to Firebase backend
        async function callFirebaseBackend(action, data = {}) {
            if (!state.currentUser) {
                throw new Error('User must be authenticated');
            }

            // Check if running locally and return mock data immediately
            const isLocalDevelopment = window.location.hostname === 'localhost' || 
                                     window.location.hostname === '127.0.0.1' || 
                                     window.location.hostname.includes('localhost') ||
                                     window.location.protocol === 'file:' ||
                                     (window.location.port && window.location.port !== '80' && window.location.port !== '443');
            
            if (isLocalDevelopment) {
                console.warn('Running in local development mode. Using mock data for backend calls.');
                
                // Return appropriate mock data based on action
                switch (action) {
                    case 'getUserEntries':
                        // Load from localStorage for persistence in local development
                        const storedEntries = loadLocalEntries();
                        return storedEntries.length > 0 ? storedEntries : [
                            {
                                id: 'mock-entry-1',
                                title: 'Welcome to Kairos - Your First Entry',
                                date: new Date().toISOString(),
                                type: 'General',
                                situation: { description: 'This is a sample entry to show how your recent entries will appear. Try creating your own entry using the Gateway Choice feature!' },
                                createdAt: { _seconds: Math.floor(Date.now() / 1000) }
                            },
                            {
                                id: 'mock-entry-2', 
                                title: 'Local Development Guide',
                                date: new Date(Date.now() - 86400000).toISOString(), // Yesterday
                                type: 'Reflection',
                                situation: { description: 'In local development, your entries will persist in localStorage until you clear browser data. All features work with mock data.' },
                                createdAt: { _seconds: Math.floor((Date.now() - 86400000) / 1000) }
                            }
                        ];
                    case 'createEntry':
                        const newEntry = { 
                            id: 'local-' + Date.now(), 
                            ...data,
                            createdAt: { _seconds: Math.floor(Date.now() / 1000) }
                        };
                        // Don't add to entries array here - that's handled by onJournalEntryCompleted
                        return newEntry;
                    case 'deleteEntry':
                        // Remove from localStorage
                        const currentEntries = loadLocalEntries();
                        const filteredEntries = currentEntries.filter(e => e.id !== data.entryId);
                        localStorage.setItem('kairos-local-entries', JSON.stringify(filteredEntries));
                        return { success: true };
                    default:
                        return { mockData: true, success: true };
                }
            }

            try {
                // Force token refresh to ensure we have a valid token
                const idToken = await state.currentUser.getIdToken(true);
                
                if (!idToken) {
                    throw new Error('Unable to get authentication token');
                }
                
                const response = await fetch(`/.netlify/functions/firebase-backend`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: JSON.stringify({ action, data })
                });

                if (!response.ok) {
                    let errorMessage = 'Backend operation failed';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || errorMessage;
                    } catch (parseError) {
                        // If we can't parse the error response, use the status text
                        errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    }
                    
                    // If we get a 401, the user needs to re-authenticate
                    if (response.status === 401) {
                        console.warn('Authentication expired, redirecting to login');
                        state.currentUser = null;
                        state.currentPage = 'login';
                        render();
                        throw new Error('Authentication expired. Please log in again.');
                    }
                    
                    throw new Error(errorMessage);
                }

                return await response.json();
            } catch (error) {
                console.error('Firebase backend error:', error);
                
                // Handle specific Firebase auth errors
                if (error.code === 'auth/invalid-user-token' || 
                    error.code === 'auth/user-token-expired' ||
                    error.message.includes('Invalid or expired token')) {
                    console.warn('Token expired, redirecting to login');
                    state.currentUser = null;
                    state.currentPage = 'login';
                    render();
                    throw new Error('Session expired. Please log in again.');
                }
                
                throw error;
            }
        }

        // Local development storage helpers
        function saveLocalEntries() {
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                localStorage.setItem('kairos-local-entries', JSON.stringify(entries));
            }
        }

        function loadLocalEntries() {
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                const stored = localStorage.getItem('kairos-local-entries');
                return stored ? JSON.parse(stored) : [];
            }
            return [];
        }

        // Helper function to handle Gemini API calls with local development support
        async function callGeminiAPI(prompt, structured = false) {
            // Check if running locally and return mock data
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                console.warn('Running in local development mode. Using mock response for Gemini API calls.');
                
                if (structured) {
                    // Return structured mock response for synthesis and advisor
                    return {
                        guidance: "This is a mock response for local development. The AI features will work fully when deployed.",
                        themes: ["Local Development", "Mock Data"],
                        insights: "Deploy the app to see full AI functionality."
                    };
                } else {
                    // Return simple text response
                    return {
                        text: "This is a mock response for local development. The AI features will work fully when deployed to see the complete Gemini AI integration."
                    };
                }
            }

            // Production API call
            try {
                const apiUrl = '/.netlify/functions/call-gemini';
                const payload = { prompt, structured };
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Serverless function failed with status ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error("Gemini API call failed:", error);
                throw error;
            }
        }

        // Load user's journal entries from Firebase (via backend)
        async function loadUserEntries() {
            if (!state.currentUser) {
                console.warn('No authenticated user found, cannot load entries');
                return;
            }
            
            try {
                const result = await callFirebaseBackend('getUserEntries', { limit: 50 });
                
                entries = result.map(entry => ({
                    ...entry,
                    // Convert Firestore timestamp to ISO string for compatibility
                    date: entry.createdAt?.toDate?.()?.toISOString() || 
                          (entry.createdAt?._seconds ? new Date(entry.createdAt._seconds * 1000).toISOString() : new Date().toISOString())
                }));
                
                console.log(`Loaded ${entries.length} entries:`, entries.map(e => ({ id: e.id, title: e.title, date: e.date })));
            } catch (error) {
                console.error('Error loading entries:', error);
                
                // Initialize with empty array to prevent further errors
                entries = [];
                
                // Only show error toast for legitimate backend errors, not local development issues
                if (!error.message.includes('mock data') && 
                    !error.message.includes('Invalid or expired token') &&
                    !window.location.hostname.includes('localhost')) {
                    showToast('Failed to load your journal entries', 'error');
                }
            }
        }

        // Create luminous particles effect
        function createLuminousParticles() {
            const particlesContainer = document.getElementById('particles-container');
            if (!particlesContainer) return;
            
            // Clear existing particles
            particlesContainer.innerHTML = '';
            
            // Create 15 particles with random properties
            for (let i = 0; i < 15; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                // Random size (2-6px)
                const size = Math.random() * 4 + 2;
                particle.style.width = size + 'px';
                particle.style.height = size + 'px';
                
                // Random starting position
                particle.style.left = Math.random() * 100 + '%';
                
                // Random animation delay
                particle.style.animationDelay = Math.random() * 15 + 's';
                
                // Random animation duration (10-20s)
                particle.style.animationDuration = (Math.random() * 10 + 10) + 's';
                
                // Slight random color variation
                const colors = [
                    'rgba(255, 255, 255, 0.8)',
                    'rgba(72, 61, 139, 0.6)',
                    'rgba(212, 175, 55, 0.5)',
                    'rgba(182, 149, 192, 0.7)'
                ];
                const color = colors[Math.floor(Math.random() * colors.length)];
                particle.style.background = `radial-gradient(circle, ${color} 0%, transparent 70%)`;
                
                particlesContainer.appendChild(particle);
            }
        }
        
        // Create enhanced descent particles for login threshold
        function createDescentParticles() {
            const particlesContainer = document.getElementById('descent-particles-container');
            if (!particlesContainer) return;
            
            // Clear existing particles
            particlesContainer.innerHTML = '';
            
            // Create 25 sacred particles with enhanced properties
            for (let i = 0; i < 25; i++) {
                const particle = document.createElement('div');
                particle.className = 'descent-particle';
                
                // Varied sizes (3-8px)
                const size = Math.random() * 5 + 3;
                particle.style.width = size + 'px';
                particle.style.height = size + 'px';
                
                // Random starting position across width
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = '-100px';
                
                // Staggered animation delays for continuous flow
                particle.style.animationDelay = Math.random() * 20 + 's';
                
                // Enhanced sacred colors with more variety
                const colors = [
                    'rgba(72, 61, 139, 0.8)',    // Deep Indigo
                    'rgba(212, 175, 55, 0.7)',   // Shimmering Gold
                    'rgba(182, 149, 192, 0.6)',  // Rose Quartz
                    'rgba(255, 255, 255, 0.5)',  // Pure Light
                    'rgba(200, 178, 219, 0.4)',  // Ethereal Lavender
                    'rgba(168, 181, 160, 0.3)'   // Sage Mist
                ];
                const color = colors[Math.floor(Math.random() * colors.length)];
                particle.style.background = `radial-gradient(circle, ${color} 0%, rgba(255,255,255,0.1) 50%, transparent 70%)`;
                
                // Add subtle box shadow for enhanced glow
                particle.style.boxShadow = `0 0 ${size * 2}px ${color}`;
                
                particlesContainer.appendChild(particle);
            }
        }

        // --- RENDER FUNCTIONS ---
        const appContainer = document.getElementById('app');
        const modalContainer = document.getElementById('modal-container');

        async function render() {
            appContainer.innerHTML = ''; 
            
            // Handle async pages
            if (state.currentPage === 'advisor') {
                appContainer.innerHTML = AdvisorPage(); // Render skeleton
                await generateDynamicAdvisorContent(); // Fetch data
                appContainer.innerHTML = AdvisorPage(); // Re-render with data
            } else if (state.currentPage === 'synthesis') {
                appContainer.innerHTML = SynthesisPage(); // Render skeleton
                await generateSynthesisInsights(); // Fetch data
                appContainer.innerHTML = SynthesisPage(); // Re-render with data
            } else {
                // Handle synchronous pages
                switch (state.currentPage) {
                    case 'login': appContainer.innerHTML = LoginPage(); break;
                    case 'register': appContainer.innerHTML = RegisterPage(); break;
                    case 'onboarding': appContainer.innerHTML = OnboardingPage(); break;
                    case 'dashboard': appContainer.innerHTML = DashboardPage(); break;
                    case 'gatewayChoice': appContainer.innerHTML = GatewayChoicePage(); break;
                    case 'textJournaling': appContainer.innerHTML = TextJournalingPage(); break;
                    case 'voiceJournaling': appContainer.innerHTML = VoiceJournalingPage(); break;
                    case 'viewEntry': appContainer.innerHTML = ViewEntryPage(); break;
                }
            }
            modalContainer.innerHTML = state.modal.visible ? ModalComponent(state.modal) : '';
            
            // Create particles for different page types
            if (state.currentPage === 'login' || state.currentPage === 'register' || state.currentPage === 'onboarding' || state.currentPage === 'gatewayChoice' || state.currentPage === 'textJournaling' || state.currentPage === 'voiceJournaling') {
                setTimeout(() => createDescentParticles(), 100);
            } else if (state.currentPage === 'dashboard') {
                setTimeout(() => {
                    createDescentParticles();
                    initializeOrbParticles();
                }, 100);
            }
            
            // Attach event listeners with small delay to ensure DOM is ready
            setTimeout(() => attachEventListeners(), 10);
            renderToast();
        }
        
        // --- UI COMPONENTS ---
        function LoginPage() { 
             return `
                <!-- The Descent Background - Living Inner Cosmos -->
                <div class="descent-background"></div>
                <div class="descent-particles" id="descent-particles-container"></div>
                
                <div class="threshold-container" style="
                    min-height: 100vh;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    padding: 2rem;
                    position: relative;
                ">
                    
                    <!-- Breathing Kairos Logo -->
                    <div class="logo-container" style="
                        text-align: center;
                        margin-bottom: 3rem;
                        animation: logoEntrance 2s ease-out 0.5s both;
                    ">
                        <h1 style="
                            font-family: 'Playfair Display', serif;
                            font-size: 4rem;
                            font-weight: 600;
                            margin-bottom: 1rem;
                            background: linear-gradient(135deg, 
                                var(--deep-indigo) 0%, 
                                var(--soft-rose-quartz) 50%, 
                                var(--shimmering-gold) 100%);
                            -webkit-background-clip: text;
                            -webkit-text-fill-color: transparent;
                            text-shadow: 0 0 40px rgba(72, 61, 139, 0.6);
                            filter: drop-shadow(0 2px 8px rgba(212, 175, 55, 0.3));
                            animation: logoBreathing 4s ease-in-out infinite;
                        ">Kairos</h1>
                        
                        <p style="
                            font-family: 'Playfair Display', serif;
                            font-size: 1.25rem;
                            font-weight: 400;
                            color: var(--warm-off-white);
                            opacity: 0.9;
                            letter-spacing: 1px;
                            text-shadow: 0 1px 3px rgba(72, 61, 139, 0.3);
                        ">Welcome back</p>
                    </div>
                    
                    <!-- Sacred Login Form -->
                    <div class="threshold-form" style="
                        width: 100%;
                        max-width: 400px;
                        opacity: 0;
                        animation: formEntrance 1.5s ease-out 2.5s both;
                    ">
                        <form id="login-form" style="
                            display: flex;
                            flex-direction: column;
                            gap: 2rem;
                        ">
                            <div class="input-sanctuary">
                                <input 
                                    type="email" 
                                    id="email" 
                                    placeholder="Your email"
                                    style="
                                        width: 100%;
                                        padding: 1.25rem 1.5rem;
                                        background: rgba(255, 255, 255, 0.1);
                                        backdrop-filter: blur(20px);
                                        border: 2px solid rgba(72, 61, 139, 0.2);
                                        border-radius: 16px;
                                        font-family: 'Inter', sans-serif;
                                        font-size: 1rem;
                                        color: var(--warm-off-white);
                                        transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                                        outline: none;
                                        box-shadow: 
                                            0 8px 25px rgba(72, 61, 139, 0.1),
                                            inset 0 1px 0 rgba(255, 255, 255, 0.1);
                                    "
                                    onfocus="
                                        this.style.background='rgba(255,255,255,0.15)';
                                        this.style.borderColor='var(--deep-indigo)';
                                        this.style.boxShadow='0 12px 35px rgba(72,61,139,0.2), 0 0 30px rgba(212,175,55,0.1), inset 0 1px 0 rgba(255,255,255,0.2)';
                                        this.style.transform='translateY(-2px)';
                                    "
                                    onblur="
                                        this.style.background='rgba(255,255,255,0.1)';
                                        this.style.borderColor='rgba(72,61,139,0.2)';
                                        this.style.boxShadow='0 8px 25px rgba(72,61,139,0.1), inset 0 1px 0 rgba(255,255,255,0.1)';
                                        this.style.transform='translateY(0)';
                                    "
                                    required
                                />
                            </div>
                            
                            <div class="input-sanctuary">
                                <input 
                                    type="password" 
                                    id="password" 
                                    placeholder="Your sacred key"
                                    style="
                                        width: 100%;
                                        padding: 1.25rem 1.5rem;
                                        background: rgba(255, 255, 255, 0.1);
                                        backdrop-filter: blur(20px);
                                        border: 2px solid rgba(72, 61, 139, 0.2);
                                        border-radius: 16px;
                                        font-family: 'Inter', sans-serif;
                                        font-size: 1rem;
                                        color: var(--warm-off-white);
                                        transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                                        outline: none;
                                        box-shadow: 
                                            0 8px 25px rgba(72, 61, 139, 0.1),
                                            inset 0 1px 0 rgba(255, 255, 255, 0.1);
                                    "
                                    onfocus="
                                        this.style.background='rgba(255,255,255,0.15)';
                                        this.style.borderColor='var(--deep-indigo)';
                                        this.style.boxShadow='0 12px 35px rgba(72,61,139,0.2), 0 0 30px rgba(212,175,55,0.1), inset 0 1px 0 rgba(255,255,255,0.2)';
                                        this.style.transform='translateY(-2px)';
                                    "
                                    onblur="
                                        this.style.background='rgba(255,255,255,0.1)';
                                        this.style.borderColor='rgba(72,61,139,0.2)';
                                        this.style.boxShadow='0 8px 25px rgba(72,61,139,0.1), inset 0 1px 0 rgba(255,255,255,0.1)';
                                        this.style.transform='translateY(0)';
                                    "
                                    required
                                />
                            </div>
                            
                            <button 
                                type="submit" 
                                class="threshold-enter-btn"
                                style="
                                    width: 100%;
                                    padding: 1.25rem 2rem;
                                    background: linear-gradient(135deg, 
                                        var(--deep-indigo) 0%, 
                                        var(--soft-rose-quartz) 50%, 
                                        var(--shimmering-gold) 100%);
                                    border: none;
                                    border-radius: 16px;
                                    font-family: 'Inter', sans-serif;
                                    font-size: 1.1rem;
                                    font-weight: 600;
                                    letter-spacing: 0.5px;
                                    color: var(--warm-off-white);
                                    cursor: pointer;
                                    transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                                    position: relative;
                                    overflow: hidden;
                                    text-transform: uppercase;
                                    box-shadow: 
                                        0 8px 25px rgba(72, 61, 139, 0.3),
                                        0 0 20px rgba(212, 175, 55, 0.1),
                                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
                                    ${state.isLoading ? 'opacity: 0.75; cursor: not-allowed;' : ''}
                                "
                                onmouseover="
                                    if (!this.disabled) {
                                        this.style.transform='translateY(-3px) scale(1.02)';
                                        this.style.boxShadow='0 15px 35px rgba(72,61,139,0.4), 0 0 30px rgba(212,175,55,0.2), inset 0 1px 0 rgba(255,255,255,0.3)';
                                    }
                                "
                                onmouseout="
                                    if (!this.disabled) {
                                        this.style.transform='translateY(0) scale(1)';
                                        this.style.boxShadow='0 8px 25px rgba(72,61,139,0.3), 0 0 20px rgba(212,175,55,0.1), inset 0 1px 0 rgba(255,255,255,0.2)';
                                    }
                                "
                                ${state.isLoading ? 'disabled' : ''}
                            >
                                ${state.isLoading ? 
                                    '<div style="display: inline-flex; align-items: center; gap: 0.75rem;"><div class="sacred-loader"></div>Entering Sanctuary...</div>' : 
                                    'Enter Sanctuary'
                                }
                            </button>
                            
                            ${state.authError ? `
                                <p style="
                                    color: var(--soft-rose-quartz);
                                    font-size: 0.9rem;
                                    text-align: center;
                                    margin-top: 1rem;
                                    padding: 0.75rem;
                                    background: rgba(182, 149, 192, 0.1);
                                    border: 1px solid rgba(182, 149, 192, 0.2);
                                    border-radius: 8px;
                                    backdrop-filter: blur(10px);
                                ">${state.authError}</p>
                            ` : ''}
                        </form>
                        
                        <div style="
                            text-align: center;
                            margin-top: 2rem;
                            opacity: 0;
                            animation: linkEntrance 1s ease-out 3.5s both;
                        ">
                            <p style="
                                font-family: 'Inter', sans-serif;
                                color: rgba(255, 255, 255, 0.7);
                                font-size: 0.95rem;
                            ">New here? 
                                <a href="#" id="go-to-register" style="
                                    color: var(--shimmering-gold);
                                    font-weight: 600;
                                    text-decoration: none;
                                    transition: all 0.3s ease;
                                    text-shadow: 0 1px 3px rgba(212, 175, 55, 0.3);
                                " onmouseover="this.style.textShadow='0 2px 8px rgba(212,175,55,0.6)'" onmouseout="this.style.textShadow='0 1px 3px rgba(212,175,55,0.3)'">Begin your journey</a>
                            </p>
                        </div>
                    </div>
                    
                </div>
            `;
        }

        function OnboardingPage() {
            const steps = [
                'weaver-welcome',
                'energy-check',
                'archetype-discovery',
                'wearables-connect'
            ];
            
            const currentStep = steps[state.onboardingStep];
            
            switch(currentStep) {
                case 'weaver-welcome':
                    return `
                        <!-- The Descent Background - Sacred Onboarding -->
                        <div class="descent-background"></div>
                        <div class="descent-particles" id="descent-particles-container"></div>
                        
                        <div class="threshold-container" style="
                            min-height: 100vh;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            padding: 2rem;
                            position: relative;
                        ">
                            
                            <!-- Sacred Weaver Presence Icon -->
                            <div class="weaver-presence" style="
                                text-align: center;
                                margin-bottom: 3rem;
                                animation: logoEntrance 2s ease-out 0.5s both;
                            ">
                                <div style="
                                    width: 120px;
                                    height: 120px;
                                    margin: 0 auto 2rem;
                                    border-radius: 50%;
                                    background: radial-gradient(circle at 30% 30%, 
                                        rgba(212, 175, 55, 0.9) 0%, 
                                        rgba(72, 61, 139, 0.7) 40%, 
                                        rgba(72, 61, 139, 0.5) 100%);
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    animation: logoBreathing 4s ease-in-out infinite;
                                    box-shadow: 
                                        0 0 40px rgba(212, 175, 55, 0.4),
                                        0 0 80px rgba(72, 61, 139, 0.2),
                                        inset 0 0 20px rgba(255, 255, 255, 0.1);
                                ">
                                    <i class="fas fa-sparkles" style="
                                        font-size: 2.5rem;
                                        color: var(--warm-off-white);
                                        text-shadow: 0 2px 8px rgba(212, 175, 55, 0.5);
                                    "></i>
                                </div>
                                
                                <h1 style="
                                    font-family: 'Playfair Display', serif;
                                    font-size: 3.5rem;
                                    font-weight: 600;
                                    background: linear-gradient(135deg, 
                                        var(--shimmering-gold) 0%, 
                                        var(--soft-rose-quartz) 50%, 
                                        var(--deep-indigo) 100%);
                                    -webkit-background-clip: text;
                                    -webkit-text-fill-color: transparent;
                                    text-shadow: 0 0 30px rgba(212, 175, 55, 0.6);
                                    filter: drop-shadow(0 2px 6px rgba(182, 149, 192, 0.3));
                                    margin-bottom: 1rem;
                                ">Welcome, Soul Traveler</h1>
                            </div>
                            
                            <!-- Sacred Dialogue -->
                            <div class="weaver-dialogue" style="
                                max-width: 600px;
                                text-align: center;
                                opacity: 0;
                                animation: formEntrance 1.5s ease-out 2.5s both;
                            ">
                                <div style="
                                    background: rgba(255, 255, 255, 0.05);
                                    backdrop-filter: blur(20px);
                                    border: 1px solid rgba(72, 61, 139, 0.2);
                                    border-radius: 20px;
                                    padding: 3rem 2.5rem;
                                    margin-bottom: 3rem;
                                ">
                                    <p style="
                                        font-family: 'Crimson Text', serif;
                                        font-size: 1.3rem;
                                        font-style: italic;
                                        color: var(--warm-off-white);
                                        line-height: 1.6;
                                        margin-bottom: 1.5rem;
                                        opacity: 0;
                                        animation: weaverReveal 2s ease-out 3.5s both;
                                    ">I am <span style="color: var(--shimmering-gold); font-weight: 600;">The Weaver</span>, your guide in this luminous tapestry of self-discovery.</p>
                                    
                                    <p style="
                                        font-family: 'Inter', sans-serif;
                                        font-size: 1.1rem;
                                        color: rgba(255, 255, 255, 0.8);
                                        line-height: 1.7;
                                        margin-bottom: 1rem;
                                        opacity: 0;
                                        animation: weaverReveal 1.8s ease-out 5s both;
                                    ">Together, we will chart the territories of your inner cosmos,</p>
                                    
                                    <p style="
                                        font-family: 'Inter', sans-serif;
                                        font-size: 1.1rem;
                                        color: rgba(255, 255, 255, 0.8);
                                        line-height: 1.7;
                                        margin-bottom: 1rem;
                                        opacity: 0;
                                        animation: weaverReveal 1.8s ease-out 6.5s both;
                                    ">weaving threads of awareness into a map of your authentic self.</p>
                                    
                                    <p style="
                                        font-family: 'Inter', sans-serif;
                                        font-size: 1.1rem;
                                        color: rgba(255, 255, 255, 0.9);
                                        line-height: 1.7;
                                        font-weight: 500;
                                        opacity: 0;
                                        animation: weaverReveal 1.8s ease-out 8s both;
                                    ">This journey begins not with questions, but with presence.</p>
                                </div>
                                
                                <button 
                                    id="begin-weaving" 
                                    style="
                                        background: linear-gradient(135deg, 
                                            var(--shimmering-gold) 0%, 
                                            var(--soft-rose-quartz) 50%, 
                                            var(--deep-indigo) 100%);
                                        border: none;
                                        border-radius: 16px;
                                        padding: 1.25rem 3rem;
                                        font-family: 'Inter', sans-serif;
                                        font-size: 1.2rem;
                                        font-weight: 600;
                                        letter-spacing: 0.5px;
                                        color: var(--warm-off-white);
                                        cursor: pointer;
                                        transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                                        text-transform: uppercase;
                                        box-shadow: 
                                            0 8px 25px rgba(212, 175, 55, 0.3),
                                            0 0 20px rgba(72, 61, 139, 0.2),
                                            inset 0 1px 0 rgba(255, 255, 255, 0.2);
                                        opacity: 0;
                                        animation: weaverReveal 1.5s ease-out 9.5s both;
                                    "
                                    onmouseover="
                                        this.style.transform='translateY(-3px) scale(1.02)';
                                        this.style.boxShadow='0 15px 35px rgba(212,175,55,0.4), 0 0 30px rgba(72,61,139,0.3), inset 0 1px 0 rgba(255,255,255,0.3)';
                                    "
                                    onmouseout="
                                        this.style.transform='translateY(0) scale(1)';
                                        this.style.boxShadow='0 8px 25px rgba(212,175,55,0.3), 0 0 20px rgba(72,61,139,0.2), inset 0 1px 0 rgba(255,255,255,0.2)';
                                    "
                                >
                                    Begin the Weaving
                                </button>
                            </div>
                            
                        </div>
                    `;
                    
                case 'energy-check':
                    return `
                        <!-- The Descent Background -->
                        <div class="descent-background"></div>
                        <div class="descent-particles" id="descent-particles-container"></div>
                        
                        <div class="threshold-container" style="
                            min-height: 100vh;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            padding: 2rem;
                            text-align: center;
                        ">
                            
                            <!-- Sacred Question -->
                            <div style="
                                margin-bottom: 4rem;
                                animation: logoEntrance 2s ease-out 0.5s both;
                            ">
                                <h2 style="
                                    font-family: 'Playfair Display', serif;
                                    font-size: 3rem;
                                    font-weight: 600;
                                    margin-bottom: 2rem;
                                    background: linear-gradient(135deg, 
                                        var(--shimmering-gold) 0%, 
                                        var(--soft-rose-quartz) 50%, 
                                        var(--deep-indigo) 100%);
                                    -webkit-background-clip: text;
                                    -webkit-text-fill-color: transparent;
                                    text-shadow: 0 0 30px rgba(212, 175, 55, 0.5);
                                    filter: drop-shadow(0 2px 6px rgba(182, 149, 192, 0.3));
                                    line-height: 1.2;
                                ">What energy do you bring with you today?</h2>
                                
                                <p style="
                                    font-family: 'Inter', sans-serif;
                                    font-size: 1.2rem;
                                    color: rgba(255, 255, 255, 0.8);
                                    max-width: 600px;
                                    margin: 0 auto;
                                    line-height: 1.6;
                                    opacity: 0;
                                    animation: formEntrance 1.5s ease-out 2s both;
                                ">Before we begin weaving your tapestry, let us attune to the luminous frequency you carry in this moment.</p>
                            </div>
                                    
                            <!-- Sacred Energy Bubbles -->
                            <div style="
                                display: grid;
                                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                                gap: 2rem;
                                max-width: 800px;
                                width: 100%;
                                margin-bottom: 4rem;
                                opacity: 0;
                                animation: formEntrance 1.8s ease-out 3.5s both;
                            ">
                                <div class="energy-bubble" data-energy="curious">
                                    <i class="fas fa-eye" style="color: var(--shimmering-gold);"></i>
                                    <p>Curious</p>
                                </div>
                                <div class="energy-bubble" data-energy="peaceful">
                                    <i class="fas fa-spa" style="color: var(--sage-mist);"></i>
                                    <p>Peaceful</p>
                                </div>
                                <div class="energy-bubble" data-energy="excited">
                                    <i class="fas fa-star" style="color: var(--soft-rose-quartz);"></i>
                                    <p>Excited</p>
                                </div>
                                <div class="energy-bubble" data-energy="reflective">
                                    <i class="fas fa-moon" style="color: var(--deep-indigo);"></i>
                                    <p>Reflective</p>
                                </div>
                                <div class="energy-bubble" data-energy="uncertain">
                                    <i class="fas fa-question-circle" style="color: var(--ethereal-lavender);"></i>
                                    <p>Uncertain</p>
                                </div>
                                <div class="energy-bubble" data-energy="hopeful">
                                    <i class="fas fa-seedling" style="color: var(--sage-mist);"></i>
                                    <p>Hopeful</p>
                                </div>
                                <div class="energy-bubble" data-energy="tired">
                                    <i class="fas fa-battery-quarter" style="color: var(--muted-stone-gray);"></i>
                                    <p>Tired</p>
                                </div>
                                <div class="energy-bubble" data-energy="open">
                                    <i class="fas fa-heart" style="color: var(--soft-rose-quartz);"></i>
                                    <p>Open</p>
                                </div>
                                    </div>
                                    
                            
                            <!-- Sacred Continue Button -->
                            <button 
                                id="continue-energy" 
                                style="
                                    background: linear-gradient(135deg, 
                                        var(--deep-indigo) 0%, 
                                        var(--soft-rose-quartz) 50%, 
                                        var(--shimmering-gold) 100%);
                                    border: none;
                                    border-radius: 16px;
                                    padding: 1.25rem 3rem;
                                    font-family: 'Inter', sans-serif;
                                    font-size: 1.1rem;
                                    font-weight: 600;
                                    letter-spacing: 0.5px;
                                    color: var(--warm-off-white);
                                    cursor: pointer;
                                    transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                                    text-transform: uppercase;
                                    opacity: 0.5;
                                    box-shadow: 
                                        0 8px 25px rgba(72, 61, 139, 0.2),
                                        inset 0 1px 0 rgba(255, 255, 255, 0.1);
                                    pointer-events: none;
                                "
                                disabled
                            >
                                Beautiful. Let us continue.
                            </button>
                            
                        </div>
                    `;
                    
                case 'wearables-connect':
                    return `
                        <div class="descent-background"></div>
                        <div class="descent-particles" id="descent-particles-container"></div>
                        <div class="threshold-container" style="
                            min-height: 100vh;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            padding: 2rem;
                            position: relative;
                        ">
                            <div class="kairos-card p-10 rounded-xl max-w-3xl w-full text-center">
                                <div class="weaver-text" style="animation-delay: 0.5s;">
                                    <h2 class="text-3xl font-bold mb-6" style="
                                        background: linear-gradient(135deg, #483D8B 0%, #5D4E9A 50%, #6A5ACD 100%);
                                        -webkit-background-clip: text;
                                        -webkit-text-fill-color: transparent;
                                    ">Connecting to Your Body's Wisdom</h2>
                                    
                                    <p class="text-lg text-gray-600 mb-8 max-w-2xl mx-auto" style="animation-delay: 1s; opacity: 0; animation: weaverReveal 1s ease-out 1s forwards;">
                                        Your body holds profound intelligence. Let us weave in its voice through your wearable companions.
                                    </p>
                                    
                                    <div class="grid md:grid-cols-3 gap-6 mb-8" style="animation-delay: 2s; opacity: 0; animation: weaverReveal 1s ease-out 2s forwards;">
                                        <div class="p-6 rounded-lg bg-gradient-to-br from-indigo-100 to-blue-100 hover:from-indigo-200 hover:to-blue-200 transition-all duration-300 cursor-pointer" id="connect-apple">
                                            <i class="fab fa-apple text-4xl text-gray-800 mb-4"></i>
                                            <h3 class="font-semibold text-gray-800 mb-2">Apple Health</h3>
                                            <p class="text-sm text-gray-600">Heart rate, sleep, activity</p>
                                        </div>
                                        <div class="p-6 rounded-lg bg-gradient-to-br from-green-100 to-emerald-100 hover:from-green-200 hover:to-emerald-200 transition-all duration-300 cursor-pointer" id="connect-fitbit">
                                            <i class="fas fa-heartbeat text-4xl text-green-600 mb-4"></i>
                                            <h3 class="font-semibold text-gray-800 mb-2">Fitbit</h3>
                                            <p class="text-sm text-gray-600">Comprehensive wellness data</p>
                                        </div>
                                        <div class="p-6 rounded-lg bg-gradient-to-br from-blue-100 to-cyan-100 hover:from-blue-200 hover:to-cyan-200 transition-all duration-300 cursor-pointer" id="connect-garmin">
                                            <i class="fas fa-running text-4xl text-blue-600 mb-4"></i>
                                            <h3 class="font-semibold text-gray-800 mb-2">Garmin</h3>
                                            <p class="text-sm text-gray-600">Advanced biometrics</p>
                                        </div>
                                    </div>
                                    
                                    <p class="text-sm text-gray-500 mb-8">
                                        Don't worry - you can always connect these later in your sanctuary.
                                    </p>
                                    
                                    <div class="flex justify-center gap-4" style="animation-delay: 3s; opacity: 0; animation: weaverReveal 1s ease-out 3s forwards;">
                                        <button id="skip-wearables" class="kairos-btn bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-semibold hover:bg-gray-300">
                                            Continue Without Devices
                                        </button>
                                        <button id="continue-wearables" class="kairos-btn kairos-btn-primary px-8 py-3 rounded-lg font-semibold">
                                            Perfect. Continue Weaving.
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                case 'archetype-discovery':
                    if (!state.enneagramStep) state.enneagramStep = 0;
                    if (state.enneagramStep === 'complete') {
                        return renderCoreLight();
                    }
                    return renderEnneagramCard();
                    
                default:
                    return '<div>Onboarding step not found</div>';
            }
        }

        function RegisterPage() {
            return `
                <!-- The Descent Background - Living Inner Cosmos -->
                <div class="descent-background"></div>
                <div class="particles" id="particles-container"></div>
                
                <div class="threshold-container" style="
                    min-height: 100vh;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    padding: 2rem;
                    position: relative;
                ">
                    
                    <!-- Breathing Kairos Logo -->
                    <div class="logo-container" style="
                        text-align: center;
                        margin-bottom: 3rem;
                        animation: logoEntrance 2s ease-out 0.5s both;
                    ">
                        <h1 style="
                            font-family: 'Playfair Display', serif;
                            font-size: 4rem;
                            font-weight: 600;
                            margin-bottom: 1rem;
                            background: linear-gradient(135deg, 
                                var(--deep-indigo) 0%, 
                                var(--soft-rose-quartz) 50%, 
                                var(--shimmering-gold) 100%);
                            -webkit-background-clip: text;
                            -webkit-text-fill-color: transparent;
                            text-shadow: 0 0 40px rgba(72, 61, 139, 0.6);
                            filter: drop-shadow(0 2px 8px rgba(212, 175, 55, 0.3));
                            animation: logoBreathing 4s ease-in-out infinite;
                        ">Kairos</h1>
                        
                        <p style="
                            font-family: 'Playfair Display', serif;
                            font-size: 1.25rem;
                            font-weight: 400;
                            color: var(--warm-off-white);
                            opacity: 0.9;
                            letter-spacing: 1px;
                            text-shadow: 0 1px 3px rgba(72, 61, 139, 0.3);
                        ">Begin your journey</p>
                    </div>
                    
                    <!-- Sacred Registration Form -->
                    <div class="threshold-form" style="
                        width: 100%;
                        max-width: 400px;
                        opacity: 0;
                        animation: formEntrance 1.5s ease-out 2.5s both;
                    ">
                        <form id="register-form" style="
                            display: flex;
                            flex-direction: column;
                            gap: 2rem;
                        ">
                            <div class="input-sanctuary">
                                <input 
                                    type="email" 
                                    id="email" 
                                    name="email" 
                                    placeholder="Email address"
                                    class="kairos-input"
                                    required
                                >
                            </div>
                            
                            <div class="input-sanctuary">
                                <input 
                                    type="password" 
                                    id="password" 
                                    name="password" 
                                    placeholder="Create password"
                                    class="kairos-input"
                                    required
                                >
                            </div>
                            
                            <div class="input-sanctuary">
                                <input 
                                    type="password" 
                                    id="confirm-password" 
                                    name="confirm-password" 
                                    placeholder="Confirm password"
                                    class="kairos-input"
                                    required
                                >
                            </div>
                            
                            <button 
                                type="submit" 
                                class="threshold-btn"
                                style="
                                    background: linear-gradient(135deg, 
                                        var(--shimmering-gold) 0%, 
                                        var(--soft-rose-quartz) 50%, 
                                        var(--deep-indigo) 100%);
                                    border: none;
                                    border-radius: 16px;
                                    padding: 1.25rem 3rem;
                                    font-family: 'Inter', sans-serif;
                                    font-size: 1.1rem;
                                    font-weight: 600;
                                    letter-spacing: 0.5px;
                                    color: var(--warm-off-white);
                                    cursor: pointer;
                                    transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                                    text-transform: uppercase;
                                    box-shadow: 
                                        0 8px 25px rgba(212, 175, 55, 0.3),
                                        0 0 20px rgba(72, 61, 139, 0.2),
                                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
                                "
                                ${state.isLoading ? 'disabled' : ''}
                            >
                                ${state.isLoading ? 
                                    '<div style="display: inline-flex; align-items: center; gap: 0.75rem;"><div class="sacred-loader"></div>Creating Sanctuary...</div>' : 
                                    'Create Your Sanctuary'
                                }
                            </button>
                            
                            ${state.authError ? `
                                <p style="
                                    color: var(--soft-rose-quartz);
                                    font-size: 0.9rem;
                                    text-align: center;
                                    margin-top: 1rem;
                                    padding: 0.75rem;
                                    background: rgba(182, 149, 192, 0.1);
                                    border: 1px solid rgba(182, 149, 192, 0.2);
                                    border-radius: 8px;
                                    backdrop-filter: blur(10px);
                                ">${state.authError}</p>
                            ` : ''}
                        </form>
                        
                        <div style="
                            text-align: center;
                            margin-top: 2rem;
                            opacity: 0;
                            animation: linkEntrance 1s ease-out 3.5s both;
                        ">
                            <p style="
                                font-family: 'Inter', sans-serif;
                                color: rgba(255, 255, 255, 0.7);
                                font-size: 0.95rem;
                            ">Already have a sanctuary? 
                                <a href="#" id="go-to-login" style="
                                    color: var(--shimmering-gold);
                                    font-weight: 600;
                                    text-decoration: none;
                                    transition: all 0.3s ease;
                                    text-shadow: 0 1px 3px rgba(212, 175, 55, 0.3);
                                " onmouseover="this.style.textShadow='0 2px 8px rgba(212,175,55,0.6)'" onmouseout="this.style.textShadow='0 1px 3px rgba(212,175,55,0.3)'">Enter here</a>
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        function DashboardPage() {
            const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
            
            // Analyze recent entries for presence level and emotional tone
            const { presenceLevel, emotionalTone, hasGems, hasCompassion } = analyzeRecentEntries();
            
            const recentEntriesHtml = entries.slice(0, 3).map((entry, index) => `
                <div class="p-4 rounded-lg border border-white/20 hover:border-white/40 transition-all duration-300 hover:scale-[1.02] view-entry-btn cursor-pointer" style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(5px);" data-id="${entry.id}">
                    <h4 class="font-semibold text-base truncate" style="color: var(--warm-off-white); font-family: 'Inter', sans-serif;">${entry.title || 'Untitled Entry'}</h4>
                    <p class="text-sm mt-1" style="color: rgba(255, 255, 255, 0.6);">${new Date(entry.date).toLocaleDateString()}</p>
                    <p class="text-sm mt-2 font-medium" style="color: var(--shimmering-gold);">${entry.type || 'General'}</p>
                </div>
            `).join('');

            return `
                <div class="descent-background"></div>
                <div class="descent-particles" id="descent-particles-container"></div>
                <div class="sanctuary-container" style="animation: containerBreathe 8s ease-in-out infinite;">
                    <!-- Mobile-Responsive Header -->
                    <div style="
                        display: flex;
                        justify-content: space-between;
                        align-items: flex-start;
                        padding: 1rem 2rem;
                        margin-bottom: 2rem;
                    ">
                        <!-- Spacer for centering -->
                        <div style="width: 80px;"></div>
                        
                        <!-- Welcome Text (Mobile Responsive) -->
                        <div class="welcome-section fade-in" style="
                            text-align: center;
                            flex: 1;
                            animation-delay: 0.2s;
                        ">
                            <h1 style="
                                font-family: 'Playfair Display', serif;
                                font-size: clamp(1.8rem, 5vw, 2.5rem);
                                font-weight: 400;
                                color: var(--warm-off-white);
                                opacity: 0.9;
                                margin: 0 0 1rem 0;
                                text-shadow: 0 2px 8px rgba(72, 61, 139, 0.3);
                                line-height: 1.2;
                            ">Welcome back${auth.currentUser?.displayName ? ', ' + auth.currentUser.displayName.split(' ')[0] : ''}</h1>
                            <p style="
                                font-family: 'Inter', sans-serif;
                                font-size: clamp(0.9rem, 3vw, 1.1rem);
                                color: rgba(255, 255, 255, 0.7);
                                margin: 0;
                            ">Enter your sanctuary of presence and reflection</p>
                        </div>
                        
                        <!-- Logout Button -->
                        <button id="logout-btn" class="floating-logout" style="
                            background: rgba(255, 255, 255, 0.1);
                            border: 1px solid rgba(255, 255, 255, 0.2);
                            color: var(--warm-off-white);
                            backdrop-filter: blur(10px);
                            padding: 0.75rem 1rem;
                            border-radius: 12px;
                            font-family: 'Inter', sans-serif;
                            font-weight: 500;
                            transition: all 0.3s ease;
                            z-index: 10;
                            min-width: 80px;
                            white-space: nowrap;
                        " onmouseover="this.style.background='rgba(255,255,255,0.15)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                            <i class="fas fa-sign-out-alt mr-2"></i>Leave
                        </button>
                    </div>


                    <!-- The Central Presence Orb -->
                    <div class="orb-section fade-in" style="
                        display: flex;
                        justify-content: center;
                        margin: 8rem auto 12rem;
                        animation-delay: 0.4s;
                    ">
                        <div class="presence-orb" id="presence-orb" onclick="showPresenceModal()">
                            <div class="presence-orb-core">
                                <!-- Swirling Light Layers -->
                                <div class="orb-layer orb-swirl-layer"></div>
                                <div class="orb-layer orb-depth-layer"></div>
                                
                                <!-- Emotional Thread Container -->
                                <div class="emotional-threads-container" id="emotional-threads"></div>
                                
                                <!-- Particle System -->
                                <div class="presence-orb-particles" id="orb-particles"></div>
                            </div>
                        </div>
                    </div>

                    <!-- The Primary Invitation: Journaling Prompt -->
                    <div class="invitation-section fade-in" style="
                        max-width: 600px;
                        margin: 0 auto 8rem;
                        padding: 0 2rem;
                        animation-delay: 0.6s;
                    ">
                        <div class="journaling-prompt-card" id="primary-prompt">
                            <div class="text-center">
                                <h2 class="heading-serif text-2xl font-semibold mb-4" style="color: var(--warm-off-white); text-shadow: 0 2px 8px rgba(72, 61, 139, 0.3);">Today's Invitation</h2>
                                <p class="text-lg mb-6 italic" style="color: rgba(255, 255, 255, 0.9); text-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);">"${randomQuote}"</p>
                                
                                <!-- Dual Path Options -->
                                <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
                                    <button id="quick-reflect-btn" class="kairos-btn kairos-btn-primary px-6 py-3 rounded-lg text-lg font-semibold" style="
                                        background: linear-gradient(135deg, 
                                            var(--shimmering-gold) 0%, 
                                            var(--soft-rose-quartz) 50%, 
                                            var(--deep-indigo) 100%);
                                        border: none;
                                        min-width: 200px;
                                    ">
                                        <i class="fas fa-feather mr-2"></i>Quick Reflection
                                    </button>
                                    
                                    <span style="color: rgba(255, 255, 255, 0.6); font-family: 'Inter', sans-serif; font-size: 0.9rem;">or</span>
                                    
                                    <button id="start-new-entry-btn" class="kairos-btn border px-6 py-3 rounded-lg text-lg font-semibold" style="
                                        background: rgba(255, 255, 255, 0.1);
                                        border-color: rgba(255, 255, 255, 0.3);
                                        color: var(--warm-off-white);
                                        backdrop-filter: blur(15px);
                                        min-width: 200px;
                                        transition: all 0.3s ease;
                                    " onmouseover="this.style.background='rgba(255,255,255,0.15)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                                        <i class="fas fa-compass mr-2"></i>Guided Journey
                                    </button>
                                </div>
                                
                                <p class="text-sm mt-4" style="color: rgba(255, 255, 255, 0.6); font-family: 'Inter', sans-serif; max-width: 400px; margin: 1rem auto 0;">
                                    Start with a quick reflection or dive deep with our guided experience
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Floating Secondary Actions -->
                    <div class="secondary-actions fade-in" style="
                        display: flex;
                        justify-content: center;
                        gap: 2rem;
                        margin-bottom: 6rem;
                        animation-delay: 0.8s;
                        flex-wrap: wrap;
                        padding: 0 2rem;
                    ">
                        <button id="go-to-synthesis-btn" class="kairos-btn border px-6 py-3 rounded-lg font-medium transition-all" style="background: rgba(255, 255, 255, 0.08); border-color: rgba(255, 255, 255, 0.15); color: var(--warm-off-white); backdrop-filter: blur(15px); font-family: 'Inter', sans-serif;" onmouseover="this.style.background='rgba(255,255,255,0.15)'" onmouseout="this.style.background='rgba(255,255,255,0.08)'">
                            <i class="fas fa-project-diagram mr-2"></i>Synthesis
                        </button>
                        <button id="go-to-advisor-btn" class="kairos-btn border px-6 py-3 rounded-lg font-medium transition-all" style="background: rgba(255, 255, 255, 0.08); border-color: rgba(255, 255, 255, 0.15); color: var(--warm-off-white); backdrop-filter: blur(15px); font-family: 'Inter', sans-serif;" onmouseover="this.style.background='rgba(255,255,255,0.15)'" onmouseout="this.style.background='rgba(255,255,255,0.08)'">
                            <i class="fas fa-user-graduate mr-2"></i>Advisor
                        </button>
                        ${entries.length > 0 ? `<button id="view-entries-btn" class="kairos-btn border px-6 py-3 rounded-lg font-medium transition-all" style="background: rgba(255, 255, 255, 0.08); border-color: rgba(255, 255, 255, 0.15); color: var(--warm-off-white); backdrop-filter: blur(15px); font-family: 'Inter', sans-serif;" onmouseover="this.style.background='rgba(255,255,255,0.15)'" onmouseout="this.style.background='rgba(255,255,255,0.08)'">
                            <i class="fas fa-book-open mr-2"></i>Recent Entries
                        </button>` : ''}
                    </div>

                    <!-- Recent Entries Section -->
                    ${entries.length > 0 ? `
                    <div id="recent-entries-section" style="display: none; max-width: 800px; margin: 2rem auto 0; padding: 0 2rem;">
                        <div class="fade-in" style="animation-delay: 0.8s;">
                            <h3 style="
                                font-family: 'Playfair Display', serif;
                                font-size: 1.5rem;
                                font-weight: 500;
                                color: var(--warm-off-white);
                                text-align: center;
                                margin-bottom: 2rem;
                                text-shadow: 0 2px 8px rgba(72, 61, 139, 0.3);
                            ">Your Recent Reflections</h3>
                            
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                ${recentEntriesHtml}
                            </div>
                        </div>
                    </div>` : ''}

                </div>
            `;
        }

        function GatewayChoicePage() {
            return `
                <div class="descent-background"></div>
                <div class="descent-particles" id="descent-particles-container"></div>
                
                <div class="threshold-container" style="
                    min-height: 100vh;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    padding: 2rem;
                    position: relative;
                ">
                    <!-- Back Button -->
                    <button id="back-to-dashboard" style="
                        position: absolute;
                        top: 2rem;
                        left: 2rem;
                        background: rgba(255, 255, 255, 0.1);
                        backdrop-filter: blur(10px);
                        border: 1px solid rgba(255, 255, 255, 0.2);
                        border-radius: 12px;
                        padding: 0.75rem;
                        color: var(--warm-off-white);
                        cursor: pointer;
                        transition: all 0.3s ease;
                        font-family: 'Inter', sans-serif;
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                    " onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                        <i class="fas fa-arrow-left"></i>
                        Dashboard
                    </button>
                    
                    <div class="kairos-card p-12 rounded-xl max-w-4xl w-full text-center">
                        <div class="weaver-text" style="animation-delay: 0.5s;">
                            <h1 style="
                                font-family: 'Playfair Display', serif;
                                font-size: 3rem;
                                font-weight: 600;
                                margin-bottom: 2rem;
                                color: var(--warm-off-white);
                                text-shadow: 
                                    0 2px 8px rgba(72, 61, 139, 0.8),
                                    0 0 20px rgba(212, 175, 55, 0.3);
                            ">How would you like to begin?</h1>
                            
                            <p style="
                                font-family: 'Inter', sans-serif;
                                font-size: 1.25rem;
                                color: var(--warm-off-white);
                                opacity: 0.8;
                                margin-bottom: 4rem;
                                line-height: 1.6;
                            ">Choose your preferred way of expressing what's present for you now.</p>
                        </div>

                        <!-- Gateway Choice Options -->
                        <div class="flex justify-center gap-16 mt-8 gateway-choice-container">
                            <!-- Speak Option -->
                            <div class="gateway-option speak-option" id="speak-option" style="
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                                cursor: pointer;
                                transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                                transform: scale(1);
                            ">
                                <div class="gateway-icon" style="
                                    width: 120px;
                                    height: 120px;
                                    border-radius: 50%;
                                    background: rgba(255, 255, 255, 0.1);
                                    backdrop-filter: blur(10px);
                                    border: 2px solid rgba(255, 255, 255, 0.2);
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    margin-bottom: 1.5rem;
                                    transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                                    position: relative;
                                    overflow: hidden;
                                ">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" style="
                                        color: var(--warm-off-white);
                                        transition: all 0.3s ease;
                                    ">
                                        <path d="M12 1C10.62 1 9.5 2.12 9.5 3.5V12.5C9.5 13.88 10.62 15 12 15S14.5 13.88 14.5 12.5V3.5C14.5 2.12 13.38 1 12 1Z" fill="currentColor"/>
                                        <path d="M19 10V12C19 16.42 15.42 20 11 20H9V22H15C19.42 22 23 18.42 23 14V10H19ZM5 10V12C5 16.42 8.58 20 13 20H15V22H9C4.58 22 1 18.42 1 14V10H5Z" fill="currentColor" opacity="0.7"/>
                                    </svg>
                                    <div class="gateway-glow" style="
                                        position: absolute;
                                        top: -50%;
                                        left: -50%;
                                        width: 200%;
                                        height: 200%;
                                        background: radial-gradient(circle, var(--soft-rose-quartz) 0%, transparent 70%);
                                        opacity: 0;
                                        transition: opacity 0.5s ease;
                                        pointer-events: none;
                                    "></div>
                                </div>
                                <span class="gateway-label" style="
                                    font-family: 'Inter', sans-serif;
                                    font-size: 1.25rem;
                                    font-weight: 500;
                                    color: var(--warm-off-white);
                                    opacity: 0;
                                    transform: translateY(10px);
                                    transition: all 0.3s ease;
                                ">Speak</span>
                            </div>

                            <!-- Write Option -->
                            <div class="gateway-option write-option" id="write-option" style="
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                                cursor: pointer;
                                transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                                transform: scale(1);
                            ">
                                <div class="gateway-icon" style="
                                    width: 120px;
                                    height: 120px;
                                    border-radius: 50%;
                                    background: rgba(255, 255, 255, 0.1);
                                    backdrop-filter: blur(10px);
                                    border: 2px solid rgba(255, 255, 255, 0.2);
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    margin-bottom: 1.5rem;
                                    transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                                    position: relative;
                                    overflow: hidden;
                                ">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" style="
                                        color: var(--warm-off-white);
                                        transition: all 0.3s ease;
                                    ">
                                        <path d="M3 17.25V21H6.75L17.81 9.94L14.06 6.19L3 17.25ZM20.71 7.04C21.1 6.65 21.1 6.02 20.71 5.63L18.37 3.29C17.98 2.9 17.35 2.9 16.96 3.29L15.13 5.12L18.88 8.87L20.71 7.04Z" fill="currentColor"/>
                                    </svg>
                                    <div class="gateway-glow" style="
                                        position: absolute;
                                        top: -50%;
                                        left: -50%;
                                        width: 200%;
                                        height: 200%;
                                        background: radial-gradient(circle, var(--deep-indigo) 0%, transparent 70%);
                                        opacity: 0;
                                        transition: opacity 0.5s ease;
                                        pointer-events: none;
                                    "></div>
                                </div>
                                <span class="gateway-label" style="
                                    font-family: 'Inter', sans-serif;
                                    font-size: 1.25rem;
                                    font-weight: 500;
                                    color: var(--warm-off-white);
                                    opacity: 0;
                                    transform: translateY(10px);
                                    transition: all 0.3s ease;
                                ">Write</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function TextJournalingPage() {
            return `
                <div class="descent-background"></div>
                <div class="descent-particles" id="descent-particles-container"></div>
                
                <div class="threshold-container" style="
                    min-height: 100vh;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: flex-start;
                    padding: 2rem;
                    position: relative;
                ">
                    <!-- Back Button -->
                    <button id="back-to-gateway" style="
                        position: absolute;
                        top: 2rem;
                        left: 2rem;
                        background: rgba(255, 255, 255, 0.1);
                        backdrop-filter: blur(10px);
                        border: 1px solid rgba(255, 255, 255, 0.2);
                        border-radius: 12px;
                        padding: 0.75rem;
                        color: var(--warm-off-white);
                        cursor: pointer;
                        transition: all 0.3s ease;
                        font-family: 'Inter', sans-serif;
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                    " onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                        <i class="fas fa-arrow-left"></i>
                        Back
                    </button>
                    
                    <div class="kairos-card rounded-xl max-w-4xl w-full" style="margin-top: 4rem; padding: 3rem;">
                        <div class="text-center mb-8">
                            <h1 style="
                                font-family: 'Playfair Display', serif;
                                font-size: 2.5rem;
                                font-weight: 600;
                                margin-bottom: 1rem;
                                color: var(--warm-off-white);
                                text-shadow: 
                                    0 2px 8px rgba(72, 61, 139, 0.8),
                                    0 0 20px rgba(212, 175, 55, 0.3);
                            ">The Scribe - Text</h1>
                            
                            <p style="
                                font-family: 'Inter', sans-serif;
                                font-size: 1.1rem;
                                color: var(--warm-off-white);
                                opacity: 0.8;
                                line-height: 1.6;
                            ">Express your thoughts and feelings through writing</p>
                        </div>

                        <form id="text-journal-form">
                            <!-- Title Input -->
                            <div class="mb-6">
                                <label style="
                                    font-family: 'Inter', sans-serif;
                                    font-size: 1rem;
                                    font-weight: 500;
                                    color: var(--warm-off-white);
                                    opacity: 0.9;
                                    display: block;
                                    margin-bottom: 0.75rem;
                                ">Entry Title</label>
                                <input 
                                    type="text" 
                                    id="entry-title" 
                                    name="title"
                                    placeholder="What would you like to call this reflection?"
                                    required
                                    style="
                                        width: 100%;
                                        padding: 1rem;
                                        background: rgba(255, 255, 255, 0.1);
                                        border: 1px solid rgba(255, 255, 255, 0.2);
                                        border-radius: 12px;
                                        color: var(--warm-off-white);
                                        font-family: 'Inter', sans-serif;
                                        font-size: 1rem;
                                        backdrop-filter: blur(10px);
                                        transition: all 0.3s ease;
                                    "
                                    onfocus="this.style.borderColor='rgba(212, 175, 55, 0.5)'; this.style.boxShadow='0 0 20px rgba(212, 175, 55, 0.2)'"
                                    onblur="this.style.borderColor='rgba(255, 255, 255, 0.2)'; this.style.boxShadow='none'"
                                />
                            </div>

                            <!-- Thoughts Textarea -->
                            <div class="mb-6">
                                <label style="
                                    font-family: 'Inter', sans-serif;
                                    font-size: 1rem;
                                    font-weight: 500;
                                    color: var(--warm-off-white);
                                    opacity: 0.9;
                                    display: block;
                                    margin-bottom: 0.75rem;
                                ">Your Thoughts & Feelings</label>
                                <textarea 
                                    id="entry-content" 
                                    name="content"
                                    placeholder="What's present for you right now? Share whatever feels important - your experiences, emotions, insights, or anything that's on your mind..."
                                    required
                                    rows="8"
                                    style="
                                        width: 100%;
                                        padding: 1.5rem;
                                        background: rgba(255, 255, 255, 0.1);
                                        border: 1px solid rgba(255, 255, 255, 0.2);
                                        border-radius: 12px;
                                        color: var(--warm-off-white);
                                        font-family: 'Inter', sans-serif;
                                        font-size: 1rem;
                                        line-height: 1.6;
                                        backdrop-filter: blur(10px);
                                        transition: all 0.3s ease;
                                        resize: vertical;
                                        min-height: 200px;
                                    "
                                    onfocus="this.style.borderColor='rgba(212, 175, 55, 0.5)'; this.style.boxShadow='0 0 20px rgba(212, 175, 55, 0.2)'"
                                    onblur="this.style.borderColor='rgba(255, 255, 255, 0.2)'; this.style.boxShadow='none'"
                                ></textarea>
                            </div>

                            <!-- Somatic Awareness Section -->
                            <div class="mb-8">
                                <label style="
                                    font-family: 'Inter', sans-serif;
                                    font-size: 1rem;
                                    font-weight: 500;
                                    color: var(--warm-off-white);
                                    opacity: 0.9;
                                    display: block;
                                    margin-bottom: 0.75rem;
                                ">Where do you feel this in your body? <span style="opacity: 0.7; font-weight: 400;">(Optional)</span></label>
                                
                                <div style="
                                    background: rgba(255, 255, 255, 0.05);
                                    border: 1px solid rgba(255, 255, 255, 0.1);
                                    border-radius: 12px;
                                    padding: 1.5rem;
                                    backdrop-filter: blur(10px);
                                ">
                                    <p style="
                                        font-family: 'Inter', sans-serif;
                                        font-size: 0.9rem;
                                        color: var(--warm-off-white);
                                        opacity: 0.7;
                                        margin-bottom: 1rem;
                                        text-align: center;
                                    ">Click on body areas where you notice sensations</p>
                                    
                                    <!-- Simple Body Map -->
                                    <div style="display: flex; justify-content: center; margin-bottom: 1rem;">
                                        <svg width="200" height="300" viewBox="0 0 200 300" style="cursor: pointer;">
                                            <!-- Head -->
                                            <ellipse cx="100" cy="40" rx="30" ry="35" fill="rgba(255,255,255,0.1)" stroke="rgba(255,255,255,0.3)" stroke-width="2" class="body-part" data-part="head"/>
                                            
                                            <!-- Torso -->
                                            <rect x="70" y="70" width="60" height="80" rx="15" fill="rgba(255,255,255,0.1)" stroke="rgba(255,255,255,0.3)" stroke-width="2" class="body-part" data-part="chest"/>
                                            <rect x="70" y="150" width="60" height="60" rx="15" fill="rgba(255,255,255,0.1)" stroke="rgba(255,255,255,0.3)" stroke-width="2" class="body-part" data-part="stomach"/>
                                            
                                            <!-- Arms -->
                                            <rect x="30" y="80" width="35" height="70" rx="17" fill="rgba(255,255,255,0.1)" stroke="rgba(255,255,255,0.3)" stroke-width="2" class="body-part" data-part="left-arm"/>
                                            <rect x="135" y="80" width="35" height="70" rx="17" fill="rgba(255,255,255,0.1)" stroke="rgba(255,255,255,0.3)" stroke-width="2" class="body-part" data-part="right-arm"/>
                                            
                                            <!-- Legs -->
                                            <rect x="75" y="215" width="20" height="80" rx="10" fill="rgba(255,255,255,0.1)" stroke="rgba(255,255,255,0.3)" stroke-width="2" class="body-part" data-part="left-leg"/>
                                            <rect x="105" y="215" width="20" height="80" rx="10" fill="rgba(255,255,255,0.1)" stroke="rgba(255,255,255,0.3)" stroke-width="2" class="body-part" data-part="right-leg"/>
                                        </svg>
                                    </div>
                                    
                                    <!-- Selected sensations display -->
                                    <div id="selected-sensations" style="
                                        min-height: 50px;
                                        padding: 1rem;
                                        background: rgba(255, 255, 255, 0.05);
                                        border-radius: 8px;
                                        border: 1px solid rgba(255, 255, 255, 0.1);
                                    ">
                                        <p style="
                                            font-family: 'Inter', sans-serif;
                                            font-size: 0.9rem;
                                            color: var(--warm-off-white);
                                            opacity: 0.7;
                                            text-align: center;
                                            margin: 0;
                                        ">Selected body sensations will appear here</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Submit Button -->
                            <div class="text-center">
                                <button 
                                    type="submit" 
                                    id="submit-entry-btn"
                                    style="
                                        background: linear-gradient(135deg, 
                                            var(--shimmering-gold) 0%, 
                                            var(--soft-rose-quartz) 50%, 
                                            var(--deep-indigo) 100%);
                                        border: none;
                                        padding: 1rem 3rem;
                                        border-radius: 12px;
                                        color: white;
                                        font-family: 'Inter', sans-serif;
                                        font-size: 1.1rem;
                                        font-weight: 600;
                                        cursor: pointer;
                                        transition: all 0.3s ease;
                                        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
                                    "
                                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(212, 175, 55, 0.4)'"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
                                >
                                    Save Reflection
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function VoiceJournalingPage() {
            return `
                <div class="descent-background"></div>
                <div class="descent-particles" id="descent-particles-container"></div>
                
                <div class="threshold-container" style="
                    min-height: 100vh;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    padding: 2rem;
                    position: relative;
                ">
                    <!-- Back Button -->
                    <button id="back-to-gateway" style="
                        position: absolute;
                        top: 2rem;
                        left: 2rem;
                        background: rgba(255, 255, 255, 0.1);
                        backdrop-filter: blur(10px);
                        border: 1px solid rgba(255, 255, 255, 0.2);
                        border-radius: 12px;
                        padding: 0.75rem;
                        color: var(--warm-off-white);
                        cursor: pointer;
                        transition: all 0.3s ease;
                        font-family: 'Inter', sans-serif;
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                    " onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                        <i class="fas fa-arrow-left"></i>
                        Back
                    </button>
                    
                    <div class="kairos-card p-12 rounded-xl max-w-4xl w-full text-center">
                        <div class="weaver-text" style="animation-delay: 0.5s;">
                            <h1 style="
                                font-family: 'Playfair Display', serif;
                                font-size: 3rem;
                                font-weight: 600;
                                margin-bottom: 2rem;
                                color: var(--warm-off-white);
                                text-shadow: 
                                    0 2px 8px rgba(72, 61, 139, 0.8),
                                    0 0 20px rgba(212, 175, 55, 0.3);
                            ">The Scribe - Voice</h1>
                            
                            <p style="
                                font-family: 'Inter', sans-serif;
                                font-size: 1.25rem;
                                color: var(--warm-off-white);
                                opacity: 0.8;
                                margin-bottom: 4rem;
                                line-height: 1.6;
                            ">Coming Soon - Voice journaling with AI agent integration</p>
                        </div>

                        <!-- Placeholder for voice interface -->
                        <div style="
                            background: rgba(255, 255, 255, 0.05);
                            border: 2px dashed rgba(255, 255, 255, 0.2);
                            border-radius: 16px;
                            padding: 4rem 2rem;
                            margin: 2rem 0;
                        ">
                            <div style="
                                width: 120px;
                                height: 120px;
                                border-radius: 50%;
                                background: rgba(182, 149, 192, 0.2);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                margin: 0 auto 2rem;
                                border: 2px dashed var(--soft-rose-quartz);
                            ">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" style="color: var(--soft-rose-quartz);">
                                    <path d="M12 1C10.62 1 9.5 2.12 9.5 3.5V12.5C9.5 13.88 10.62 15 12 15S14.5 13.88 14.5 12.5V3.5C14.5 2.12 13.38 1 12 1Z" fill="currentColor"/>
                                    <path d="M19 10V12C19 16.42 15.42 20 11 20H9V22H15C19.42 22 23 18.42 23 14V10H19ZM5 10V12C5 16.42 8.58 20 13 20H15V22H9C4.58 22 1 18.42 1 14V10H5Z" fill="currentColor" opacity="0.7"/>
                                </svg>
                            </div>
                            <p style="
                                font-family: 'Inter', sans-serif;
                                font-size: 1.1rem;
                                color: var(--warm-off-white);
                                opacity: 0.7;
                                margin: 0;
                            ">Voice journaling agent will be implemented here<br/>
                            <small style="opacity: 0.6;">Real-time transcription  Emotional tone analysis  Interactive dialogue</small></p>
                        </div>
                    </div>
                </div>
            `;
        }

        function SynthesisPage() {
            const { score, ripples } = calculateEquanimity();
            const { isLoading, content, error } = state.synthesis;
            
            let themesHtml = '';
            if (isLoading) {
                themesHtml = `<div class="flex justify-center items-center p-6"><div class="loader"></div><p class="ml-4 text-gray-600">Synthesizing patterns...</p></div>`;
            } else if (error) {
                themesHtml = `<div class="text-center p-6 bg-red-50 border border-red-200 rounded-lg"><p class="text-red-600">${error}</p></div>`;
            } else if (content) {
                if (content.guidance) {
                     themesHtml = `<div class="text-center p-6 bg-blue-50 border border-blue-200 rounded-lg"><p class="text-blue-700">${content.guidance}</p></div>`;
                } else {
                    themesHtml = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h3 class="font-semibold text-lg mb-2 text-red-700"><i class="fas fa-magnet mr-2"></i>Aversion Themes</h3>
                                <ul class="list-disc list-inside text-gray-700 space-y-1">${content.aversionThemes.map(t => `<li>${t}</li>`).join('') || '<li>No strong aversion themes detected.</li>'}</ul>
                            </div>
                            <div>
                                <h3 class="font-semibold text-lg mb-2 text-green-700"><i class="fas fa-feather mr-2"></i>Craving Themes</h3>
                                <ul class="list-disc list-inside text-gray-700 space-y-1">${content.cravingThemes.map(t => `<li>${t}</li>`).join('') || '<li>No strong craving themes detected.</li>'}</ul>
                            </div>
                        </div>
                    `;
                }
            }

            return `
                <div class="container mx-auto p-4 md:p-8 max-w-5xl fade-in">
                    <header class="flex justify-between items-center mb-12">
                        <div>
                           <h1 class="text-5xl font-bold text-gray-800">Sankara Synthesis</h1>
                           <p class="text-xl text-gray-600 mt-3">Making the unconscious conscious.</p>
                        </div>
                        <button id="back-to-dashboard" class="kairos-btn bg-white/80 border px-6 py-3 rounded-lg font-semibold hover:bg-white"><i class="fas fa-arrow-left mr-2"></i>Dashboard</button>
                    </header>

                    <div class="grid lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1">
                            <div class="kairos-card p-6 rounded-xl shadow-lg text-center">
                                <h2 class="text-2xl font-bold mb-4">Equanimity Index</h2>
                                <div id="equanimity-pool" class="w-48 h-48 mx-auto rounded-full flex items-center justify-center overflow-hidden" style="background: radial-gradient(circle, #a5f3fc, #0c4a6e);">
                                    <div class="w-full h-full bg-black/20" style="backdrop-filter: blur(${ripples}px) brightness(1.2)"></div>
                                </div>
                                <p class="mt-4 text-lg font-semibold">${score}% Stillness</p>
                                <p class="text-sm text-gray-600">Reflects your capacity for non-reactive awareness in recent entries.</p>
                            </div>
                        </div>
                        <div class="lg:col-span-2">
                             <div class="kairos-card p-6 rounded-xl shadow-lg mb-8">
                                <h2 class="text-2xl font-bold mb-4">Aversion & Craving Patterns</h2>
                                ${themesHtml}
                            </div>
                            <div class="kairos-card p-6 rounded-xl shadow-lg">
                                <h2 class="text-2xl font-bold mb-4">Trigger Constellations</h2>
                                <p class="text-gray-600 mb-4">Select a recent entry to visualize its pattern.</p>
                                <div id="entry-selector-for-constellation" class="flex flex-col gap-2">
                                    ${entries.slice(0,5).map(entry => `<button class="constellation-btn text-left p-3 bg-gray-100 rounded-lg hover:bg-indigo-100" data-id="${entry.id}">${entry.title || 'Untitled Entry'}</button>`).join('')}
                                </div>
                                <div id="constellation-display" class="mt-6"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function AdvisorPage() {
            const { isLoading, content, error } = state.advisor;

            let advisorContentHtml = '';
            if (isLoading) {
                advisorContentHtml = `<div class="flex justify-center items-center p-10"><div class="loader"></div><p class="ml-4 text-gray-600">Your Advisor is reflecting...</p></div>`;
            } else if (error) {
                advisorContentHtml = `<div class="text-center p-10 bg-red-50 border border-red-200 rounded-lg"><p class="text-red-700 font-semibold">An error occurred.</p><p class="text-red-600 mt-2">${error}</p></div>`;
            } else if (content) {
                if (content.guidance) {
                    advisorContentHtml = `
                        <div class="kairos-card p-6 rounded-xl shadow-lg text-center">
                            <h2 class="text-2xl font-bold mb-4" style="color: var(--deep-indigo);">A Path to Deeper Insight</h2>
                            <p class="text-lg text-gray-700">${content.guidance}</p>
                            <button id="start-guided-entry-btn" class="kairos-btn kairos-btn-primary mt-6 px-6 py-2 rounded-lg font-semibold">Begin a New Entry</button>
                        </div>
                    `;
                } else {
                    advisorContentHtml = `
                        <div class="space-y-8">
                            <!-- Compassionate Truth -->
                            <div class="kairos-card p-6 rounded-xl shadow-lg">
                                <h2 class="text-2xl font-bold mb-4" style="color: var(--deep-indigo);">The Compassionate Truth</h2>
                                <p class="text-lg text-gray-700">${content.truth}</p>
                            </div>
                            <!-- Integration Plan -->
                            <div class="kairos-card p-6 rounded-xl shadow-lg">
                                <h2 class="text-2xl font-bold mb-4" style="color: var(--deep-indigo);">The Integration Plan</h2>
                                <div class="grid md:grid-cols-2 gap-6">
                                    <div>
                                        <h3 class="font-semibold text-xl mb-2"><i class="fas fa-leaf mr-2 text-green-600"></i>Inner Work</h3>
                                        <p class="text-gray-700">${content.plan.inner}</p>
                                    </div>
                                    <div>
                                        <h3 class="font-semibold text-xl mb-2"><i class="fas fa-shoe-prints mr-2 text-yellow-600"></i>Outer Action</h3>
                                        <p class="text-gray-700">${content.plan.outer}</p>
                                    </div>
                                </div>
                            </div>
                            <!-- Evolutionary Challenge -->
                            <div class="kairos-card p-6 rounded-xl shadow-lg bg-gray-800 ">
                                <h2 class="text-2xl font-bold mb-4 text-yellow-400">The Evolutionary Challenge</h2>
                                <p class="text-lg">${content.challenge}</p>
                            </div>
                        </div>
                    `;
                }
            }

            return `
                <div class="container mx-auto p-4 md:p-8 max-w-4xl fade-in">
                     <header class="flex justify-between items-center mb-12">
                        <div>
                           <h1 class="text-5xl font-bold text-gray-800">Kairos Advisor</h1>
                           <p class="text-xl text-gray-600 mt-3">The integrated voice of your Higher Self.</p>
                        </div>
                        <button id="back-to-dashboard" class="kairos-btn bg-white/80 border px-6 py-3 rounded-lg font-semibold hover:bg-white"><i class="fas fa-arrow-left mr-2"></i>Dashboard</button>
                    </header>
                    ${advisorContentHtml}
                </div>
            `;
        }


        function SomaticCheckPage1() { 
            return `
                <div class="descent-background"></div>
                <div class="descent-particles" id="descent-particles-container"></div>
                
                <div class="threshold-container" style="
                    min-height: 100vh;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    padding: 2rem;
                    position: relative;
                ">
                    <div class="kairos-card p-12 rounded-xl max-w-4xl w-full text-center">
                        <div class="weaver-text" style="animation-delay: 0.5s;">
                            <h1 style="
                                font-family: 'Playfair Display', serif;
                                font-size: 3rem;
                                font-weight: 600;
                                margin-bottom: 2rem;
                                color: var(--warm-off-white);
                                text-shadow: 
                                    0 2px 8px rgba(72, 61, 139, 0.8),
                                    0 0 20px rgba(212, 175, 55, 0.3);
                            ">Before we begin, let's connect with your body.</h1>
                            
                            <p style="
                                font-family: 'Inter', sans-serif;
                                font-size: 1.25rem;
                                color: var(--warm-off-white);
                                margin-bottom: 3rem;
                                max-width: 600px;
                                margin-left: auto;
                                margin-right: auto;
                                line-height: 1.6;
                                text-shadow: 0 1px 3px rgba(72, 61, 139, 0.7);
                                font-weight: 400;
                                animation-delay: 1s; 
                                opacity: 0; 
                                animation: weaverReveal 1s ease-out 1s forwards;
                            ">Right now, without needing to change anything, would you say your inner state feels more activated or more settled?</p>
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-8 w-full max-w-4xl mx-auto" style="animation-delay: 2s; opacity: 0; animation: weaverReveal 1s ease-out 2s forwards;">
                            <div class="somatic-option threshold-card p-8 rounded-xl cursor-pointer transition-all duration-300 hover:scale-105" 
                                 data-state="activated"
                                 style="
                                     background: rgba(255, 255, 255, 0.1);
                                     backdrop-filter: blur(10px);
                                     border: 1px solid rgba(212, 175, 55, 0.3);
                                     box-shadow: 0 8px 25px rgba(212, 175, 55, 0.1);
                                 ">
                                <div style="
                                    width: 80px;
                                    height: 80px;
                                    margin: 0 auto 1.5rem;
                                    background: radial-gradient(circle, rgba(212, 175, 55, 0.2) 0%, transparent 70%);
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    animation: sparklingBurst 3.5s ease-in-out infinite;
                                ">
                                    <i class="fas fa-bolt" style="
                                        font-size: 2.5rem;
                                        color: var(--shimmering-gold);
                                        text-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
                                    "></i>
                                </div>
                                <h2 style="
                                    font-family: 'Playfair Display', serif;
                                    font-size: 1.75rem;
                                    font-weight: 600;
                                    color: var(--warm-off-white);
                                    margin-bottom: 1rem;
                                ">Activated</h2>
                                <p style="
                                    font-family: 'Inter', sans-serif;
                                    color: rgba(255, 255, 255, 0.9);
                                    font-size: 1.1rem;
                                    line-height: 1.5;
                                    text-shadow: 0 1px 2px rgba(72, 61, 139, 0.5);
                                ">Restless, tense, racing thoughts, energized.</p>
                            </div>
                            
                            <div class="somatic-option threshold-card p-8 rounded-xl cursor-pointer transition-all duration-300 hover:scale-105" 
                                 data-state="settled"
                                 style="
                                     background: rgba(255, 255, 255, 0.1);
                                     backdrop-filter: blur(10px);
                                     border: 1px solid rgba(182, 149, 192, 0.3);
                                     box-shadow: 0 8px 25px rgba(182, 149, 192, 0.1);
                                 ">
                                <div style="
                                    width: 80px;
                                    height: 80px;
                                    margin: 0 auto 1.5rem;
                                    background: radial-gradient(circle, rgba(182, 149, 192, 0.2) 0%, transparent 70%);
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    animation: warmEmbrace 5s ease-in-out infinite;
                                ">
                                    <i class="fas fa-feather-alt" style="
                                        font-size: 2.5rem;
                                        color: var(--soft-rose-quartz);
                                        text-shadow: 0 0 20px rgba(182, 149, 192, 0.5);
                                    "></i>
                                </div>
                                <h2 style="
                                    font-family: 'Playfair Display', serif;
                                    font-size: 1.75rem;
                                    font-weight: 600;
                                    color: var(--warm-off-white);
                                    margin-bottom: 1rem;
                                ">Settled</h2>
                                <p style="
                                    font-family: 'Inter', sans-serif;
                                    color: rgba(255, 255, 255, 0.9);
                                    font-size: 1.1rem;
                                    line-height: 1.5;
                                    text-shadow: 0 1px 2px rgba(72, 61, 139, 0.5);
                                ">Grounded, calm, relaxed, at ease.</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        function SomaticCheckPage2() { 
            const prompt = state.somaticState === 'activated' ? "It's courageous to acknowledge that energy." : "It's a gift to find moments of peace.";
            return `
                <div class="descent-background"></div>
                <div class="descent-particles" id="descent-particles-container"></div>
                
                <div class="threshold-container" style="
                    min-height: 100vh;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    padding: 2rem;
                    position: relative;
                ">
                    <div class="kairos-card p-12 rounded-xl max-w-4xl w-full text-center">
                        <div class="weaver-text" style="animation-delay: 0.5s;">
                            <p style="
                                font-family: 'Inter', sans-serif;
                                font-size: 1.25rem;
                                color: var(--shimmering-gold);
                                margin-bottom: 2rem;
                                font-weight: 500;
                                text-shadow: 0 1px 3px rgba(212, 175, 55, 0.3);
                            ">${prompt}</p>
                            
                            <h1 style="
                                font-family: 'Playfair Display', serif;
                                font-size: 2.5rem;
                                font-weight: 600;
                                margin-bottom: 3rem;
                                background: linear-gradient(135deg, 
                                    var(--deep-indigo) 0%, 
                                    var(--soft-rose-quartz) 50%, 
                                    var(--shimmering-gold) 100%);
                                -webkit-background-clip: text;
                                -webkit-text-fill-color: transparent;
                                text-shadow: 0 0 40px rgba(72, 61, 139, 0.6);
                                max-width: 800px;
                                margin-left: auto;
                                margin-right: auto;
                                line-height: 1.2;
                                animation-delay: 1s; 
                                opacity: 0; 
                                animation: weaverReveal 1s ease-out 1s forwards;
                            ">What is your capacity to be with this state of ${state.somaticState}ness right now?</h1>
                        </div>
                        
                        <div class="space-y-6 w-full max-w-3xl mx-auto" style="animation-delay: 2s; opacity: 0; animation: weaverReveal 1s ease-out 2s forwards;">
                            <div class="somatic-option threshold-card p-8 rounded-xl cursor-pointer transition-all duration-300 hover:scale-105 text-left" 
                                 data-capacity="deep"
                                 style="
                                     background: rgba(255, 255, 255, 0.1);
                                     backdrop-filter: blur(10px);
                                     border: 1px solid rgba(72, 61, 139, 0.3);
                                     box-shadow: 0 8px 25px rgba(72, 61, 139, 0.1);
                                 ">
                                <div style="display: flex; align-items: center; gap: 1.5rem;">
                                    <div style="
                                        width: 60px;
                                        height: 60px;
                                        background: radial-gradient(circle, rgba(72, 61, 139, 0.2) 0%, transparent 70%);
                                        border-radius: 50%;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        animation: contemplativeLens 7s ease-in-out infinite;
                                        flex-shrink: 0;
                                    ">
                                        <i class="fas fa-seedling" style="
                                            font-size: 1.75rem;
                                            color: var(--deep-indigo);
                                            text-shadow: 0 0 15px rgba(72, 61, 139, 0.5);
                                        "></i>
                                    </div>
                                    <h2 style="
                                        font-family: 'Playfair Display', serif;
                                        font-size: 1.5rem;
                                        font-weight: 600;
                                        color: var(--warm-off-white);
                                        line-height: 1.3;
                                    ">I have the space to explore this deeply.</h2>
                                </div>
                            </div>
                            
                            <div class="somatic-option threshold-card p-8 rounded-xl cursor-pointer transition-all duration-300 hover:scale-105 text-left" 
                                 data-capacity="gentle"
                                 style="
                                     background: rgba(255, 255, 255, 0.1);
                                     backdrop-filter: blur(10px);
                                     border: 1px solid rgba(182, 149, 192, 0.3);
                                     box-shadow: 0 8px 25px rgba(182, 149, 192, 0.1);
                                 ">
                                <div style="display: flex; align-items: center; gap: 1.5rem;">
                                    <div style="
                                        width: 60px;
                                        height: 60px;
                                        background: radial-gradient(circle, rgba(182, 149, 192, 0.2) 0%, transparent 70%);
                                        border-radius: 50%;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        animation: warmEmbrace 5s ease-in-out infinite;
                                        flex-shrink: 0;
                                    ">
                                        <i class="fas fa-eye" style="
                                            font-size: 1.75rem;
                                            color: var(--soft-rose-quartz);
                                            text-shadow: 0 0 15px rgba(182, 149, 192, 0.5);
                                        "></i>
                                    </div>
                                    <h2 style="
                                        font-family: 'Playfair Display', serif;
                                        font-size: 1.5rem;
                                        font-weight: 600;
                                        color: var(--warm-off-white);
                                        line-height: 1.3;
                                    ">I can be with it, but prefer gentle observation.</h2>
                                </div>
                            </div>
                            
                            <div class="somatic-option threshold-card p-8 rounded-xl cursor-pointer transition-all duration-300 hover:scale-105 text-left" 
                                 data-capacity="grounding"
                                 style="
                                     background: rgba(255, 255, 255, 0.1);
                                     backdrop-filter: blur(10px);
                                     border: 1px solid rgba(212, 175, 55, 0.3);
                                     box-shadow: 0 8px 25px rgba(212, 175, 55, 0.1);
                                 ">
                                <div style="display: flex; align-items: center; gap: 1.5rem;">
                                    <div style="
                                        width: 60px;
                                        height: 60px;
                                        background: radial-gradient(circle, rgba(212, 175, 55, 0.2) 0%, transparent 70%);
                                        border-radius: 50%;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        animation: sparklingBurst 3.5s ease-in-out infinite;
                                        flex-shrink: 0;
                                    ">
                                        <i class="fas fa-mountain" style="
                                            font-size: 1.75rem;
                                            color: var(--shimmering-gold);
                                            text-shadow: 0 0 15px rgba(212, 175, 55, 0.5);
                                        "></i>
                                    </div>
                                    <h2 style="
                                        font-family: 'Playfair Display', serif;
                                        font-size: 1.5rem;
                                        font-weight: 600;
                                        color: var(--warm-off-white);
                                        line-height: 1.3;
                                    ">I feel overwhelmed and need to focus on grounding first.</h2>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function ViewEntryPage() { 
            const entry = state.currentEntry;
            if (!entry) {
                return `
                    <div class="descent-background"></div>
                    <div class="descent-particles" id="descent-particles-container"></div>
                    <div class="threshold-container" style="min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 2rem;">
                        <div class="kairos-card p-8 rounded-xl text-center">
                            <h2 style="color: var(--warm-off-white); font-family: 'Playfair Display', serif; font-size: 1.5rem; margin-bottom: 1rem;">Entry not found</h2>
                            <button id="back-to-dashboard" style="
                                background: linear-gradient(135deg, var(--shimmering-gold) 0%, var(--soft-rose-quartz) 100%);
                                border: none;
                                padding: 0.75rem 2rem;
                                border-radius: 12px;
                                color: white;
                                font-family: 'Inter', sans-serif;
                                font-weight: 600;
                                cursor: pointer;
                            ">Back to Dashboard</button>
                        </div>
                    </div>
                `;
            }

            // Helper function to format content based on entry type
            const formatEntryContent = (entry) => {
                if (entry.method === 'write' && entry.content) {
                    // New simple text entries
                    return `
                        <div style="margin-bottom: 2rem;">
                            <h3 style="
                                font-family: 'Playfair Display', serif;
                                font-size: 1.25rem;
                                color: var(--shimmering-gold);
                                margin-bottom: 1rem;
                                opacity: 0.9;
                            ">Reflection</h3>
                            <div style="
                                background: rgba(255, 255, 255, 0.05);
                                border: 1px solid rgba(255, 255, 255, 0.1);
                                border-radius: 12px;
                                padding: 1.5rem;
                                backdrop-filter: blur(10px);
                            ">
                                <p style="
                                    font-family: 'Inter', sans-serif;
                                    font-size: 1rem;
                                    line-height: 1.6;
                                    color: var(--warm-off-white);
                                    margin: 0;
                                    white-space: pre-wrap;
                                ">${entry.content}</p>
                            </div>
                        </div>

                        ${entry.bodySensations && entry.bodySensations.length > 0 ? `
                        <div style="margin-bottom: 2rem;">
                            <h3 style="
                                font-family: 'Playfair Display', serif;
                                font-size: 1.25rem;
                                color: var(--shimmering-gold);
                                margin-bottom: 1rem;
                                opacity: 0.9;
                            ">Body Awareness</h3>
                            <div style="
                                background: rgba(255, 255, 255, 0.05);
                                border: 1px solid rgba(255, 255, 255, 0.1);
                                border-radius: 12px;
                                padding: 1.5rem;
                                backdrop-filter: blur(10px);
                            ">
                                ${entry.bodySensations.map(sensation => `
                                    <div style="
                                        display: inline-block;
                                        background: rgba(212, 175, 55, 0.2);
                                        border: 1px solid rgba(212, 175, 55, 0.3);
                                        border-radius: 8px;
                                        padding: 0.5rem 1rem;
                                        margin: 0.25rem;
                                        font-family: 'Inter', sans-serif;
                                        font-size: 0.9rem;
                                        color: var(--warm-off-white);
                                    ">
                                        ${sensation.part.replace('-', ' ')}: ${sensation.sensation}
                                    </div>
                                `).join('')}
                            </div>
                        </div>` : ''}
                    `;
                } else {
                    // Legacy complex entries - format situation description
                    const description = entry.situation?.description || entry.content || 'No content available';
                    return `
                        <div style="margin-bottom: 2rem;">
                            <h3 style="
                                font-family: 'Playfair Display', serif;
                                font-size: 1.25rem;
                                color: var(--shimmering-gold);
                                margin-bottom: 1rem;
                                opacity: 0.9;
                            ">Entry Content</h3>
                            <div style="
                                background: rgba(255, 255, 255, 0.05);
                                border: 1px solid rgba(255, 255, 255, 0.1);
                                border-radius: 12px;
                                padding: 1.5rem;
                                backdrop-filter: blur(10px);
                            ">
                                <p style="
                                    font-family: 'Inter', sans-serif;
                                    font-size: 1rem;
                                    line-height: 1.6;
                                    color: var(--warm-off-white);
                                    margin: 0;
                                    white-space: pre-wrap;
                                ">${description}</p>
                            </div>
                        </div>
                    `;
                }
            };

            return `
                <div class="descent-background"></div>
                <div class="descent-particles" id="descent-particles-container"></div>
                
                <div class="threshold-container" style="
                    min-height: 100vh;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: flex-start;
                    padding: 2rem;
                    position: relative;
                ">
                    <!-- Mobile-Responsive Header -->
                    <div style="
                        display: flex;
                        justify-content: space-between;
                        align-items: flex-start;
                        width: 100%;
                        max-width: 56rem;
                        margin-bottom: 2rem;
                    ">
                        <!-- Back Button -->
                        <button id="back-to-dashboard" style="
                            background: rgba(255, 255, 255, 0.1);
                            backdrop-filter: blur(10px);
                            border: 1px solid rgba(255, 255, 255, 0.2);
                            border-radius: 12px;
                            padding: 0.75rem;
                            color: var(--warm-off-white);
                            cursor: pointer;
                            transition: all 0.3s ease;
                            font-family: 'Inter', sans-serif;
                            display: flex;
                            align-items: center;
                            gap: 0.5rem;
                        " onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                            <i class="fas fa-arrow-left"></i>
                            Back
                        </button>
                        
                        <!-- Delete Button -->
                        <button id="delete-entry-btn" data-id="${entry.id}" style="
                            background: rgba(239, 68, 68, 0.2);
                            backdrop-filter: blur(10px);
                            border: 1px solid rgba(239, 68, 68, 0.3);
                            border-radius: 12px;
                            padding: 0.75rem;
                            color: #ef4444;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            font-family: 'Inter', sans-serif;
                        " onmouseover="this.style.background='rgba(239, 68, 68, 0.3)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    
                    <!-- Entry Content -->
                    <div class="kairos-card rounded-xl max-w-4xl w-full" style="margin-top: 2rem; padding: 3rem;">
                        <!-- Entry Header -->
                        <div style="text-align: center; margin-bottom: 3rem;">
                            <h1 style="
                                font-family: 'Playfair Display', serif;
                                font-size: clamp(2rem, 5vw, 3rem);
                                font-weight: 600;
                                margin-bottom: 1rem;
                                color: var(--warm-off-white);
                                text-shadow: 
                                    0 2px 8px rgba(72, 61, 139, 0.8),
                                    0 0 20px rgba(212, 175, 55, 0.3);
                                line-height: 1.2;
                            ">${entry.title || 'Untitled Entry'}</h1>
                            
                            <div style="
                                display: flex;
                                justify-content: center;
                                align-items: center;
                                gap: 1rem;
                                flex-wrap: wrap;
                                margin-bottom: 2rem;
                            ">
                                <span style="
                                    font-family: 'Inter', sans-serif;
                                    font-size: 0.9rem;
                                    color: rgba(255, 255, 255, 0.7);
                                ">${new Date(entry.date).toLocaleDateString('en-US', { 
                                    weekday: 'long', 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric' 
                                })}</span>
                                
                                <span style="
                                    background: rgba(212, 175, 55, 0.2);
                                    border: 1px solid rgba(212, 175, 55, 0.3);
                                    border-radius: 20px;
                                    padding: 0.25rem 0.75rem;
                                    font-family: 'Inter', sans-serif;
                                    font-size: 0.8rem;
                                    color: var(--shimmering-gold);
                                    font-weight: 500;
                                ">${entry.type || 'General'}</span>
                            </div>
                        </div>

                        <!-- Entry Content -->
                        ${formatEntryContent(entry)}
                    </div>
                </div>
            `;
        }
        function ModalComponent({ title, content, onConfirm, confirmText = 'Confirm', cancelText = 'Cancel', bodyHtml = '' }) { 
             return `<div class="modal-overlay fade-in"><div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full"><h2 class="text-xl font-bold mb-4">${title}</h2><div class="text-gray-600 mb-6">${content || ''}${bodyHtml}</div><div class="flex justify-end gap-4"><button id="modal-cancel" class="kairos-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg">${cancelText}</button>${onConfirm ? `<button id="modal-confirm" class="kairos-btn kairos-btn-primary px-4 py-2 rounded-lg">${confirmText}</button>` : ''}</div></div></div>`;
        }

        // --- EVENT LISTENERS & LOGIC ---
        function attachEventListeners() {
            // New navigation
            document.getElementById('go-to-synthesis-btn')?.addEventListener('click', () => { state.currentPage = 'synthesis'; render(); });
            document.getElementById('go-to-advisor-btn')?.addEventListener('click', () => { state.currentPage = 'advisor'; render(); });
            document.getElementById('start-guided-entry-btn')?.addEventListener('click', () => { state.currentPage = 'gatewayChoice'; render(); });
            
            // Quick Journal Page handlers
            document.getElementById('quick-journal-form')?.addEventListener('submit', handleQuickJournalSubmit);
            document.getElementById('explore-deeper-btn')?.addEventListener('click', () => {
                // Save current input to state and transition to guided flow
                const titleInput = document.getElementById('quick-title');
                const contentInput = document.getElementById('quick-content');
                
                if (contentInput && contentInput.value.trim()) {
                    state.entryBuilder = {
                        date: new Date().toISOString(),
                        initialPrompt: contentInput.value.trim(),
                        title: titleInput ? titleInput.value.trim() : ''
                    };
                    state.currentPage = 'somaticCheck1';
                    render();
                } else {
                    showToast('Please write something first', 'warning');
                }
            });

            document.querySelectorAll('.constellation-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const entryId = e.currentTarget.dataset.id;
                const entry = entries.find(en => en.id === entryId || en.id === parseInt(entryId));
                document.getElementById('constellation-display').innerHTML = renderConstellation(entry);
            }));
            document.getElementById('weave-insights-btn')?.addEventListener('click', handleWeaveInsights);

            // All previous event listeners...
            document.getElementById('go-to-register')?.addEventListener('click', (e) => { e.preventDefault(); state.currentPage = 'register'; render(); });
            document.getElementById('go-to-login')?.addEventListener('click', (e) => { e.preventDefault(); state.currentPage = 'login'; render(); });
            document.getElementById('start-new-entry-btn')?.addEventListener('click', () => { state.entryBuilder = { date: new Date().toISOString() }; state.currentPage = 'gatewayChoice'; render(); });
            document.getElementById('quick-reflect-btn')?.addEventListener('click', () => { state.currentPage = 'gatewayChoice'; render(); });
            document.getElementById('back-to-dashboard')?.addEventListener('click', () => { state.currentPage = 'dashboard'; render(); });
            document.getElementById('back-to-gateway')?.addEventListener('click', () => { state.currentPage = 'gatewayChoice'; render(); });
            document.getElementById('logout-btn')?.addEventListener('click', handleLogout);

            // Gateway Choice page handlers
            const speakOption = document.getElementById('speak-option');
            const writeOption = document.getElementById('write-option');
            
            // Hover effects for speak option
            speakOption?.addEventListener('mouseenter', () => {
                const option = speakOption;
                const icon = option.querySelector('.gateway-icon');
                const glow = option.querySelector('.gateway-glow');
                const label = option.querySelector('.gateway-label');
                
                option.style.transform = 'scale(1.1)';
                if (glow) glow.style.opacity = '0.4';
                if (label) {
                    label.style.opacity = '1';
                    label.style.transform = 'translateY(0)';
                }
            });
            
            speakOption?.addEventListener('mouseleave', () => {
                const option = speakOption;
                const icon = option.querySelector('.gateway-icon');
                const glow = option.querySelector('.gateway-glow');
                const label = option.querySelector('.gateway-label');
                
                option.style.transform = 'scale(1)';
                if (glow) glow.style.opacity = '0';
                if (label) {
                    label.style.opacity = '0';
                    label.style.transform = 'translateY(10px)';
                }
            });
            
            // Hover effects for write option
            writeOption?.addEventListener('mouseenter', () => {
                const option = writeOption;
                const icon = option.querySelector('.gateway-icon');
                const glow = option.querySelector('.gateway-glow');
                const label = option.querySelector('.gateway-label');
                
                option.style.transform = 'scale(1.1)';
                if (glow) glow.style.opacity = '0.4';
                if (label) {
                    label.style.opacity = '1';
                    label.style.transform = 'translateY(0)';
                }
            });
            
            writeOption?.addEventListener('mouseleave', () => {
                const option = writeOption;
                const icon = option.querySelector('.gateway-icon');
                const glow = option.querySelector('.gateway-glow');
                const label = option.querySelector('.gateway-label');
                
                option.style.transform = 'scale(1)';
                if (glow) glow.style.opacity = '0';
                if (label) {
                    label.style.opacity = '0';
                    label.style.transform = 'translateY(10px)';
                }
            });
            
            // Click handlers for Gateway Choice
            speakOption?.addEventListener('click', () => {
                // Add smooth transition (cross-fade animation, duration 500ms)
                appContainer.classList.add('transitioning');
                
                setTimeout(() => {
                    state.entryBuilder = { date: new Date().toISOString(), method: 'speak' };
                    state.currentPage = 'voiceJournaling';
                    render();
                    
                    // Remove transition class after rendering
                    setTimeout(() => {
                        appContainer.classList.remove('transitioning');
                    }, 50);
                }, 250); // Half of 500ms transition duration
            });
            
            writeOption?.addEventListener('click', () => {
                // Add smooth transition (cross-fade animation, duration 500ms)
                appContainer.classList.add('transitioning');
                
                setTimeout(() => {
                    // Reset body sensations for new entry
                    selectedBodySensations = [];
                    state.entryBuilder = { date: new Date().toISOString(), method: 'write' };
                    state.currentPage = 'textJournaling';
                    render();
                    
                    // Remove transition class after rendering
                    setTimeout(() => {
                        appContainer.classList.remove('transitioning');
                    }, 50);
                }, 250); // Half of 500ms transition duration
            });

            // Text Journaling form submission
            document.getElementById('text-journal-form')?.addEventListener('submit', handleTextJournalSubmit);
            
            // Body map interaction
            document.querySelectorAll('.body-part').forEach(part => {
                part.addEventListener('click', handleBodyPartClick);
            });
            
            // Onboarding access for existing users
            document.getElementById('retake-onboarding-btn')?.addEventListener('click', () => {
                // Reset onboarding state to allow retaking
                state.onboardingStep = 0;
                state.enneagramStep = 0;
                state.enneagramAnswers = [];
                state.discoveredArchetype = null;
                state.currentPage = 'onboarding';
                render();
            });
            
            // Primary journal input - start entry when user types
            document.getElementById('primary-journal-input')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && e.target.value.trim()) {
                    // Store the initial input and start guided entry
                    state.entryBuilder = { 
                        date: new Date().toISOString(),
                        initialPrompt: e.target.value.trim()
                    };
                    state.currentPage = 'somaticCheck1';
                    render();
                }
            });
            
            // Somatic heatmap glimpse
            document.getElementById('somatic-heatmap-btn')?.addEventListener('click', () => {
                // Future: Show artistic somatic heatmap modal
                console.log('Somatic heatmap view - future implementation');
                showToast('Somatic visualization coming soon...', 'info');
            });
            
            // Presence Orb interaction
            document.getElementById('presence-orb')?.addEventListener('click', () => {
                const summary = document.getElementById('presence-summary');
                const orb = document.getElementById('presence-orb');
                if (summary) {
                    summary.classList.toggle('show');
                    if (summary.classList.contains('show')) {
                        orb.classList.add('gem-shimmer');
                        setTimeout(() => orb.classList.remove('gem-shimmer'), 2000);
                    }
                }
            });
            
            // View entries toggle
            document.getElementById('view-entries-btn')?.addEventListener('click', () => {
                const entriesSection = document.getElementById('recent-entries-section');
                const button = document.getElementById('view-entries-btn');
                if (entriesSection) {
                    const isHidden = entriesSection.style.display === 'none';
                    entriesSection.style.display = isHidden ? 'block' : 'none';
                    
                    // Update button text
                    if (button) {
                        const icon = '<i class="fas fa-book-open mr-2"></i>';
                        button.innerHTML = isHidden ? `${icon}Hide Entries` : `${icon}Recent Entries`;
                    }
                }
            });
            document.getElementById('continue-to-setup')?.addEventListener('click', () => { state.currentPage = 'entrySetup'; render(); });
            
            // Onboarding event listeners
            document.getElementById('begin-weaving')?.addEventListener('click', () => { 
                state.onboardingStep = 1; 
                render(); 
            });
            
            // Energy selection bubbles
            document.querySelectorAll('.energy-bubble').forEach(bubble => {
                bubble.addEventListener('click', (e) => {
                    // Remove selected class from all bubbles
                    document.querySelectorAll('.energy-bubble').forEach(b => b.classList.remove('selected'));
                    // Add selected class to clicked bubble
                    e.currentTarget.classList.add('selected');
                    // Store energy data
                    state.onboardingData.energy = e.currentTarget.dataset.energy;
                    // Enable continue button
                    const continueBtn = document.getElementById('continue-energy');
                    continueBtn.disabled = false;
                    continueBtn.classList.remove('opacity-50');
                });
            });
            
            document.getElementById('continue-energy')?.addEventListener('click', () => { 
                state.onboardingStep = 2; 
                render(); 
            });
            
            // Wearables connection - complete onboarding
            document.getElementById('skip-wearables')?.addEventListener('click', () => { 
                state.onboardingStep = 4; // This triggers completion
                state.isFirstVisit = false;
                // Save completion status for this specific user
                const userOnboardingKey = `hasCompletedOnboarding_${state.currentUser.uid}`;
                localStorage.setItem(userOnboardingKey, 'true');
                // Navigate directly to dashboard
                state.currentPage = 'dashboard';
                loadUserEntries();
                render(); 
            });
            document.getElementById('continue-wearables')?.addEventListener('click', () => { 
                state.onboardingStep = 4; // This triggers completion
                state.isFirstVisit = false;
                // Save completion status for this specific user
                const userOnboardingKey = `hasCompletedOnboarding_${state.currentUser.uid}`;
                localStorage.setItem(userOnboardingKey, 'true');
                // Navigate directly to dashboard
                state.currentPage = 'dashboard';
                loadUserEntries();
                render(); 
            });
            
            // Wearable device clicks (for future implementation)
            document.getElementById('connect-apple')?.addEventListener('click', () => {
                // Future: Implement Apple Health connection
                console.log('Apple Health connection requested');
            });
            document.getElementById('connect-fitbit')?.addEventListener('click', () => {
                // Future: Implement Fitbit connection
                console.log('Fitbit connection requested');
            });
            document.getElementById('connect-garmin')?.addEventListener('click', () => {
                // Future: Implement Garmin connection
                console.log('Garmin connection requested');
            });
            
            // Enneagram Discovery Experience
            document.getElementById('begin-archetype-discovery')?.addEventListener('click', () => {
                state.enneagramStep = 1;
                render();
            });

            // Enneagram interaction handlers - using event delegation (only add once)
            if (!state.eventListenersAdded) {
                state.eventListenersAdded = true;
                
                document.addEventListener('click', (e) => {
                // Handle resonance option clicks
                if (e.target.closest('.resonance-option')) {
                    const option = e.target.closest('.resonance-option');
                    
                    // Remove selected class from all options
                    document.querySelectorAll('.resonance-option').forEach(o => o.classList.remove('selected'));
                    // Add selected class to clicked option
                    option.classList.add('selected');
                    
                    // Store answer
                    const types = option.dataset.types.split(',').map(t => parseInt(t));
                    if (!state.enneagramAnswers[state.enneagramStep - 1]) {
                        state.enneagramAnswers[state.enneagramStep - 1] = [];
                    }
                    state.enneagramAnswers[state.enneagramStep - 1] = types;
                    
                    // Auto-advance to next question after brief delay
                    setTimeout(() => {
                        state.enneagramStep++;
                        render();
                    }, 800); // 0.8 second delay to show selection
                }
            });

            // Resonance option hover effects - using event delegation
            document.addEventListener('mouseenter', (e) => {
                if (e.target && typeof e.target.closest === 'function') {
                    const option = e.target.closest('.resonance-option');
                    if (option) {
                        const artType = option.dataset.art;
                        const resonanceArt = document.getElementById('resonance-art');
                        if (resonanceArt) {
                            resonanceArt.className = `resonance-art ${artType}`;
                        }
                    }
                }
            }, true);

            document.addEventListener('mouseleave', (e) => {
                if (e.target && typeof e.target.closest === 'function') {
                    const option = e.target.closest('.resonance-option');
                    if (option) {
                        const resonanceArt = document.getElementById('resonance-art');
                        if (resonanceArt) {
                            resonanceArt.className = 'resonance-art';
                        }
                    }
                }
            }, true);
            
            } // End of eventListenersAdded check

            // Continue from archetype discovery to wearables
            document.getElementById('continue-to-wearables')?.addEventListener('click', () => {
                state.onboardingStep = 3; // Move to wearables step
                state.enneagramStep = 0; // Reset for next user
                render();
            });
            
            document.getElementById('complete-onboarding')?.addEventListener('click', () => { 
                state.isFirstVisit = false;
                // Save completion status for this specific user
                const userOnboardingKey = `hasCompletedOnboarding_${state.currentUser.uid}`;
                localStorage.setItem(userOnboardingKey, 'true');
                state.currentPage = 'dashboard'; 
                loadUserEntries();
                render(); 
            });
            document.querySelectorAll('.somatic-option[data-state]').forEach(el => el.addEventListener('click', (e) => { state.somaticState = e.currentTarget.dataset.state; state.currentPage = 'somaticCheck2'; render(); }));
            document.querySelectorAll('.somatic-option[data-capacity]').forEach(el => el.addEventListener('click', (e) => { state.sessionCapacity = e.currentTarget.dataset.capacity; state.currentPage = state.sessionCapacity === 'grounding' ? 'grounding' : 'entrySetup'; render(); }));
            const breathText = document.getElementById('breath-text');
            if(breathText) { setInterval(() => { breathText.innerText = breathText.innerText === 'Breathe In...' ? 'Breathe Out...' : 'Breathe In...'; }, 4000); }
            document.getElementById('entry-setup-form')?.addEventListener('submit', (e) => { e.preventDefault(); const fd = new FormData(e.target); state.entryBuilder.title = fd.get('title'); state.entryBuilder.situation = { description: fd.get('situation.description') }; state.currentPage = 'thematicCheck'; render(); });
            const thematicOptions = document.querySelectorAll('.thematic-option');
            const startReflectionBtn = document.getElementById('start-reflection-btn');
            thematicOptions.forEach(el => { el.addEventListener('click', () => { el.classList.toggle('selected'); const selectedCount = document.querySelectorAll('.thematic-option.selected').length; startReflectionBtn.disabled = selectedCount === 0; startReflectionBtn.classList.toggle('opacity-50', selectedCount === 0); }); });
            startReflectionBtn?.addEventListener('click', () => { const selectedSections = Array.from(document.querySelectorAll('.thematic-option.selected')).map(el => el.dataset.section); state.entryBuilder.flow = { steps: selectedSections, currentStepIndex: 0 }; state.currentPage = 'entryFlow'; render(); });
            document.getElementById('login-form')?.addEventListener('submit', handleLogin);
            document.getElementById('register-form')?.addEventListener('submit', handleRegister);
            document.querySelectorAll('.view-entry-btn').forEach(btn => btn.addEventListener('click', handleViewEntry));
            document.getElementById('delete-entry-btn')?.addEventListener('click', handleDeleteEntry);
            document.getElementById('modal-cancel')?.addEventListener('click', hideModal);
            document.getElementById('modal-confirm')?.addEventListener('click', () => { if (state.modal.onConfirm) state.modal.onConfirm(); hideModal(); });
        }
        
        // --- HANDLER & UTILITY FUNCTIONS ---
        const { showToast, renderToast } = (() => {
            let toastTimeout;
            const showToast = (message, type = 'success') => {
                clearTimeout(toastTimeout);
                state.toast = { message, type, visible: true };
                renderToast();
                toastTimeout = setTimeout(() => {
                    state.toast.visible = false;
                    renderToast();
                }, 3000);
            };
            const renderToast = () => {
                let toastElement = document.getElementById('toast-notification');
                if (!toastElement && state.toast.visible) {
                    toastElement = document.createElement('div');
                    toastElement.id = 'toast-notification';
                    document.body.appendChild(toastElement);
                }
                if (toastElement) {
                    if (state.toast.visible) {
                        const bgColor = state.toast.type === 'success' ? 'bg-green-500' : 'bg-red-500';
                        toastElement.className = `fixed bottom-5 right-5 ${bgColor}  py-3 px-5 rounded-lg shadow-2xl transition-all duration-300 transform opacity-100 translate-y-0`;
                        toastElement.innerText = state.toast.message;
                    } else {
                        toastElement.className = toastElement.className.replace('opacity-100 translate-y-0', 'opacity-0 translate-y-5');
                    }
                }
            };
            return { showToast, renderToast };
        })();
        
        async function generateSynthesisInsights() {
            state.synthesis = { isLoading: true, content: null, error: null };

            if (entries.length < 2) {
                state.synthesis = { isLoading: false, content: { guidance: "Patterns begin to reveal themselves with more data. Create another entry, focusing on emotions and body sensations, to awaken deeper insights." }, error: null };
                return;
            }

            const recentEntriesSummary = entries.slice(0, 5).map(e => {
                return `Entry: "${e.title || 'Untitled'}"\n- Situation: ${e.situation?.description}\n- Emotions: ${e.emotional?.emotions?.map(em => em.name).join(', ')}`;
            }).join('\n\n');

            const prompt = `
                Analyze the following journal entries to identify core psychological themes.
                Your task is to identify themes of "aversion" (what the user is pushing away, resisting, or fearful of) and "craving" (what the user is attached to, desiring, or seeking).

                Entries:
                ---
                ${recentEntriesSummary}
                ---

                Based on this data, you MUST provide a response in a valid JSON format. The JSON object should contain two keys: "aversionThemes" and "cravingThemes".
                Each key should have a value of an array of strings. Each string should be a concise theme (2-5 words).
                Identify 2-4 themes for each category.

                Example response:
                {
                  "aversionThemes": ["Fear of being judged", "Resistance to change", "Feeling of inadequacy"],
                  "cravingThemes": ["Desire for peace and quiet", "Seeking validation from others", "Longing for connection"]
                }
                
                Do not include any text outside of the JSON object.
            `;
            
            try {
                const parsedContent = await callGeminiAPI(prompt, true);
                state.synthesis = { isLoading: false, content: parsedContent, error: null };

            } catch (error) {
                console.error("Gemini Synthesis call via Netlify failed:", error);
                state.synthesis = { isLoading: false, content: null, error: "Could not synthesize patterns at this time. Please try again later." };
            }
        }


        async function generateDynamicAdvisorContent() {
            state.advisor = { isLoading: true, content: null, error: null };
            
            if (entries.length === 0) {
                state.advisor = { isLoading: false, content: { guidance: "Your journey begins with a single step. The Advisor awakens once you've created your first journal entry. What's on your mind right now?" }, error: null };
                return;
            }

            if (entries.length < 2) {
                 state.advisor = { isLoading: false, content: { guidance: "A wonderful start. For the Advisor to see your patterns emerge, try to create another entry. The richest insights come from logging not just the situation, but also the emotions and body sensations you feel." }, error: null };
                return;
            }

            const recentEntriesSummary = entries.slice(0, 5).map(e => {
                return `Entry: "${e.title || 'Untitled'}"\n- Situation: ${e.situation?.description}\n- Narrative: ${e.inquiry?.story}\n- Emotions: ${e.emotional?.emotions?.map(em => `${em.name} (Intensity: ${em.intensity})`).join(', ')}\n- Sensations: ${e.physical?.sensations?.map(s => `${s.part}: ${s.quality}`).join(', ')}\n- Dream Insights: ${e.dream?.insights || 'N/A'}`;
            }).join('\n\n');

            const prompt = `
                You are the Kairos Advisor, the integrated voice of the user's Higher Self. Your purpose is to translate their journal entries into compassionate, actionable wisdom.

                Analyze the following summary of the user's recent journal entries:
                ---
                ${recentEntriesSummary}
                ---

                Based on this data, you MUST provide a response in a valid JSON format. The JSON object should contain three keys: "truth", "plan", and "challenge".

                1.  **truth**: "The Compassionate Truth". Write a loving but direct reflection of a core pattern you observe in the data. Ground it in their own words and experiences.
                2.  **plan**: "The Integration Plan". This must be an object with two keys:
                    * "inner": A concrete "Inner Work" step (e.g., a specific somatic practice, breathwork, or meditation).
                    * "outer": A concrete "Outer Action" step (e.g., a small, real-world behavior, a difficult conversation to have, or an action to take).
                3.  **challenge**: "The Evolutionary Challenge". Write a single, powerful, forward-looking question or a specific assignment designed to push the user to their next level of consciousness. You can frame this as moving from a "Shadow" frequency (like Fear) to a "Gift" frequency (like Courage).

                Do not include any text outside of the JSON object.
            `;

            try {
                const parsedContent = await callGeminiAPI(prompt, true);
                state.advisor = { isLoading: false, content: parsedContent, error: null };

            } catch (error) {
                console.error("Gemini Advisor call via Netlify failed:", error);
                state.advisor = { isLoading: false, content: null, error: "Could not retrieve wisdom from your Higher Self at this moment. Please try again later." };
            }
        }


        async function handleQuickJournalSubmit(e) {
            e.preventDefault();
            
            const titleInput = document.getElementById('quick-title');
            const contentInput = document.getElementById('quick-content');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            const title = titleInput ? titleInput.value.trim() : '';
            const content = contentInput ? contentInput.value.trim() : '';
            
            if (!content) {
                showToast('Please write something first', 'warning');
                return;
            }
            
            // Show loading state
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
            submitBtn.disabled = true;
            
            try {
                // Prepare entry data for Firebase
                const entryData = {
                    title: title || `Reflection - ${new Date().toLocaleDateString()}`,
                    content: content,
                    createdAt: new Date(),
                    updatedAt: new Date(),
                    // Add some basic analysis
                    emotionalAnalysis: {
                        quickEntry: true,
                        wordCount: content.split(/\s+/).length
                    },
                    themes: [], // Could extract basic themes if desired
                    mood: null  // User didn't specify mood in quick entry
                };
                
                // Save to Firebase
                const token = await state.currentUser.getIdToken();
                const response = await fetch('/.netlify/functions/firebase-backend', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        action: 'createEntry',
                        data: entryData
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to save entry: ${response.status}`);
                }
                
                const savedEntry = await response.json();
                
                // Add to local entries array
                entries.unshift(savedEntry);
                
                showToast('Reflection saved successfully!', 'success');
                
                // Navigate back to dashboard
                state.currentPage = 'dashboard';
                render();
                
            } catch (error) {
                console.error('Error saving quick journal entry:', error);
                showToast('Failed to save reflection. Please try again.', 'error');
                
                // Restore button state
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        async function handleWeaveInsights() {
            const container = document.getElementById('dream-insights-container');
            const description = document.querySelector('textarea[name="dream.description"]').value;
            const symbols = document.querySelector('input[name="dream.symbols"]').value;

            if (!description.trim()) {
                showToast("Please describe the dream or synchronicity first.", "error");
                return;
            }

            container.innerHTML = `<div class="flex justify-center items-center p-4"><div class="loader"></div></div>`;

            const recentThemes = entries.slice(0, 2).map(e => e.situation.description).join('; ');

            const prompt = `
                As a Jungian-informed dream analyst, analyze the following dream/synchronicity.
                Description: "${description}"
                Key Symbols: "${symbols}"
                
                Also, consider these themes from the user's recent waking life journal entries for context: "${recentThemes}"

                Your tasks are:
                1. Identify potential archetypes or recurring symbols in the dream.
                2. Gently highlight any potential cross-referenced insights or connections between the dream symbols and the waking life themes.
                3. Frame your response as a compassionate, reflective prompt for deeper user inquiry, not as a definitive interpretation. Start with "Here are some threads that emerge...".
            `;
            
            try {
                const result = await callGeminiAPI(prompt, false);
                const text = result.text.replace(/\n/g, '<br>');
                
                container.innerHTML = `
                    <div class="border-t pt-4 mt-4">
                        <h3 class="font-semibold text-lg mb-2" style="color: var(--deep-indigo);">The Subconscious Bridge</h3>
                        <div class="prose prose-sm max-w-none text-gray-700 p-4 rounded-lg" style="background: rgba(72, 61, 139, 0.05);">${text}</div>
                    </div>
                `;
                if(!state.entryBuilder.dream) state.entryBuilder.dream = {};
                state.entryBuilder.dream.insights = text;

            } catch (error) {
                console.error("Gemini Weave Insights call via Netlify failed:", error);
                container.innerHTML = `<p class="text-red-500 text-center">Sorry, we couldn't weave insights at this moment. Please try again later.</p>`;
            }
        }

        // --- Other handler functions ---
        function calculateEquanimity() { if (entries.length === 0) return { score: 100, ripples: 0 }; const totalIntensity = entries.reduce((sum, entry) => { const entryIntensity = entry.emotional?.emotions?.reduce((eSum, emo) => eSum + emo.intensity, 0) || 0; return sum + entryIntensity; }, 0); const avgIntensity = totalIntensity / entries.length / 5; const score = Math.max(0, Math.round(100 - avgIntensity * 10)); const ripples = Math.min(10, avgIntensity); return { score, ripples }; }
        function renderConstellation(entry) { if (!entry) return ''; const coreReaction = (entry.emotional?.emotions?.some(e => ['Angry', 'Fearful'].includes(e.name))) ? { type: 'Aversion', color: 'red-500' } : { type: 'Neutral/Craving', color: 'green-500' }; return `<div class="border-t pt-6 fade-in"><div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center items-center"><div class="p-4 bg-gray-50 rounded-lg"><h4 class="font-bold text-lg mb-2">Trigger</h4><i class="fas fa-bolt text-3xl text-yellow-500 mb-2"></i><p>${entry.situation?.description || 'N/A'}</p></div><i class="fas fa-arrow-right text-2xl text-gray-400 hidden md:block"></i><i class="fas fa-arrow-down text-2xl text-gray-400 md:hidden mx-auto"></i><div class="p-4 bg-gray-50 rounded-lg"><h4 class="font-bold text-lg mb-2">Core Reaction</h4><i class="fas ${coreReaction.type === 'Aversion' ? 'fa-hand-paper' : 'fa-hand-holding-heart'} text-3xl text-${coreReaction.color} mb-2"></i><p class="font-semibold text-${coreReaction.color}">${coreReaction.type}</p></div></div><div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center mt-4"><div class="p-4 bg-gray-50 rounded-lg"><h4 class="font-bold text-lg mb-2">Internal Narrative</h4><i class="fas fa-comment-dots text-3xl text-blue-500 mb-2"></i><p class="text-sm italic">"${entry.inquiry?.story || 'No narrative logged'}"</p></div><div class="p-4 bg-gray-50 rounded-lg"><h4 class="font-bold text-lg mb-2">Emotions</h4><i class="fas fa-heart-pulse text-3xl text-pink-500 mb-2"></i><p>${entry.emotional?.emotions?.map(e => `${e.name} (${e.intensity})`).join(', ') || 'N/A'}</p></div><div class="p-4 bg-gray-50 rounded-lg"><h4 class="font-bold text-lg mb-2">Somatic Signature</h4><i class="fas fa-child text-3xl text-orange-500 mb-2"></i><p>${entry.physical?.sensations?.map(s => `${s.part}: ${s.quality}`).join(', ') || 'N/A'}</p></div></div></div>`; }
        async function handleLogin(e) { 
            e.preventDefault(); 
            state.isLoading = true;
            state.authError = null;
            render();
            
            const email = e.target.elements.email.value;
            const password = e.target.elements.password.value;
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showToast("Welcome back to your sanctuary!", "success");
            } catch (error) {
                console.error('Login error:', error);
                state.authError = getAuthErrorMessage(error.code);
                showToast(state.authError, "error");
                state.isLoading = false;
                render();
            }
        }
        
        async function handleRegister(e) { 
            e.preventDefault(); 
            state.isLoading = true;
            state.authError = null;
            render();
            
            const email = e.target.elements.email.value;
            const password = e.target.elements.password.value;
            const confirmPassword = e.target.elements['confirm-password'].value;
            
            if (password !== confirmPassword) { 
                showToast("Passwords do not match.", "error"); 
                state.isLoading = false;
                render();
                return; 
            }
            
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showToast("Welcome to Kairos! Your journey begins now.", "success");
            } catch (error) {
                console.error('Registration error:', error);
                state.authError = getAuthErrorMessage(error.code);
                showToast(state.authError, "error");
                state.isLoading = false;
                render();
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                showToast('Signed out successfully', 'success');
            } catch (error) {
                console.error('Logout error:', error);
                showToast('Error signing out', 'error');
            }
        }

        function getAuthErrorMessage(errorCode) {
            switch (errorCode) {
                case 'auth/user-not-found':
                    return 'No account found with this email address.';
                case 'auth/wrong-password':
                    return 'Incorrect password. Please try again.';
                case 'auth/email-already-in-use':
                    return 'An account with this email already exists.';
                case 'auth/weak-password':
                    return 'Password should be at least 6 characters long.';
                case 'auth/invalid-email':
                    return 'Please enter a valid email address.';
                case 'auth/too-many-requests':
                    return 'Too many failed attempts. Please try again later.';
                default:
                    return 'An error occurred. Please try again.';
            }
        }
        // Store selected body sensations
        let selectedBodySensations = [];

        function handleBodyPartClick(e) {
            const part = e.target;
            const partName = part.dataset.part;
            const sensationsDisplay = document.getElementById('selected-sensations');
            
            // Toggle selection
            if (part.style.fill === 'rgba(212, 175, 55, 0.3)') {
                // Deselect
                part.style.fill = 'rgba(255,255,255,0.1)';
                selectedBodySensations = selectedBodySensations.filter(s => s.part !== partName);
            } else {
                // Select
                part.style.fill = 'rgba(212, 175, 55, 0.3)';
                selectedBodySensations.push({
                    part: partName,
                    sensation: 'tension' // Default sensation, could be expanded later
                });
            }
            
            // Update display
            if (selectedBodySensations.length > 0) {
                const sensationsText = selectedBodySensations.map(s => 
                    `${s.part.replace('-', ' ')}: ${s.sensation}`
                ).join(', ');
                sensationsDisplay.innerHTML = `
                    <p style="
                        font-family: 'Inter', sans-serif;
                        font-size: 0.9rem;
                        color: var(--warm-off-white);
                        margin: 0;
                    ">Selected: ${sensationsText}</p>
                `;
            } else {
                sensationsDisplay.innerHTML = `
                    <p style="
                        font-family: 'Inter', sans-serif;
                        font-size: 0.9rem;
                        color: var(--warm-off-white);
                        opacity: 0.7;
                        text-align: center;
                        margin: 0;
                    ">Selected body sensations will appear here</p>
                `;
            }
        }

        async function handleTextJournalSubmit(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const title = formData.get('title');
            const content = formData.get('content');
            
            if (!title || !content) {
                showToast('Please fill in both title and content', 'error');
                return;
            }

            try {
                if (!state.currentUser) {
                    showToast('You must be logged in to save entries', 'error');
                    return;
                }

                const entry = {
                    title: title,
                    content: content,
                    method: 'write',
                    bodySensations: selectedBodySensations,
                    situation: { description: content }, // For compatibility with existing structure
                    type: 'Text Entry',
                    date: new Date().toISOString()
                };

                // Save to Firestore using user's UID
                const savedEntry = await saveJournalEntry(state.currentUser.uid, entry);
                
                // Add to local entries array for immediate UI update
                entries.unshift(savedEntry);
                
                const completeEntry = {
                    ...savedEntry,
                    date: savedEntry.created_at || new Date().toISOString()
                };
                
                // Trigger The Weaver's thread system
                onJournalEntryCompleted(completeEntry);
                
                showToast('Entry saved successfully!', 'success');
                
                // Navigate back to dashboard
                state.currentPage = 'dashboard';
                render();
                
            } catch (error) {
                console.error('Error saving entry:', error);
                
                // Handle authentication errors specifically
                if (error.message.includes('Authentication expired') || 
                    error.message.includes('Session expired') ||
                    error.message.includes('Invalid or expired token')) {
                    showToast('Your session has expired. Please log in again.', 'error');
                    // The callFirebaseBackend function already handles redirecting to login
                } else {
                    showToast('Failed to save entry. Please try again.', 'error');
                }
            }
        }

        function handleViewEntry(e) { 
            const entryId = e.currentTarget.dataset.id; 
            state.currentEntry = entries.find(entry => entry.id === entryId || entry.id === parseInt(entryId)); 
            state.currentPage = 'viewEntry'; 
            render(); 
        }
        function handleDeleteEntry(e) { 
            const entryId = e.currentTarget.dataset.id; 
            showModal({ 
                title: 'Delete Entry', 
                content: 'Are you sure you want to permanently delete this journal entry?', 
                confirmText: 'Delete', 
                onConfirm: async () => { 
                    try {
                        // Delete via secure backend
                        await callFirebaseBackend('deleteEntry', { entryId });
                        
                        // Remove from local entries array
                        entries = entries.filter(entry => entry.id !== entryId); 
                        
                        // Save to localStorage for local development persistence
                        saveLocalEntries();
                        
                        showToast('Entry deleted successfully.', 'success'); 
                        state.currentPage = 'dashboard'; 
                        render();
                    } catch (error) {
                        console.error('Error deleting entry:', error);
                        showToast('Failed to delete entry. Please try again.', 'error');
                    }
                } 
            }); 
        }
        function showModal(config) { state.modal = { ...config, visible: true }; render(); }
        function hideModal() { state.modal = { visible: false }; render(); }

        // Deep emotional analysis for The Weaver's thread system
        // Simplified analysis for basic display
        function analyzeRecentEntries() {
            if (entries.length === 0) {
                return {
                    presenceLevel: 7,
                    emotionalTone: 'peaceful readiness',
                    hasGems: false,
                    hasCompassion: false
                };
            }
            
            const recentEntry = entries[0];
            const threads = analyzeEmotionalContent(recentEntry);
            
            let presenceLevel = 7;
            let emotionalTone = 'neutral presence';
            let hasGems = threads.some(t => t.type === 'gold');
            let hasCompassion = threads.some(t => t.type === 'rose');
            
            // Calculate presence based on emotional complexity
            const avgIntensity = threads.length > 0 ? threads.reduce((sum, t) => sum + t.intensity, 0) / threads.length : 5;
            presenceLevel = Math.round(Math.max(3, Math.min(10, avgIntensity)));
            
            if (hasGems && hasCompassion) {
                emotionalTone = 'integrated awareness';
            } else if (hasGems) {
                emotionalTone = 'illuminated understanding';
            } else if (hasCompassion) {
                emotionalTone = 'compassionate presence';
            } else if (threads.some(t => t.type === 'indigo')) {
                emotionalTone = 'gentle awareness';
            }
            
            return { presenceLevel, emotionalTone, hasGems, hasCompassion };
        }

        // Presence Orb Functions
        function showPresenceModal() {
            const { presenceLevel, emotionalTone } = analyzeRecentEntries();
            
            showModal({
                title: "Your Current Presence",
                content: `Your last reflection held a sense of ${emotionalTone}. You felt your presence was ${presenceLevel}/10.`,
                confirmText: "Begin New Reflection",
                cancelText: "Close",
                onConfirm: () => {
                    state.currentPage = 'somaticCheck1';
                    render();
                }
            });
        }

        // The Weaver's Thread Integration System
        function weaveEmotionalThreads(entry) {
            if (!entry) return;
            
            const threads = analyzeEmotionalContent(entry);
            const threadsContainer = document.getElementById('emotional-threads');
            
            if (!threadsContainer) return;
            
            // Weave each emotional thread with a staggered delay
            threads.forEach((thread, index) => {
                setTimeout(() => {
                    createEmotionalThread(thread, threadsContainer);
                }, index * 800); // 800ms delay between threads
            });
        }

        function createEmotionalThread(threadData, container) {
            const thread = document.createElement('div');
            thread.className = `emotional-thread ${threadData.type}`;
            
            // Position thread at a random starting point
            const startY = Math.random() * 60 + 20; // 20-80% from top
            thread.style.top = `${startY}%`;
            
            // Scale thread intensity based on emotion strength
            const scale = (threadData.intensity / 10) * 1.5 + 0.5; // 0.5 to 2x scale
            thread.style.transform = `scaleY(${scale})`;
            
            container.appendChild(thread);
            
            // Remove thread after animation completes
            setTimeout(() => {
                if (thread.parentNode) {
                    thread.parentNode.removeChild(thread);
                }
            }, 8000);
        }

        function initializeOrbParticles() {
            const orbParticles = document.getElementById('orb-particles');
            if (!orbParticles) return;
            
            const { hasGems, hasCompassion } = analyzeRecentEntries();
            
            // Clear existing particles
            orbParticles.innerHTML = '';
            
            // Add ambient particles based on emotional state
            for (let i = 0; i < (hasGems || hasCompassion ? 6 : 3); i++) {
                const particle = document.createElement('div');
                particle.className = `presence-orb-particle ${hasCompassion && Math.random() > 0.5 ? 'rose' : ''}`;
                
                // Random positioning and sizing
                const size = Math.random() * 3 + 1.5;
                const x = Math.random() * 80 + 10;
                const delay = Math.random() * 15;
                
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.left = `${x}%`;
                particle.style.animationDelay = `${delay}s`;
                
                orbParticles.appendChild(particle);
            }
        }

        // Hook into entry completion to trigger thread weaving
        function onJournalEntryCompleted(entry) {
            // Add to entries
            entries.unshift(entry);
            
            // Save to localStorage for local development persistence
            saveLocalEntries();
            
            // Weave the emotional threads after returning to dashboard
            setTimeout(() => {
                if (state.currentPage === 'dashboard') {
                    weaveEmotionalThreads(entry);
                }
            }, 1500); // Delay to allow navigation to dashboard
            
            // Update orb state with new emotional particles
            setTimeout(() => {
                if (state.currentPage === 'dashboard') {
                    initializeOrbParticles();
                }
            }, 2500);
        }

        // --- INITIAL RENDER ---
        render();
        
        // Initialize orb particles when dashboard loads
        setTimeout(() => {
            if (state.currentPage === 'dashboard') {
                initializeOrbParticles();
            }
        }, 500);
    </script>
</body>
</html>
