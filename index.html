<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kairos - A Journey Within</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F8F7F4;
            color: #3D3D3D;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { 
            animation: fadeIn 0.5s ease-out forwards; 
            opacity: 0; /* Start hidden */
        }
        
        .kairos-card {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .kairos-btn { transition: all 0.3s ease; }
        .kairos-btn-primary { background-color: #4A55A2; color: white; }
        .kairos-btn-primary:hover { background-color: #3A4482; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        .action-btn:hover {
             transform: translateY(-3px) scale(1.02);
             box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .somatic-option, .thematic-option { transition: all 0.3s ease; cursor: pointer; }
        .somatic-option:hover, .thematic-option:hover { transform: scale(1.03); box-shadow: 0 10px 20px rgba(0,0,0,0.08); }
        .thematic-option.selected {
            transform: scale(1.03);
            box-shadow: 0 10px 20px rgba(74, 85, 162, 0.2);
            border-color: #4A55A2;
            background-color: #eef2ff;
        }

        .emotion-chip.selected, .sensation-chip.selected { background-color: #4A55A2; color: white; transform: scale(1.05); }

        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex; align-items: center; justify-content: center; z-index: 50;
        }
        
        #body-map-svg path { fill: #d1d5db; stroke: #6b7280; stroke-width: 1.5; transition: fill 0.3s ease; cursor: pointer; }
        #body-map-svg path:hover { fill: #93c5fd; }
        .sensation-dot { position: absolute; border-radius: 50%; transform: translate(-50%, -50%); border: 1px solid rgba(255,255,255,0.5); pointer-events: none; }
        
        #equanimity-pool { transition: all 1s ease-in-out; }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4A55A2;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased">

    <div id="app" class="min-h-screen"></div>
    <div id="modal-container"></div>

    <!-- Main Application Script -->
    <script type="module">
        // Import organized services (only auth needed - db operations via backend)
        import { auth } from './js/firebase-config.js';
        // Note: firebaseAuth and firebaseJournal services not needed with backend approach
        
        // Import only Firebase Auth functions (Firestore operations will be server-side)
        import { 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged 
        } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

        // --- MOCK DATA & CONFIG ---
        let entries = [
            { id: 1, title: "Team Meeting", date: "2025-07-22T14:30:00.000Z", situation: { description: "My project was criticized and I felt defensive." }, inquiry: { story: "They are trying to undermine me.", emotion: "Anger and Fear", belief: "I'm not good enough." }, emotional: { emotions: [{name: 'Angry', intensity: 8}, {name: 'Fearful', intensity: 7}]}, physical: { sensations: [{part: "Chest", quality: "Tightness", intensity: 8, x: 50, y: 45, view: 'front'}, {part: "Stomach/Gut", quality: "Ache", intensity: 6, x: 50, y: 55, view: 'front'}]} },
            { id: 2, title: "Morning Walk", date: "2025-07-21T08:00:00.000Z", situation: { description: "A peaceful walk in the park." }, emotional: { emotions: [{name: 'Calm', intensity: 2}, {name: 'Happy', intensity: 3}]} },
            { id: 3, title: "Unexpected Bill", date: "2025-07-20T18:00:00.000Z", situation: { description: "Received a large, unexpected bill in the mail." }, emotional: { emotions: [{name: 'Fearful', intensity: 9}]}, physical: { sensations: [{part: "Stomach/Gut", quality: "Tightness", intensity: 9, x: 50, y: 55, view: 'front'}]} }
        ];
        const quotes = ["The journey of a thousand miles begins with a single step.", "The only way out is through.", "What you resist, persists."];
        const entrySections = {
            dream: { title: "Dream & Synchronicity", icon: "fa-moon" },
            inquiry: { title: "Internal Narrative", icon: "fa-layer-group" },
            cognitive: { title: "My Thoughts & Beliefs", icon: "fa-brain" },
            emotional: { title: "My Emotions", icon: "fa-heart" },
            physical: { title: "My Body's Sensations", icon: "fa-person-running" },
            behavioral: { title: "My Actions & Urges", icon: "fa-hand-fist" },
            reflection: { title: "Patterns & Connections", icon: "fa-infinity" },
            integration: { title: "Insights & Intentions", icon: "fa-seedling" },
            perspective: { title: "Perspective Lenses", icon: "fa-glasses" }
        };

        // --- STATE MANAGEMENT ---
        let state = {
            currentPage: 'login',
            currentUser: null,
            isLoading: false,
            authError: null,
            currentEntry: null,
            somaticState: null,
            sessionCapacity: null,
            bodyMapView: 'front',
            entryBuilder: {},
            advisor: { isLoading: true, content: null, error: null },
            synthesis: { isLoading: true, content: null, error: null },
            toast: { visible: false },
            modal: { visible: false }
        };

        // Firebase Authentication State Listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                state.currentUser = {
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName
                };
                if (state.currentPage === 'login' || state.currentPage === 'register') {
                    state.currentPage = 'dashboard';
                    loadUserEntries();
                }
            } else {
                state.currentUser = null;
                if (state.currentPage !== 'login' && state.currentPage !== 'register') {
                    state.currentPage = 'login';
                }
                entries = []; // Clear entries when logged out
            }
            render();
        });

        // Secure API call to Firebase backend
        async function callFirebaseBackend(action, data = {}) {
            if (!state.currentUser) {
                throw new Error('User must be authenticated');
            }

            try {
                const idToken = await state.currentUser.getIdToken();
                
                const response = await fetch('/.netlify/functions/firebase-backend', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: JSON.stringify({ action, data })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Backend operation failed');
                }

                return await response.json();
            } catch (error) {
                console.error('Firebase backend error:', error);
                throw error;
            }
        }

        // Load user's journal entries from Firebase (via backend)
        async function loadUserEntries() {
            if (!state.currentUser) return;
            
            try {
                const result = await callFirebaseBackend('getUserEntries', { limit: 50 });
                entries = result.map(entry => ({
                    ...entry,
                    // Convert Firestore timestamp to ISO string for compatibility
                    date: entry.createdAt?.toDate?.()?.toISOString() || 
                          (entry.createdAt?._seconds ? new Date(entry.createdAt._seconds * 1000).toISOString() : new Date().toISOString())
                }));
            } catch (error) {
                console.error('Error loading entries:', error);
                showToast('Failed to load your journal entries', 'error');
            }
        }

        // --- RENDER FUNCTIONS ---
        const appContainer = document.getElementById('app');
        const modalContainer = document.getElementById('modal-container');

        async function render() {
            appContainer.innerHTML = ''; 
            
            // Handle async pages
            if (state.currentPage === 'advisor') {
                appContainer.innerHTML = AdvisorPage(); // Render skeleton
                await generateDynamicAdvisorContent(); // Fetch data
                appContainer.innerHTML = AdvisorPage(); // Re-render with data
            } else if (state.currentPage === 'synthesis') {
                appContainer.innerHTML = SynthesisPage(); // Render skeleton
                await generateSynthesisInsights(); // Fetch data
                appContainer.innerHTML = SynthesisPage(); // Re-render with data
            } else {
                // Handle synchronous pages
                switch (state.currentPage) {
                    case 'login': appContainer.innerHTML = LoginPage(); break;
                    case 'register': appContainer.innerHTML = RegisterPage(); break;
                    case 'dashboard': appContainer.innerHTML = DashboardPage(); break;
                    case 'somaticCheck1': appContainer.innerHTML = SomaticCheckPage1(); break;
                    case 'somaticCheck2': appContainer.innerHTML = SomaticCheckPage2(); break;
                    case 'grounding': appContainer.innerHTML = GroundingPage(); break;
                    case 'entrySetup': appContainer.innerHTML = EntrySetupPage(); break;
                    case 'thematicCheck': appContainer.innerHTML = ThematicCheckPage(); break;
                    case 'entryFlow': appContainer.innerHTML = EntryFlowPage(); break;
                    case 'viewEntry': appContainer.innerHTML = ViewEntryPage(); break;
                }
            }
            modalContainer.innerHTML = state.modal.visible ? ModalComponent(state.modal) : '';
            attachEventListeners();
            renderToast();
        }
        
        // --- UI COMPONENTS ---
        function LoginPage() { 
             return `
                <div class="min-h-screen flex items-center justify-center p-4 bg-cover bg-center" style="background-image: url('https://placehold.co/1200x800/A9B4C2/FFFFFF?text=Kairos');">
                    <div class="kairos-card p-8 rounded-xl shadow-2xl max-w-md w-full fade-in">
                        <h1 class="text-4xl font-bold text-center text-gray-800 mb-2">Kairos</h1>
                        <p class="text-center text-gray-600 mb-8">Your Journey Within</p>
                        <form id="login-form">
                            <div class="mb-4">
                                <label for="email" class="block text-gray-600 mb-2">Email</label>
                                <input type="email" id="email" class="w-full px-4 py-2 bg-white/50 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400" required>
                            </div>
                            <div class="mb-6">
                                <label for="password" class="block text-gray-600 mb-2">Password</label>
                                <input type="password" id="password" class="w-full px-4 py-2 bg-white/50 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400" required>
                            </div>
                            <button type="submit" class="w-full kairos-btn kairos-btn-primary py-3 rounded-lg font-semibold ${state.isLoading ? 'opacity-75 cursor-not-allowed' : ''}" ${state.isLoading ? 'disabled' : ''}>
                                ${state.isLoading ? '<div class="loader inline-block mr-2" style="width:20px;height:20px;"></div>Signing In...' : 'Enter Sanctuary'}
                            </button>
                            ${state.authError ? `<p class="text-red-500 text-sm mt-4 text-center">${state.authError}</p>` : ''}
                        </form>
                         <p class="text-center mt-6">New here? <a href="#" id="go-to-register" class="text-indigo-600 font-semibold hover:underline">Begin your journey</a></p>
                    </div>
                </div>
            `;
        }

        function RegisterPage() {
            return `
                <div class="min-h-screen flex items-center justify-center p-4 bg-cover bg-center" style="background-image: url('https://placehold.co/1200x800/A9B4C2/FFFFFF?text=Kairos');">
                    <div class="kairos-card p-8 rounded-xl shadow-2xl max-w-md w-full fade-in">
                        <h1 class="text-4xl font-bold text-center text-gray-800 mb-2">Begin Your Journey</h1>
                        <p class="text-center text-gray-600 mb-8">Create your Kairos account.</p>
                        <form id="register-form">
                            <div class="mb-4">
                                <label for="email" class="block text-gray-600 mb-2">Email</label>
                                <input type="email" id="email" class="w-full px-4 py-2 bg-white/50 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400" required>
                            </div>
                            <div class="mb-4">
                                <label for="password" class="block text-gray-600 mb-2">Password</label>
                                <input type="password" id="password" class="w-full px-4 py-2 bg-white/50 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400" required>
                            </div>
                            <div class="mb-6">
                                <label for="confirm-password" class="block text-gray-600 mb-2">Confirm Password</label>
                                <input type="password" id="confirm-password" class="w-full px-4 py-2 bg-white/50 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400" required>
                            </div>
                            <button type="submit" class="w-full kairos-btn kairos-btn-primary py-3 rounded-lg font-semibold ${state.isLoading ? 'opacity-75 cursor-not-allowed' : ''}" ${state.isLoading ? 'disabled' : ''}>
                                ${state.isLoading ? '<div class="loader inline-block mr-2" style="width:20px;height:20px;"></div>Creating Account...' : 'Create Account'}
                            </button>
                            ${state.authError ? `<p class="text-red-500 text-sm mt-4 text-center">${state.authError}</p>` : ''}
                        </form>
                        <p class="text-center mt-6">Already have a sanctuary? <a href="#" id="go-to-login" class="text-indigo-600 font-semibold hover:underline">Enter here</a></p>
                    </div>
                </div>
            `;
        }

        function DashboardPage() {
            const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
            const recentEntriesHtml = entries.slice(0, 3).map((entry, index) => `
                <div class="bg-white/80 p-5 rounded-lg shadow-sm hover:shadow-lg transition-all duration-300 hover:scale-105 view-entry-btn fade-in" style="animation-delay: ${0.5 + index * 0.1}s" data-id="${entry.id}">
                    <h3 class="font-semibold text-lg text-gray-800 truncate">${entry.title || 'Untitled Entry'}</h3>
                    <p class="text-sm text-gray-500">${new Date(entry.date).toLocaleDateString()}</p>
                    <p class="text-sm text-indigo-600 mt-2 font-medium">${entry.type || 'General'}</p>
                </div>
            `).join('');

            return `
                <div class="container mx-auto p-4 md:p-8 max-w-5xl">
                    <header class="text-center mb-12">
                        <div class="flex justify-between items-start mb-6">
                            <div></div>
                            <div class="text-center">
                                <h1 class="text-5xl font-bold text-gray-800 fade-in" style="animation-delay: 0.1s;">Your Sanctuary</h1>
                                <p class="text-xl text-gray-600 mt-3 fade-in" style="animation-delay: 0.2s;">Welcome back, ${state.currentUser.email}.</p>
                            </div>
                            <button id="logout-btn" class="kairos-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300">
                                <i class="fas fa-sign-out-alt mr-2"></i>Logout
                            </button>
                        </div>
                    </header>
                    <div class="flex flex-col sm:flex-row justify-center gap-6 mb-12 fade-in" style="animation-delay: 0.3s;">
                        <button id="start-new-entry-btn" class="kairos-btn action-btn kairos-btn-primary px-10 py-4 rounded-lg text-xl font-bold shadow-lg">
                            <i class="fas fa-pen-fancy mr-2"></i> New Entry
                        </button>
                        <button id="go-to-synthesis-btn" class="kairos-btn action-btn bg-white/80 border px-10 py-4 rounded-lg text-xl font-bold shadow-lg hover:bg-white">
                            <i class="fas fa-project-diagram mr-2"></i> Synthesis
                        </button>
                        <button id="go-to-advisor-btn" class="kairos-btn action-btn bg-white/80 border px-10 py-4 rounded-lg text-xl font-bold shadow-lg hover:bg-white">
                            <i class="fas fa-user-graduate mr-2"></i> Advisor
                        </button>
                    </div>
                    <div class="kairos-card p-6 rounded-xl shadow-lg text-center mb-12 fade-in" style="animation-delay: 0.4s;">
                         <p class="text-lg italic text-gray-700">"${randomQuote}"</p>
                    </div>
                    <div>
                        <h2 class="text-3xl font-bold mb-6 text-gray-700 fade-in" style="animation-delay: 0.5s;">Recent Reflections</h2>
                        <div class="grid md:grid-cols-3 gap-6">
                            ${entries.length > 0 ? recentEntriesHtml : '<p class="text-gray-500 col-span-3 text-center py-10 fade-in" style="animation-delay: 0.6s;">Your journal is a blank canvas. Begin a new entry to start your reflection.</p>'}
                        </div>
                    </div>
                </div>
            `;
        }

        function SynthesisPage() {
            const { score, ripples } = calculateEquanimity();
            const { isLoading, content, error } = state.synthesis;
            
            let themesHtml = '';
            if (isLoading) {
                themesHtml = `<div class="flex justify-center items-center p-6"><div class="loader"></div><p class="ml-4 text-gray-600">Synthesizing patterns...</p></div>`;
            } else if (error) {
                themesHtml = `<div class="text-center p-6 bg-red-50 border border-red-200 rounded-lg"><p class="text-red-600">${error}</p></div>`;
            } else if (content) {
                if (content.guidance) {
                     themesHtml = `<div class="text-center p-6 bg-blue-50 border border-blue-200 rounded-lg"><p class="text-blue-700">${content.guidance}</p></div>`;
                } else {
                    themesHtml = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h3 class="font-semibold text-lg mb-2 text-red-700"><i class="fas fa-magnet mr-2"></i>Aversion Themes</h3>
                                <ul class="list-disc list-inside text-gray-700 space-y-1">${content.aversionThemes.map(t => `<li>${t}</li>`).join('') || '<li>No strong aversion themes detected.</li>'}</ul>
                            </div>
                            <div>
                                <h3 class="font-semibold text-lg mb-2 text-green-700"><i class="fas fa-feather mr-2"></i>Craving Themes</h3>
                                <ul class="list-disc list-inside text-gray-700 space-y-1">${content.cravingThemes.map(t => `<li>${t}</li>`).join('') || '<li>No strong craving themes detected.</li>'}</ul>
                            </div>
                        </div>
                    `;
                }
            }

            return `
                <div class="container mx-auto p-4 md:p-8 max-w-5xl fade-in">
                    <header class="flex justify-between items-center mb-12">
                        <div>
                           <h1 class="text-5xl font-bold text-gray-800">Sankara Synthesis</h1>
                           <p class="text-xl text-gray-600 mt-3">Making the unconscious conscious.</p>
                        </div>
                        <button id="back-to-dashboard" class="kairos-btn bg-white/80 border px-6 py-3 rounded-lg font-semibold hover:bg-white"><i class="fas fa-arrow-left mr-2"></i>Dashboard</button>
                    </header>

                    <div class="grid lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1">
                            <div class="kairos-card p-6 rounded-xl shadow-lg text-center">
                                <h2 class="text-2xl font-bold mb-4">Equanimity Index</h2>
                                <div id="equanimity-pool" class="w-48 h-48 mx-auto rounded-full flex items-center justify-center overflow-hidden" style="background: radial-gradient(circle, #a5f3fc, #0c4a6e);">
                                    <div class="w-full h-full bg-black/20" style="backdrop-filter: blur(${ripples}px) brightness(1.2)"></div>
                                </div>
                                <p class="mt-4 text-lg font-semibold">${score}% Stillness</p>
                                <p class="text-sm text-gray-600">Reflects your capacity for non-reactive awareness in recent entries.</p>
                            </div>
                        </div>
                        <div class="lg:col-span-2">
                             <div class="kairos-card p-6 rounded-xl shadow-lg mb-8">
                                <h2 class="text-2xl font-bold mb-4">Aversion & Craving Patterns</h2>
                                ${themesHtml}
                            </div>
                            <div class="kairos-card p-6 rounded-xl shadow-lg">
                                <h2 class="text-2xl font-bold mb-4">Trigger Constellations</h2>
                                <p class="text-gray-600 mb-4">Select a recent entry to visualize its pattern.</p>
                                <div id="entry-selector-for-constellation" class="flex flex-col gap-2">
                                    ${entries.slice(0,5).map(entry => `<button class="constellation-btn text-left p-3 bg-gray-100 rounded-lg hover:bg-indigo-100" data-id="${entry.id}">${entry.title || 'Untitled Entry'}</button>`).join('')}
                                </div>
                                <div id="constellation-display" class="mt-6"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function AdvisorPage() {
            const { isLoading, content, error } = state.advisor;

            let advisorContentHtml = '';
            if (isLoading) {
                advisorContentHtml = `<div class="flex justify-center items-center p-10"><div class="loader"></div><p class="ml-4 text-gray-600">Your Advisor is reflecting...</p></div>`;
            } else if (error) {
                advisorContentHtml = `<div class="text-center p-10 bg-red-50 border border-red-200 rounded-lg"><p class="text-red-700 font-semibold">An error occurred.</p><p class="text-red-600 mt-2">${error}</p></div>`;
            } else if (content) {
                if (content.guidance) {
                    advisorContentHtml = `
                        <div class="kairos-card p-6 rounded-xl shadow-lg text-center">
                            <h2 class="text-2xl font-bold mb-4 text-indigo-800">A Path to Deeper Insight</h2>
                            <p class="text-lg text-gray-700">${content.guidance}</p>
                            <button id="start-guided-entry-btn" class="kairos-btn kairos-btn-primary mt-6 px-6 py-2 rounded-lg font-semibold">Begin a New Entry</button>
                        </div>
                    `;
                } else {
                    advisorContentHtml = `
                        <div class="space-y-8">
                            <!-- Compassionate Truth -->
                            <div class="kairos-card p-6 rounded-xl shadow-lg">
                                <h2 class="text-2xl font-bold mb-4 text-indigo-800">The Compassionate Truth</h2>
                                <p class="text-lg text-gray-700">${content.truth}</p>
                            </div>
                            <!-- Integration Plan -->
                            <div class="kairos-card p-6 rounded-xl shadow-lg">
                                <h2 class="text-2xl font-bold mb-4 text-indigo-800">The Integration Plan</h2>
                                <div class="grid md:grid-cols-2 gap-6">
                                    <div>
                                        <h3 class="font-semibold text-xl mb-2"><i class="fas fa-leaf mr-2 text-green-600"></i>Inner Work</h3>
                                        <p class="text-gray-700">${content.plan.inner}</p>
                                    </div>
                                    <div>
                                        <h3 class="font-semibold text-xl mb-2"><i class="fas fa-shoe-prints mr-2 text-yellow-600"></i>Outer Action</h3>
                                        <p class="text-gray-700">${content.plan.outer}</p>
                                    </div>
                                </div>
                            </div>
                            <!-- Evolutionary Challenge -->
                            <div class="kairos-card p-6 rounded-xl shadow-lg bg-gray-800 text-white">
                                <h2 class="text-2xl font-bold mb-4 text-yellow-400">The Evolutionary Challenge</h2>
                                <p class="text-lg">${content.challenge}</p>
                            </div>
                        </div>
                    `;
                }
            }

            return `
                <div class="container mx-auto p-4 md:p-8 max-w-4xl fade-in">
                     <header class="flex justify-between items-center mb-12">
                        <div>
                           <h1 class="text-5xl font-bold text-gray-800">Kairos Advisor</h1>
                           <p class="text-xl text-gray-600 mt-3">The integrated voice of your Higher Self.</p>
                        </div>
                        <button id="back-to-dashboard" class="kairos-btn bg-white/80 border px-6 py-3 rounded-lg font-semibold hover:bg-white"><i class="fas fa-arrow-left mr-2"></i>Dashboard</button>
                    </header>
                    ${advisorContentHtml}
                </div>
            `;
        }


        function SomaticCheckPage1() { 
            return `<div class="min-h-screen flex flex-col items-center justify-center text-center p-4 fade-in"><h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-4">Before we begin, let's connect with your body.</h1><p class="text-lg md:text-xl text-gray-600 mb-12 max-w-2xl">Right now, without needing to change anything, would you say your inner state feels more activated or more settled?</p><div class="grid md:grid-cols-2 gap-8 w-full max-w-4xl"><div class="somatic-option kairos-card p-8 rounded-xl shadow-lg" data-state="activated"><i class="fas fa-bolt text-5xl text-yellow-500 mb-4"></i><h2 class="text-2xl font-semibold mb-2">Activated</h2><p class="text-gray-600">Restless, tense, racing thoughts, energized.</p></div><div class="somatic-option kairos-card p-8 rounded-xl shadow-lg" data-state="settled"><i class="fas fa-feather-alt text-5xl text-blue-500 mb-4"></i><h2 class="text-2xl font-semibold mb-2">Settled</h2><p class="text-gray-600">Grounded, calm, relaxed, at ease.</p></div></div></div>`;
        }
        function SomaticCheckPage2() { 
            const prompt = state.somaticState === 'activated' ? "It's courageous to acknowledge that energy." : "It's a gift to find moments of peace.";
            return `<div class="min-h-screen flex flex-col items-center justify-center text-center p-4 fade-in"><p class="text-lg text-gray-600 mb-4">${prompt}</p><h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-12 max-w-3xl">What is your capacity to be with this state of ${state.somaticState}ness right now?</h1><div class="space-y-6 w-full max-w-2xl"><div class="somatic-option kairos-card p-6 rounded-xl shadow-lg text-left" data-capacity="deep"><h2 class="text-xl font-semibold">I have the space to explore this deeply.</h2></div><div class="somatic-option kairos-card p-6 rounded-xl shadow-lg text-left" data-capacity="gentle"><h2 class="text-xl font-semibold">I can be with it, but prefer gentle observation.</h2></div><div class="somatic-option kairos-card p-6 rounded-xl shadow-lg text-left" data-capacity="grounding"><h2 class="text-xl font-semibold">I feel overwhelmed and need to focus on grounding first.</h2></div></div></div>`;
        }
        function GroundingPage() { 
            return `<div class="min-h-screen flex flex-col items-center justify-center text-center p-4 fade-in"><h1 class="text-3xl font-bold mb-4">A wise choice. Let's ground ourselves.</h1><p class="text-lg text-gray-600 mb-8">Follow the rhythm. Breathe in as the circle expands, and out as it contracts.</p><div class="w-48 h-48 bg-blue-200 rounded-full flex items-center justify-center" style="animation: breathe 8s ease-in-out infinite;"><span id="breath-text" class="text-blue-800 font-semibold">Breathe In...</span></div><button id="continue-to-setup" class="kairos-btn bg-white/80 border mt-12 px-8 py-3 rounded-lg font-semibold hover:bg-white">Continue when ready</button><style>@keyframes breathe { 0% { transform: scale(0.8); } 50% { transform: scale(1.2); } 100% { transform: scale(0.8); } }</style></div>`;
        }
        function EntrySetupPage() { 
            return `<div class="container mx-auto p-4 md:p-8 max-w-3xl fade-in"><div class="kairos-card p-8 rounded-xl shadow-lg"><h1 class="text-3xl font-bold mb-2">Let's Begin</h1><p class="text-gray-600 mb-6">Start by capturing the essence of what's on your mind.</p><form id="entry-setup-form" class="space-y-4"><input type="text" name="title" placeholder="Give this entry a title (optional)" class="w-full text-2xl font-semibold border-0 border-b-2 border-gray-200 focus:ring-0 focus:border-indigo-400 p-1 bg-transparent"><textarea name="situation.description" class="w-full border-gray-300 rounded-md mt-4" rows="6" placeholder="Describe the situation, interaction, or internal state you want to explore..."></textarea><div class="flex justify-end pt-4"><button type="submit" class="kairos-btn kairos-btn-primary px-8 py-3 rounded-lg font-semibold">Continue</button></div></form></div></div>`;
        }
        function ThematicCheckPage() { 
            const optionsHtml = Object.entries(entrySections).map(([key, {title, icon}]) => `<div class="thematic-option kairos-card p-6 rounded-xl shadow-lg border-2 border-transparent" data-section="${key}"><i class="fas ${icon} text-3xl text-indigo-500 mb-3"></i><h2 class="text-xl font-semibold">${title}</h2></div>`).join('');
            return `<div class="container mx-auto p-4 md:p-8 max-w-4xl text-center fade-in"><h1 class="text-3xl font-bold mb-4">How would you like to explore this?</h1><p class="text-lg text-gray-600 mb-10">Select the layers of your experience that feel most alive right now.</p><div id="thematic-options" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 mb-10">${optionsHtml}</div><button id="start-reflection-btn" class="kairos-btn kairos-btn-primary px-12 py-4 rounded-lg text-xl font-bold shadow-lg opacity-50" disabled>Start Reflection</button></div>`;
        }
        function EntryFlowPage() { 
            const { steps, currentStepIndex } = state.entryBuilder.flow;
            const currentSectionKey = steps[currentStepIndex];
            const sectionDetails = entrySections[currentSectionKey];
            const progressPercentage = ((currentStepIndex + 1) / steps.length) * 100;
            const isLastStep = currentStepIndex === steps.length - 1;
            return `<div class="container mx-auto p-4 md:p-8 max-w-3xl fade-in"><div class="kairos-card p-8 rounded-xl shadow-lg"><div class="mb-6"><div class="flex justify-between items-center mb-2"><h2 class="text-2xl font-bold text-indigo-800">${sectionDetails.title}</h2><span class="text-sm font-semibold text-gray-500">Step ${currentStepIndex + 1} of ${steps.length}</span></div><div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-indigo-500 h-2.5 rounded-full" style="width: ${progressPercentage}%; transition: width 0.5s ease;"></div></div></div><div id="section-content">${renderSectionContent(currentSectionKey)}</div><div class="flex justify-between items-center mt-8 pt-4 border-t"><button id="flow-back-btn" class="kairos-btn bg-gray-200 px-6 py-2 rounded-lg font-semibold ${currentStepIndex === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${currentStepIndex === 0 ? 'disabled' : ''}>Back</button><button id="flow-next-btn" class="kairos-btn kairos-btn-primary px-8 py-3 rounded-lg font-semibold">${isLastStep ? 'Review & Save' : 'Next'}</button></div></div></div>`;
        }

        // --- SECTION CONTENT RENDERER (with AI features) ---
        function renderSectionContent(sectionKey) {
            const entry = state.entryBuilder;
            switch(sectionKey) {
                case 'dream': return `
                    <div class="space-y-6">
                        <div>
                            <label class="block font-semibold text-gray-700 mb-2">Describe the dream or synchronicity</label>
                            <textarea name="dream.description" class="w-full border-gray-300 rounded-md" rows="5" placeholder="What happened? What did you see, hear, or feel?">${entry.dream?.description || ''}</textarea>
                        </div>
                        <div>
                            <label class="block font-semibold text-gray-700 mb-2">Key Symbols or Themes</label>
                            <input type="text" name="dream.symbols" class="w-full border-gray-300 rounded-md" placeholder="e.g., water, flying, a recurring number" value="${entry.dream?.symbols || ''}">
                        </div>
                        <div class="text-center">
                            <button type="button" id="weave-insights-btn" class="kairos-btn kairos-btn-primary px-6 py-2 rounded-lg font-semibold">
                                ✨ Weave Insights
                            </button>
                        </div>
                        <div id="dream-insights-container" class="mt-4">${entry.dream?.insights ? `<div class="border-t pt-4 mt-4"><h3 class="font-semibold text-lg mb-2 text-indigo-800">The Subconscious Bridge</h3><div class="prose prose-sm max-w-none text-gray-700 bg-indigo-50 p-4 rounded-lg">${entry.dream.insights}</div></div>` : ''}</div>
                    </div>
                `;
                case 'inquiry': return `<div class="space-y-6"><div><label class="block font-semibold text-gray-700 mb-2">What is the primary story or judgment you are telling yourself about this?</label><textarea name="inquiry.story" class="w-full border-gray-300 rounded-md" rows="3" placeholder="e.g., 'They were intentionally trying to undermine me.'">${entry.inquiry?.story || ''}</textarea></div><div><label class="block font-semibold text-gray-700 mb-2">Beneath that story, what is the core emotion you feel?</label><textarea name="inquiry.emotion" class="w-full border-gray-300 rounded-md" rows="2" placeholder="e.g., 'I feel rejected.'">${entry.inquiry?.emotion || ''}</textarea></div><div><label class="block font-semibold text-gray-700 mb-2">And this entire pattern seems connected to a deeper belief. Does a thought like 'I am not safe' or 'I am not worthy' resonate here?</label><textarea name="inquiry.belief" class="w-full border-gray-300 rounded-md" rows="2" placeholder="e.g., 'I am not worthy of respect.'">${entry.inquiry?.belief || ''}</textarea></div></div>`;
                case 'cognitive': return `<textarea name="cognitive.thoughts" class="w-full border-gray-300 rounded-md" rows="4" placeholder="What thoughts went through your mind?">${entry.cognitive?.thoughts || ''}</textarea><textarea name="cognitive.beliefs" class="w-full border-gray-300 rounded-md mt-4" rows="3" placeholder="Did any deep beliefs surface? (e.g., 'I'm not good enough')">${entry.cognitive?.beliefs || ''}</textarea>`;
                case 'emotional': const emotions = ["Happy", "Sad", "Angry", "Fearful", "Surprised", "Disgusted", "Calm"]; return `<div id="emotion-chips" class="flex flex-wrap gap-2 mb-4">${emotions.map(e => `<button type="button" class="emotion-chip bg-gray-200 px-3 py-1 rounded-full text-sm" data-emotion="${e}">${e}</button>`).join('')}</div><div id="emotion-sliders" class="space-y-3"></div><textarea name="emotional.nuance" class="w-full border-gray-300 rounded-md mt-4" rows="2" placeholder="Describe any complex or mixed emotions...">${entry.emotional?.nuance || ''}</textarea>`;
                case 'physical': const bodyFront = `<path d="M100 20C75 20 60 40 60 60s-5 40 0 50c5 10 10 20 10 40v120c0 20-10 80-10 80h80c0 0-10-60-10-80V150c0-20 5-30 10-40 5-10 0-30 0-50S125 20 100 20z" />`; const bodyBack = `<path d="M100 20C75 20 60 40 60 60s-5 40 0 50c5 10 10 20 10 40v120c0 20-10 80-10 80h80c0 0-10-60-10-80V150c0-20 5-30 10-40 5-10 0-30 0-50S125 20 100 20z" />`; return `<div class="flex justify-center gap-4 mb-4"><button id="body-view-front" class="body-view-btn px-4 py-2 rounded-lg ${state.bodyMapView === 'front' ? 'bg-indigo-500 text-white' : 'bg-gray-200'}">Front View</button><button id="body-view-back" class="body-view-btn px-4 py-2 rounded-lg ${state.bodyMapView === 'back' ? 'bg-indigo-500 text-white' : 'bg-gray-200'}">Back View</button></div><p class="text-gray-600 mb-4 text-center">Click on the body map to log where you felt sensations.</p><div class="relative max-w-[200px] mx-auto"><svg id="body-map-svg" viewBox="0 0 200 400" xmlns="http://www.w3.org/2000/svg">${state.bodyMapView === 'front' ? bodyFront : bodyBack}</svg><div id="sensation-dots"></div></div><div id="logged-sensations" class="mt-4 space-y-2"></div>`;
                case 'behavioral': return `<textarea name="behavioral.actions" class="w-full border-gray-300 rounded-md" rows="3" placeholder="What did you do or say in response?">${entry.behavioral?.actions || ''}</textarea><textarea name="behavioral.urges" class="w-full border-gray-300 rounded-md mt-4" rows="2" placeholder="Did you feel strong urges that you didn't act on?">${entry.behavioral?.urges || ''}</textarea>`;
                case 'reflection': return `<textarea name="reflection.patterns" class="w-full border-gray-300 rounded-md" rows="3" placeholder="Does this feel familiar? Any patterns you've noticed?">${entry.reflection?.patterns || ''}</textarea><textarea name="reflection.pastConnections" class="w-full border-gray-300 rounded-md mt-4" rows="3" placeholder="Does this remind you of past situations or feelings?">${entry.reflection?.pastConnections || ''}</textarea>`;
                case 'integration': return `<textarea name="integration.insights" class="w-full border-gray-300 rounded-md" rows="3" placeholder="What insights came from reflecting on this experience?">${entry.integration?.insights || ''}</textarea><textarea name="integration.intentions" class="w-full border-gray-300 rounded-md mt-4" rows="3" placeholder="What is your intention moving forward?">${entry.integration?.intentions || ''}</textarea>`;
                case 'perspective': return `<div class="space-y-4"><p class="text-gray-600 mb-4">Sometimes, looking at an experience from a different angle can reveal new wisdom. Choose a lens to explore.</p><div class="perspective-lens border p-4 rounded-lg cursor-pointer hover:bg-gray-50" data-lens="child"><h3 class="font-semibold text-lg">The Inner Child Lens</h3><p class="text-sm text-gray-500">Connect with your younger self.</p></div><div class="perspective-lens border p-4 rounded-lg cursor-pointer hover:bg-gray-50" data-lens="future"><h3 class="font-semibold text-lg">The Future Self Lens</h3><p class="text-sm text-gray-500">Access the wisdom of who you are becoming.</p></div><div id="perspective-prompt-area" class="mt-4"></div></div>`;
                default: return `<p>Section not found.</p>`;
            }
        }
        
        function ViewEntryPage() { 
            const entry = state.currentEntry;
            if (!entry) return `<div class="text-center p-8"><p>Entry not found.</p><button id="back-to-dashboard" class="kairos-btn bg-gray-200 mt-4 px-6 py-2 rounded-lg">Back to Dashboard</button></div>`;
            const renderViewSection = (title, content, key) => {
                if (!content || Object.values(content).every(v => !v || (Array.isArray(v) && v.length === 0))) return '';
                let contentHtml;
                if (key === 'physical' && content.sensations && content.sensations.length > 0) { const bodyFront = `<path d="M100 20C75 20 60 40 60 60s-5 40 0 50c5 10 10 20 10 40v120c0 20-10 80-10 80h80c0 0-10-60-10-80V150c0-20 5-30 10-40 5-10 0-30 0-50S125 20 100 20z" />`; const bodyBack = `<path d="M100 20C75 20 60 40 60 60s-5 40 0 50c5 10 10 20 10 40v120c0 20-10 80-10 80h80c0 0-10-60-10-80V150c0-20 5-30 10-40 5-10 0-30 0-50S125 20 100 20z" />`; const frontDots = content.sensations.filter(s => s.view === 'front').map(s => `<div class="sensation-dot" style="left:${s.x}%; top:${s.y}%; width:${8+s.intensity}px; height:${8+s.intensity}px; background-color: hsla(0, 100%, 50%, ${s.intensity/10});"></div>`).join(''); const backDots = content.sensations.filter(s => s.view === 'back').map(s => `<div class="sensation-dot" style="left:${s.x}%; top:${s.y}%; width:${8+s.intensity}px; height:${8+s.intensity}px; background-color: hsla(0, 100%, 50%, ${s.intensity/10});"></div>`).join(''); contentHtml = `<div class="grid grid-cols-2 gap-4"><div><h4 class="font-semibold text-center mb-2">Front</h4><div class="relative max-w-[200px] mx-auto"><svg viewBox="0 0 200 400">${bodyFront}</svg><div class="absolute top-0 left-0 w-full h-full">${frontDots}</div></div></div><div><h4 class="font-semibold text-center mb-2">Back</h4><div class="relative max-w-[200px] mx-auto"><svg viewBox="0 0 200 400">${bodyBack}</svg><div class="absolute top-0 left-0 w-full h-full">${backDots}</div></div></div></div><div class="mt-4">${content.sensations.map(s => `<p><strong>${s.part} (${s.view}):</strong> ${s.quality} (Intensity: ${s.intensity})</p>`).join('')}</div>`; } else { contentHtml = Object.entries(content).map(([k, value]) => { if (!value || (Array.isArray(value) && value.length === 0)) return ''; let formattedValue; if (k === 'emotions' && Array.isArray(value)) { formattedValue = value.map(e => `${e.name} (Intensity: ${e.intensity})`).join('<br>'); } else if (Array.isArray(value)) { formattedValue = value.join(', '); } else { formattedValue = value.toString().replace(/\n/g, '<br>'); } const formattedKey = k.charAt(0).toUpperCase() + k.slice(1).replace(/([A-Z])/g, ' $1'); return `<div class="mb-3"><strong class="font-semibold text-gray-600 block">${formattedKey}</strong><p class="text-gray-800 mt-1">${formattedValue}</p></div>`; }).join(''); }
                if (!contentHtml.trim()) return '';
                return `<div class="mb-8"><h3 class="text-2xl font-bold border-b-2 border-indigo-200 pb-2 mb-4 text-indigo-800">${title}</h3><div class="prose max-w-none">${contentHtml}</div></div>`;
            };
            return `<div class="container mx-auto p-4 md:p-8 max-w-4xl fade-in"><div class="bg-white p-6 md:p-10 rounded-xl shadow-lg"><div class="flex justify-between items-start mb-6 border-b pb-6"><div><h1 class="text-4xl font-bold text-gray-800">${entry.title || 'Untitled Entry'}</h1><p class="text-gray-500 mt-2">${new Date(entry.date).toLocaleString()} | ${entry.type || 'General'}</p></div><div class="flex gap-2"><button id="delete-entry-btn" data-id="${entry.id}" class="kairos-btn bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600"><i class="fas fa-trash"></i></button></div></div>${renderViewSection('The Situation', entry.situation, 'situation')}${Object.keys(entrySections).map(key => renderViewSection(entrySections[key].title, entry[key], key)).join('')}<div class="mt-8 pt-6 border-t"><strong class="font-semibold text-gray-600 block mb-2">Tags:</strong><div class="flex flex-wrap gap-2">${entry.tags?.map(tag => `<span class="bg-indigo-100 text-indigo-800 text-sm font-medium px-3 py-1 rounded-full">${tag}</span>`).join('') || '<span class="text-gray-500">No tags</span>'}</div></div><button id="back-to-dashboard" class="kairos-btn bg-gray-200 text-gray-700 px-8 py-3 rounded-lg font-semibold mt-12"><i class="fas fa-arrow-left mr-2"></i>Back to Dashboard</button></div></div>`;
        }
        function ModalComponent({ title, content, onConfirm, confirmText = 'Confirm', cancelText = 'Cancel', bodyHtml = '' }) { 
             return `<div class="modal-overlay fade-in"><div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full"><h2 class="text-xl font-bold mb-4">${title}</h2><div class="text-gray-600 mb-6">${content || ''}${bodyHtml}</div><div class="flex justify-end gap-4"><button id="modal-cancel" class="kairos-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg">${cancelText}</button>${onConfirm ? `<button id="modal-confirm" class="kairos-btn kairos-btn-primary px-4 py-2 rounded-lg">${confirmText}</button>` : ''}</div></div></div>`;
        }

        // --- EVENT LISTENERS & LOGIC ---
        function attachEventListeners() {
            // New navigation
            document.getElementById('go-to-synthesis-btn')?.addEventListener('click', () => { state.currentPage = 'synthesis'; render(); });
            document.getElementById('go-to-advisor-btn')?.addEventListener('click', () => { state.currentPage = 'advisor'; render(); });
            document.getElementById('start-guided-entry-btn')?.addEventListener('click', () => { state.currentPage = 'somaticCheck1'; render(); });

            document.querySelectorAll('.constellation-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const entryId = parseInt(e.currentTarget.dataset.id);
                const entry = entries.find(en => en.id === entryId);
                document.getElementById('constellation-display').innerHTML = renderConstellation(entry);
            }));
            document.querySelectorAll('.body-view-btn').forEach(btn => btn.addEventListener('click', (e) => {
                state.bodyMapView = e.target.id === 'body-view-front' ? 'front' : 'back';
                document.getElementById('section-content').innerHTML = renderSectionContent('physical');
                updateSensationDots();
                attachEventListeners();
            }));
            document.getElementById('weave-insights-btn')?.addEventListener('click', handleWeaveInsights);

            // All previous event listeners...
            document.getElementById('go-to-register')?.addEventListener('click', (e) => { e.preventDefault(); state.currentPage = 'register'; render(); });
            document.getElementById('go-to-login')?.addEventListener('click', (e) => { e.preventDefault(); state.currentPage = 'login'; render(); });
            document.getElementById('start-new-entry-btn')?.addEventListener('click', () => { state.entryBuilder = { date: new Date().toISOString() }; state.currentPage = 'somaticCheck1'; render(); });
            document.getElementById('back-to-dashboard')?.addEventListener('click', () => { state.currentPage = 'dashboard'; render(); });
            document.getElementById('logout-btn')?.addEventListener('click', handleLogout);
            document.getElementById('continue-to-setup')?.addEventListener('click', () => { state.currentPage = 'entrySetup'; render(); });
            document.querySelectorAll('.somatic-option[data-state]').forEach(el => el.addEventListener('click', (e) => { state.somaticState = e.currentTarget.dataset.state; state.currentPage = 'somaticCheck2'; render(); }));
            document.querySelectorAll('.somatic-option[data-capacity]').forEach(el => el.addEventListener('click', (e) => { state.sessionCapacity = e.currentTarget.dataset.capacity; state.currentPage = state.sessionCapacity === 'grounding' ? 'grounding' : 'entrySetup'; render(); }));
            const breathText = document.getElementById('breath-text');
            if(breathText) { setInterval(() => { breathText.innerText = breathText.innerText === 'Breathe In...' ? 'Breathe Out...' : 'Breathe In...'; }, 4000); }
            document.getElementById('entry-setup-form')?.addEventListener('submit', (e) => { e.preventDefault(); const fd = new FormData(e.target); state.entryBuilder.title = fd.get('title'); state.entryBuilder.situation = { description: fd.get('situation.description') }; state.currentPage = 'thematicCheck'; render(); });
            const thematicOptions = document.querySelectorAll('.thematic-option');
            const startReflectionBtn = document.getElementById('start-reflection-btn');
            thematicOptions.forEach(el => { el.addEventListener('click', () => { el.classList.toggle('selected'); const selectedCount = document.querySelectorAll('.thematic-option.selected').length; startReflectionBtn.disabled = selectedCount === 0; startReflectionBtn.classList.toggle('opacity-50', selectedCount === 0); }); });
            startReflectionBtn?.addEventListener('click', () => { const selectedSections = Array.from(document.querySelectorAll('.thematic-option.selected')).map(el => el.dataset.section); state.entryBuilder.flow = { steps: selectedSections, currentStepIndex: 0 }; state.currentPage = 'entryFlow'; render(); });
            document.getElementById('flow-back-btn')?.addEventListener('click', handleFlowBack);
            document.getElementById('flow-next-btn')?.addEventListener('click', handleFlowNext);
            document.getElementById('login-form')?.addEventListener('submit', handleLogin);
            document.getElementById('register-form')?.addEventListener('submit', handleRegister);
            document.querySelectorAll('.view-entry-btn').forEach(btn => btn.addEventListener('click', handleViewEntry));
            document.getElementById('delete-entry-btn')?.addEventListener('click', handleDeleteEntry);
            document.getElementById('modal-cancel')?.addEventListener('click', hideModal);
            document.getElementById('modal-confirm')?.addEventListener('click', () => { if (state.modal.onConfirm) state.modal.onConfirm(); hideModal(); });
            document.querySelectorAll('.emotion-chip').forEach(chip => chip.addEventListener('click', (e) => { e.currentTarget.classList.toggle('selected'); updateEmotionSliders(); }));
            document.getElementById('body-map-svg')?.addEventListener('click', handleBodyMapClick);
            document.querySelectorAll('.perspective-lens').forEach(lens => lens.addEventListener('click', handlePerspectiveLensClick));
        }
        
        // --- HANDLER & UTILITY FUNCTIONS ---
        const { showToast, renderToast } = (() => {
            let toastTimeout;
            const showToast = (message, type = 'success') => {
                clearTimeout(toastTimeout);
                state.toast = { message, type, visible: true };
                renderToast();
                toastTimeout = setTimeout(() => {
                    state.toast.visible = false;
                    renderToast();
                }, 3000);
            };
            const renderToast = () => {
                let toastElement = document.getElementById('toast-notification');
                if (!toastElement && state.toast.visible) {
                    toastElement = document.createElement('div');
                    toastElement.id = 'toast-notification';
                    document.body.appendChild(toastElement);
                }
                if (toastElement) {
                    if (state.toast.visible) {
                        const bgColor = state.toast.type === 'success' ? 'bg-green-500' : 'bg-red-500';
                        toastElement.className = `fixed bottom-5 right-5 ${bgColor} text-white py-3 px-5 rounded-lg shadow-2xl transition-all duration-300 transform opacity-100 translate-y-0`;
                        toastElement.innerText = state.toast.message;
                    } else {
                        toastElement.className = toastElement.className.replace('opacity-100 translate-y-0', 'opacity-0 translate-y-5');
                    }
                }
            };
            return { showToast, renderToast };
        })();
        
        async function generateSynthesisInsights() {
            state.synthesis = { isLoading: true, content: null, error: null };

            if (entries.length < 2) {
                state.synthesis = { isLoading: false, content: { guidance: "Patterns begin to reveal themselves with more data. Create another entry, focusing on emotions and body sensations, to awaken deeper insights." }, error: null };
                return;
            }

            const recentEntriesSummary = entries.slice(0, 5).map(e => {
                return `Entry: "${e.title || 'Untitled'}"\n- Situation: ${e.situation?.description}\n- Emotions: ${e.emotional?.emotions?.map(em => em.name).join(', ')}`;
            }).join('\n\n');

            const prompt = `
                Analyze the following journal entries to identify core psychological themes.
                Your task is to identify themes of "aversion" (what the user is pushing away, resisting, or fearful of) and "craving" (what the user is attached to, desiring, or seeking).

                Entries:
                ---
                ${recentEntriesSummary}
                ---

                Based on this data, you MUST provide a response in a valid JSON format. The JSON object should contain two keys: "aversionThemes" and "cravingThemes".
                Each key should have a value of an array of strings. Each string should be a concise theme (2-5 words).
                Identify 2-4 themes for each category.

                Example response:
                {
                  "aversionThemes": ["Fear of being judged", "Resistance to change", "Feeling of inadequacy"],
                  "cravingThemes": ["Desire for peace and quiet", "Seeking validation from others", "Longing for connection"]
                }
                
                Do not include any text outside of the JSON object.
            `;
            
            try {
                const apiUrl = '/.netlify/functions/call-gemini';
                const payload = { prompt, structured: true };
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`Serverless function failed with status ${response.status}`);

                const parsedContent = await response.json();
                state.synthesis = { isLoading: false, content: parsedContent, error: null };

            } catch (error) {
                console.error("Gemini Synthesis call via Netlify failed:", error);
                state.synthesis = { isLoading: false, content: null, error: "Could not synthesize patterns at this time. Please try again later." };
            }
        }


        async function generateDynamicAdvisorContent() {
            state.advisor = { isLoading: true, content: null, error: null };
            
            if (entries.length === 0) {
                state.advisor = { isLoading: false, content: { guidance: "Your journey begins with a single step. The Advisor awakens once you've created your first journal entry. What's on your mind right now?" }, error: null };
                return;
            }

            if (entries.length < 2) {
                 state.advisor = { isLoading: false, content: { guidance: "A wonderful start. For the Advisor to see your patterns emerge, try to create another entry. The richest insights come from logging not just the situation, but also the emotions and body sensations you feel." }, error: null };
                return;
            }

            const recentEntriesSummary = entries.slice(0, 5).map(e => {
                return `Entry: "${e.title || 'Untitled'}"\n- Situation: ${e.situation?.description}\n- Narrative: ${e.inquiry?.story}\n- Emotions: ${e.emotional?.emotions?.map(em => `${em.name} (Intensity: ${em.intensity})`).join(', ')}\n- Sensations: ${e.physical?.sensations?.map(s => `${s.part}: ${s.quality}`).join(', ')}\n- Dream Insights: ${e.dream?.insights || 'N/A'}`;
            }).join('\n\n');

            const prompt = `
                You are the Kairos Advisor, the integrated voice of the user's Higher Self. Your purpose is to translate their journal entries into compassionate, actionable wisdom.

                Analyze the following summary of the user's recent journal entries:
                ---
                ${recentEntriesSummary}
                ---

                Based on this data, you MUST provide a response in a valid JSON format. The JSON object should contain three keys: "truth", "plan", and "challenge".

                1.  **truth**: "The Compassionate Truth". Write a loving but direct reflection of a core pattern you observe in the data. Ground it in their own words and experiences.
                2.  **plan**: "The Integration Plan". This must be an object with two keys:
                    * "inner": A concrete "Inner Work" step (e.g., a specific somatic practice, breathwork, or meditation).
                    * "outer": A concrete "Outer Action" step (e.g., a small, real-world behavior, a difficult conversation to have, or an action to take).
                3.  **challenge**: "The Evolutionary Challenge". Write a single, powerful, forward-looking question or a specific assignment designed to push the user to their next level of consciousness. You can frame this as moving from a "Shadow" frequency (like Fear) to a "Gift" frequency (like Courage).

                Do not include any text outside of the JSON object.
            `;

            try {
                const apiUrl = '/.netlify/functions/call-gemini';
                const payload = { prompt, structured: true };
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Serverless function failed with status ${response.status}`);
                }

                const parsedContent = await response.json();
                state.advisor = { isLoading: false, content: parsedContent, error: null };

            } catch (error) {
                console.error("Gemini Advisor call via Netlify failed:", error);
                state.advisor = { isLoading: false, content: null, error: "Could not retrieve wisdom from your Higher Self at this moment. Please try again later." };
            }
        }


        async function handleWeaveInsights() {
            const container = document.getElementById('dream-insights-container');
            const description = document.querySelector('textarea[name="dream.description"]').value;
            const symbols = document.querySelector('input[name="dream.symbols"]').value;

            if (!description.trim()) {
                showToast("Please describe the dream or synchronicity first.", "error");
                return;
            }

            container.innerHTML = `<div class="flex justify-center items-center p-4"><div class="loader"></div></div>`;

            const recentThemes = entries.slice(0, 2).map(e => e.situation.description).join('; ');

            const prompt = `
                As a Jungian-informed dream analyst, analyze the following dream/synchronicity.
                Description: "${description}"
                Key Symbols: "${symbols}"
                
                Also, consider these themes from the user's recent waking life journal entries for context: "${recentThemes}"

                Your tasks are:
                1. Identify potential archetypes or recurring symbols in the dream.
                2. Gently highlight any potential cross-referenced insights or connections between the dream symbols and the waking life themes.
                3. Frame your response as a compassionate, reflective prompt for deeper user inquiry, not as a definitive interpretation. Start with "Here are some threads that emerge...".
            `;
            
            try {
                const apiUrl = '/.netlify/functions/call-gemini';
                const payload = { prompt };
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Serverless function failed with status ${response.status}`);
                }

                const result = await response.json();
                const text = result.text.replace(/\n/g, '<br>');
                
                container.innerHTML = `
                    <div class="border-t pt-4 mt-4">
                        <h3 class="font-semibold text-lg mb-2 text-indigo-800">The Subconscious Bridge</h3>
                        <div class="prose prose-sm max-w-none text-gray-700 bg-indigo-50 p-4 rounded-lg">${text}</div>
                    </div>
                `;
                if(!state.entryBuilder.dream) state.entryBuilder.dream = {};
                state.entryBuilder.dream.insights = text;

            } catch (error) {
                console.error("Gemini Weave Insights call via Netlify failed:", error);
                container.innerHTML = `<p class="text-red-500 text-center">Sorry, we couldn't weave insights at this moment. Please try again later.</p>`;
            }
        }

        // --- Other handler functions ---
        function calculateEquanimity() { if (entries.length === 0) return { score: 100, ripples: 0 }; const totalIntensity = entries.reduce((sum, entry) => { const entryIntensity = entry.emotional?.emotions?.reduce((eSum, emo) => eSum + emo.intensity, 0) || 0; return sum + entryIntensity; }, 0); const avgIntensity = totalIntensity / entries.length / 5; const score = Math.max(0, Math.round(100 - avgIntensity * 10)); const ripples = Math.min(10, avgIntensity); return { score, ripples }; }
        function analyzeThemes() { const aversionKeywords = ['criticized', 'defensive', 'fear', 'angry', 'bill', 'avoid']; const cravingKeywords = ['peaceful', 'happy', 'calm', 'want', 'need']; let aversionThemes = new Set(); let cravingThemes = new Set(); entries.forEach(entry => { const text = `${entry.title || ''} ${entry.situation?.description || ''}`.toLowerCase(); aversionKeywords.forEach(kw => { if (text.includes(kw)) aversionThemes.add(kw); }); cravingKeywords.forEach(kw => { if (text.includes(kw)) cravingThemes.add(kw); }); }); return { aversionThemes: Array.from(aversionThemes), cravingThemes: Array.from(cravingKeywords) }; }
        function renderConstellation(entry) { if (!entry) return ''; const coreReaction = (entry.emotional?.emotions?.some(e => ['Angry', 'Fearful'].includes(e.name))) ? { type: 'Aversion', color: 'red-500' } : { type: 'Neutral/Craving', color: 'green-500' }; return `<div class="border-t pt-6 fade-in"><div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center items-center"><div class="p-4 bg-gray-50 rounded-lg"><h4 class="font-bold text-lg mb-2">Trigger</h4><i class="fas fa-bolt text-3xl text-yellow-500 mb-2"></i><p>${entry.situation?.description || 'N/A'}</p></div><i class="fas fa-arrow-right text-2xl text-gray-400 hidden md:block"></i><i class="fas fa-arrow-down text-2xl text-gray-400 md:hidden mx-auto"></i><div class="p-4 bg-gray-50 rounded-lg"><h4 class="font-bold text-lg mb-2">Core Reaction</h4><i class="fas ${coreReaction.type === 'Aversion' ? 'fa-hand-paper' : 'fa-hand-holding-heart'} text-3xl text-${coreReaction.color} mb-2"></i><p class="font-semibold text-${coreReaction.color}">${coreReaction.type}</p></div></div><div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center mt-4"><div class="p-4 bg-gray-50 rounded-lg"><h4 class="font-bold text-lg mb-2">Internal Narrative</h4><i class="fas fa-comment-dots text-3xl text-blue-500 mb-2"></i><p class="text-sm italic">"${entry.inquiry?.story || 'No narrative logged'}"</p></div><div class="p-4 bg-gray-50 rounded-lg"><h4 class="font-bold text-lg mb-2">Emotions</h4><i class="fas fa-heart-pulse text-3xl text-pink-500 mb-2"></i><p>${entry.emotional?.emotions?.map(e => `${e.name} (${e.intensity})`).join(', ') || 'N/A'}</p></div><div class="p-4 bg-gray-50 rounded-lg"><h4 class="font-bold text-lg mb-2">Somatic Signature</h4><i class="fas fa-child text-3xl text-orange-500 mb-2"></i><p>${entry.physical?.sensations?.map(s => `${s.part}: ${s.quality}`).join(', ') || 'N/A'}</p></div></div></div>`; }
        async function handleLogin(e) { 
            e.preventDefault(); 
            state.isLoading = true;
            state.authError = null;
            render();
            
            const email = e.target.elements.email.value;
            const password = e.target.elements.password.value;
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showToast("Welcome back to your sanctuary!", "success");
            } catch (error) {
                console.error('Login error:', error);
                state.authError = getAuthErrorMessage(error.code);
                showToast(state.authError, "error");
                state.isLoading = false;
                render();
            }
        }
        
        async function handleRegister(e) { 
            e.preventDefault(); 
            state.isLoading = true;
            state.authError = null;
            render();
            
            const email = e.target.elements.email.value;
            const password = e.target.elements.password.value;
            const confirmPassword = e.target.elements['confirm-password'].value;
            
            if (password !== confirmPassword) { 
                showToast("Passwords do not match.", "error"); 
                state.isLoading = false;
                render();
                return; 
            }
            
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showToast("Welcome to Kairos! Your journey begins now.", "success");
            } catch (error) {
                console.error('Registration error:', error);
                state.authError = getAuthErrorMessage(error.code);
                showToast(state.authError, "error");
                state.isLoading = false;
                render();
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                showToast('Signed out successfully', 'success');
            } catch (error) {
                console.error('Logout error:', error);
                showToast('Error signing out', 'error');
            }
        }

        function getAuthErrorMessage(errorCode) {
            switch (errorCode) {
                case 'auth/user-not-found':
                    return 'No account found with this email address.';
                case 'auth/wrong-password':
                    return 'Incorrect password. Please try again.';
                case 'auth/email-already-in-use':
                    return 'An account with this email already exists.';
                case 'auth/weak-password':
                    return 'Password should be at least 6 characters long.';
                case 'auth/invalid-email':
                    return 'Please enter a valid email address.';
                case 'auth/too-many-requests':
                    return 'Too many failed attempts. Please try again later.';
                default:
                    return 'An error occurred. Please try again.';
            }
        }
        function handleViewEntry(e) { const entryId = parseInt(e.currentTarget.dataset.id); state.currentEntry = entries.find(entry => entry.id === entryId); state.currentPage = 'viewEntry'; render(); }
        function handleDeleteEntry(e) { 
            const entryId = e.currentTarget.dataset.id; 
            showModal({ 
                title: 'Delete Entry', 
                content: 'Are you sure you want to permanently delete this journal entry?', 
                confirmText: 'Delete', 
                onConfirm: async () => { 
                    try {
                        // Delete via secure backend
                        await callFirebaseBackend('deleteEntry', { entryId });
                        
                        // Remove from local entries array
                        entries = entries.filter(entry => entry.id !== entryId); 
                        showToast('Entry deleted successfully.', 'success'); 
                        state.currentPage = 'dashboard'; 
                        render();
                    } catch (error) {
                        console.error('Error deleting entry:', error);
                        showToast('Failed to delete entry. Please try again.', 'error');
                    }
                } 
            }); 
        }
        function showModal(config) { state.modal = { ...config, visible: true }; render(); }
        function hideModal() { state.modal = { visible: false }; render(); }
        function saveCurrentStepData() { const { steps, currentStepIndex } = state.entryBuilder.flow; const sectionKey = steps[currentStepIndex]; const container = document.getElementById('section-content'); if (!container) return; state.entryBuilder[sectionKey] = state.entryBuilder[sectionKey] || {}; const inputs = container.querySelectorAll('textarea, input[type="radio"]:checked, input[type="text"]'); inputs.forEach(input => { const key = input.name.split('.')[1] || 'value'; state.entryBuilder[sectionKey][key] = input.value; }); if (sectionKey === 'emotional') { state.entryBuilder.emotional.emotions = Array.from(container.querySelectorAll('.emotion-chip.selected')).map(chip => { const name = chip.dataset.emotion; const slider = container.querySelector(`input[data-emotion-name="${name}"]`); return { name, intensity: slider ? parseInt(slider.value) : 5 }; }); } if (sectionKey === 'perspective') { const textarea = container.querySelector('textarea'); if (textarea) { state.entryBuilder.perspective[textarea.name] = textarea.value; } } }
        function handleFlowBack() { saveCurrentStepData(); state.entryBuilder.flow.currentStepIndex--; render(); }
        async function handleFlowNext() { 
            saveCurrentStepData(); 
            const { steps, currentStepIndex } = state.entryBuilder.flow; 
            if (currentStepIndex < steps.length - 1) { 
                state.entryBuilder.flow.currentStepIndex++; 
                render(); 
            } else { 
                // Save to Firebase via secure backend
                if (!state.currentUser) {
                    showToast('You must be logged in to save entries', 'error');
                    return;
                }
                
                try {
                    const finalEntry = { ...state.entryBuilder };
                    delete finalEntry.flow;
                    
                    // Call secure backend to create entry
                    const savedEntry = await callFirebaseBackend('createEntry', finalEntry);
                    
                    // Add to local entries array for immediate display
                    entries.unshift({
                        ...savedEntry,
                        date: new Date().toISOString()
                    });
                    
                    showToast('Entry saved successfully!', 'success'); 
                    state.currentPage = 'dashboard'; 
                    render();
                } catch (error) {
                    console.error('Error saving entry:', error);
                    showToast('Failed to save entry. Please try again.', 'error');
                }
            } 
        }
        function updateEmotionSliders() { const slidersContainer = document.getElementById('emotion-sliders'); if(!slidersContainer) return; slidersContainer.innerHTML = ''; const selectedChips = document.querySelectorAll('.emotion-chip.selected'); selectedChips.forEach(chip => { const emotionName = chip.dataset.emotion; const intensity = state.entryBuilder.emotional?.emotions?.find(e => e.name === emotionName)?.intensity || 5; const sliderHtml = `<div class="flex items-center gap-4 fade-in"><label class="w-24 text-gray-700">${emotionName}</label><input type="range" data-emotion-name="${emotionName}" min="1" max="10" value="${intensity}" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"><span class="font-semibold w-8 text-center text-indigo-600">${intensity}</span></div>`; slidersContainer.insertAdjacentHTML('beforeend', sliderHtml); }); slidersContainer.querySelectorAll('input[type="range"]').forEach(slider => { slider.addEventListener('input', (e) => { e.target.nextElementSibling.textContent = e.target.value; }); }); }
        function handleBodyMapClick(e) { const svg = document.getElementById('body-map-svg'); if (!svg) return; const rect = svg.getBoundingClientRect(); const x = ((e.clientX - rect.left) / rect.width) * 100; const y = ((e.clientY - rect.top) / rect.height) * 100; const partName = mapCoordsToPart(x, y); const sensationQualities = ["Tightness", "Vibration", "Heat", "Numbness", "Ache", "Tingling"]; const bodyHtml = `<div class="space-y-4"><div><label class="block font-semibold mb-2">Sensation Quality:</label><div id="sensation-quality-chips" class="flex flex-wrap gap-2">${sensationQualities.map(q => `<button class="sensation-chip bg-gray-200 px-3 py-1 rounded-full text-sm" data-quality="${q}">${q}</button>`).join('')}</div></div><div><label for="sensation-intensity" class="block font-semibold mb-2">Intensity:</label><input type="range" id="sensation-intensity" min="1" max="10" value="5" class="w-full"></div></div>`; showModal({ title: `Sensation in your ${partName}`, bodyHtml, confirmText: "Log Sensation", onConfirm: () => { const selectedQuality = document.querySelector('#sensation-quality-chips .selected')?.dataset.quality; const intensity = document.getElementById('sensation-intensity').value; if (!selectedQuality) { showToast("Please select a sensation quality.", "error"); return; } if (!state.entryBuilder.physical) state.entryBuilder.physical = {}; if (!state.entryBuilder.physical.sensations) state.entryBuilder.physical.sensations = []; state.entryBuilder.physical.sensations.push({ part: partName, quality: selectedQuality, intensity: parseInt(intensity), x, y, view: state.bodyMapView }); document.getElementById('section-content').innerHTML = renderSectionContent('physical'); updateSensationDots(); attachEventListeners(); } }); document.querySelectorAll('#sensation-quality-chips .sensation-chip').forEach(chip => { chip.addEventListener('click', (e) => { document.querySelectorAll('#sensation-quality-chips .sensation-chip').forEach(c => c.classList.remove('selected')); e.currentTarget.classList.add('selected'); }); }); }
        function updateSensationDots() { const dotsContainer = document.getElementById('sensation-dots'); if (!dotsContainer) return; dotsContainer.innerHTML = ''; const sensations = state.entryBuilder.physical?.sensations || []; sensations.filter(s => s.view === state.bodyMapView).forEach(s => { const dot = document.createElement('div'); dot.className = 'sensation-dot'; dot.style.left = `${s.x}%`; dot.style.top = `${s.y}%`; dot.style.width = `${8 + parseInt(s.intensity)}px`; dot.style.height = `${8 + parseInt(s.intensity)}px`; dot.style.backgroundColor = `hsla(0, 100%, 50%, ${s.intensity / 10})`; dotsContainer.appendChild(dot); }); }
        function mapCoordsToPart(x, y) { if (y < 25) return "Head"; if (y < 35) return "Neck/Throat"; if (y < 50 && x > 25 && x < 75) return "Chest"; if (y < 50) return "Shoulders/Arms"; if (y < 60) return "Stomach/Gut"; return "Legs"; }
        function handlePerspectiveLensClick(e) { const lensType = e.currentTarget.dataset.lens; const promptArea = document.getElementById('perspective-prompt-area'); let promptText = ''; const firstEmotion = state.entryBuilder.emotional?.emotions?.[0]?.name.toLowerCase() || 'that feeling'; if (lensType === 'child') { promptText = `Taking a moment to connect with your younger self... What does the part of you that felt ${firstEmotion} really need to hear right now?`; } else if (lensType === 'future') { promptText = `Imagine your wise, future self looking back at this moment with compassion. What insight or guidance would they offer you?`; } promptArea.innerHTML = `<div class="mt-4 border-t pt-4 fade-in"><p class="text-gray-600 italic mb-2">${promptText}</p><textarea name="${lensType}Perspective" class="w-full border-gray-300 rounded-md" rows="4" placeholder="Write your reflection here..."></textarea></div>`; }

        // --- INITIAL RENDER ---
        render();
    </script>
</body>
</html>
